if(typeof ASC==="undefined"){ASC={}}if(typeof ASC.CRM==="undefined"){ASC.CRM=(function(){return{}})()}ASC.CRM.ListCasesView=(function(a){Teamlab.bind(Teamlab.events.getException,d);function d(i,h){console.log("cases.js ",h);LoadingBanner.hideLoading()}var g=function(j,i){if(ASC.CRM.ListCasesView.cookieKey&&ASC.CRM.ListCasesView.cookieKey!=""){var h={page:j,countOnPage:i};jq.cookies.set(ASC.CRM.ListCasesView.cookieKey,h,{path:location.pathname})}};var b=function(){if(ASC.CRM.ListCasesView.isFirstTime==true){ASC.CRM.ListCasesView.isFirstTime=false;if(typeof(casesForFirstRequest)!="undefined"){casesForFirstRequest=jq.parseJSON(jQuery.base64.decode(casesForFirstRequest))}else{casesForFirstRequest=[]}ASC.CRM.ListCasesView.CallbackMethods.get_cases_by_filter({__startIndex:casesForFirstRequest.startIndex,__nextIndex:casesForFirstRequest.nextIndex,__total:casesForFirstRequest.total},Teamlab.create("crm-cases",null,casesForFirstRequest.response));return}g(0,casesPageNavigator.EntryCountOnPage);e(0)};var e=function(h){ASC.CRM.ListCasesView.casesList=new Array();LoadingBanner.displayLoading();c(h)};var c=function(i){var h=ASC.CRM.ListCasesView.getFilterSettings(i);Teamlab.getCrmCases({startIndex:i||0},{filter:h,success:ASC.CRM.ListCasesView.CallbackMethods.get_cases_by_filter})};var f=function(){var h=jq("#caseFilterContainer").is(":hidden")==false;if(ASC.CRM.ListCasesView.isFilterVisible==false&&h){ASC.CRM.ListCasesView.isFilterVisible=true;if(ASC.CRM.ListCasesView.advansedFilter){jq("#casesAdvansedFilter").advansedFilter("resize")}}};return{CallbackMethods:{get_cases_by_filter:function(k,i){ASC.CRM.ListCasesView.casesList=i;ASC.CRM.ListCasesView.Total=k.__total||0;var l=k.__startIndex||0;if(ASC.CRM.ListCasesView.Total===0){jq("#caseTable tbody tr").remove();jq("#caseList").hide();jq("#caseButtonsPanel").show();jq("#mainExportCsv").next("img").hide();jq("#mainExportCsv").hide();jq("#caseFilterContainer").show();f();jq("#emptyContentForCasesFilter").show();LoadingBanner.hideLoading();return false}jq("#totalCasesOnPage").text(ASC.CRM.ListCasesView.Total);jq("#emptyContentForCasesFilter").hide();jq("#caseButtonsPanel").show();jq("#mainExportCsv").next("img").show();jq("#mainExportCsv").show();jq("#caseFilterContainer").show();f();jq("#caseList").show();jq("#caseTable tbody").replaceWith(jq("#caseListTmpl").tmpl({cases:ASC.CRM.ListCasesView.casesList}));var m;if(l>=ASC.CRM.ListCasesView.Total){m=l+1}else{m=ASC.CRM.ListCasesView.Total}casesPageNavigator.drawPageNavigator((l/ASC.CRM.ListCasesView.entryCountOnPage).toFixed(0)*1+1,m);jq("#tableForCasesNavigation").show();jq("#simpleCasesPageNavigator").html("");var h=jq("<div></div>");var j=0;if(jq("#divForCasesPager .pagerPrevButtonCSSClass").length!=0){j++;jq("#divForCasesPager .pagerPrevButtonCSSClass").clone().appendTo(h)}if(jq("#divForCasesPager .pagerNextButtonCSSClass").length!=0){j++;if(j===2){jq("<span style='padding: 0 8px;'>&nbsp;</span>").clone().appendTo(h)}jq("#divForCasesPager .pagerNextButtonCSSClass").clone().appendTo(h)}if(h.children().length!=0){h.appendTo("#simpleCasesPageNavigator");jq("#simpleCasesPageNavigator").show()}else{jq("#simpleCasesPageNavigator").hide()}window.scrollTo(0,0);LoadingBanner.hideLoading()}},init:function(l,k,i,h){ASC.CRM.ListCasesView.entryCountOnPage=l;ASC.CRM.ListCasesView.currentPageNumber=k;ASC.CRM.ListCasesView.cookieKey=i;ASC.CRM.ListCasesView.isFilterVisible=false;var j=location.hash;j=j&&typeof j==="string"&&j.charAt(0)==="#"?j.substring(1):j;if(j==""||decodeURIComponent(h)==j){ASC.CRM.ListCasesView.isFirstTime=true}else{ASC.CRM.ListCasesView.isFirstTime=false}ASC.CRM.ListCasesView.casesList=new Array();casesPageNavigator.NavigatorParent="#divForCasesPager";casesPageNavigator.changePageCallback=function(m){ASC.CRM.ListCasesView.currentPageNumber=m;g(m,casesPageNavigator.EntryCountOnPage);var n=casesPageNavigator.EntryCountOnPage*(m-1);e(n)}},setFilter:function(i,h,j,k,l){b()},resetFilter:function(i,h,j,k){b()},getFilterSettings:function(j){j=j||0;var i={startIndex:j,count:ASC.CRM.ListCasesView.entryCountOnPage};if(!ASC.CRM.ListCasesView.advansedFilter){return i}var h=ASC.CRM.ListCasesView.advansedFilter.advansedFilter();jq(h).each(function(k,l){switch(l.id){case"sorter":i.sortBy=l.params.id;i.sortOrder=l.params.dsc==true?"descending":"ascending";break;case"text":i.filterValue=l.params.value;break;default:if(l.hasOwnProperty("apiparamname")&&l.params.hasOwnProperty("value")&&l.params.value!=null){i[l.apiparamname]=l.params.value}break}});return i},exportToCsv:function(){var j=window.location.href.indexOf("#");var i=j>=0?window.location.href.substr(0,j):window.location.href;var h=j>=0?window.location.href.substr(j,window.location.href.length):"";jq("#exportDialog").hide();window.location.href=i+"?action=export"+h},openExportFile:function(){var i=window.location.href.indexOf("#");var h=i>=0?window.location.href.substr(0,i):window.location.href;jq("#exportDialog").hide();window.open(h+"?action=export&view=editor")},showExportDialog:function(){jq.dropdownToggle().toggle("#mainExportCsv","exportDialog",7,-20)},changeCountOfRows:function(i){if(isNaN(i)){return}var h=i*1;ASC.CRM.ListCasesView.entryCountOnPage=h;casesPageNavigator.EntryCountOnPage=h;g(1,h);e(0)}}})(jQuery);ASC.CRM.CasesActionView=(function(a){return{init:function(b){ASC.CRM.Common.renderCustomFields(casesEditCustomFieldList,"custom_field_","casesEditCustomFieldTmpl","#crm_caseMakerDialog dl");jq("#crm_caseMakerDialog dl .headerExpand").click();jq("input.textEditCalendar").mask(b);jq("input.textEditCalendar").datepicker({popupContainer:"body",selectDefaultDate:true,showAnim:""});if(casesContactSelector.SelectedContacts.length==0){jq("#selector_"+casesContactSelector.ObjName).children("div:first").children("div[id^='item_']").remove();jq("#membersCasesSelectorsContainer").prev("dt").addClass("crm-withGrayPlus")}jq(window).bind("deleteContactFromSelector",function(d,c,e){if(jq("#selector_"+casesContactSelector.ObjName).children("div:first").children("div[id^='item_']").length==1){jq("#membersCasesSelectorsContainer").prev("dt").addClass("crm-withGrayPlus")}});jq("#crm_caseMakerDialog dl .crm-withGrayPlus").live("click",function(d){var c="membersCasesSelectorsContainer";casesContactSelector.AddNewSelector(jq(this));jq(this).removeClass("crm-withGrayPlus")})},submitForm:function(){var e=jq("#crm_caseMakerDialog #caseTitle").val().trim();if(e==""){AddRequiredErrorText(jq("#crm_caseMakerDialog #caseTitle"),CRMJSResources.ErrorEmptyCaseTitle);ShowRequiredError(jq("#crm_caseMakerDialog #caseTitle"));return false}jq("#crm_caseMakerDialog .action_block").hide();jq("#crm_caseMakerDialog .ajax_info_block").show();jq("#membersCasesSelectorsContainer input[name=memberID]").val(casesContactSelector.SelectedContacts.join(","));if(!jq("#isPrivate").is(":checked")){SelectedUsers.IDs=new Array();jq("#notifyPrivate").removeAttr("checked")}jq("#isPrivateCase").val(jq("#isPrivate").is(":checked"));jq("#notifyPrivateUsers").val(jq("#cbxNotify").is(":checked"));jq("#selectedUsersCase").val(SelectedUsers.IDs.join(","));var b=jq("#crm_caseMakerDialog input[type='checkbox'][id^='custom_field_']");if(b){for(var c=0;c<b.length;c++){if(jq(b[c]).is(":checked")){var d=b[c].id.replace("custom_field_","");jq("#crm_caseMakerDialog input[name='customField_"+d+"']").val(jq(b[c]).is(":checked"))}}}return true},gotoAddCustomFieldPage:function(){if(confirm(CRMJSResources.ConfirmGoToCustomFieldPage)){document.location="settings.aspx?type=custom_field&view=case"}}}})(jQuery);ASC.CRM.CasesDetailsView=(function(a){return{init:function(){for(var c=0;c<casesCustomFieldList.length;c++){var b=casesCustomFieldList[c];if(jQuery.trim(b.mask)==""){continue}b.mask=jq.evalJSON(b.mask)}jq("#casesCustomFieldsListTmpl").tmpl(casesCustomFieldList).appendTo("#casesCustomFieldsList");jq("#casesCustomFieldsList dt.headerBase").each(function(d){var e=jq(this);if(e.next().nextUntil("dt.headerBase").length==0){e.next().remove();e.remove();return}jq(this).click()})},changeCaseStatus:function(c){var b=jq.getURLParam("id")*1;AjaxPro.onLoading=function(d){};AjaxPro.CasesDetailsView.ChangeCaseStatus(c,b,function(d){if(d.error!=null){alert(d.error.Message);return}jq("#caseStatusSwitcher").text(d.value);if(c==1){jq("#closeCase").hide();jq("#openCase").show()}else{jq("#openCase").hide();jq("#closeCase").show()}})},removeMemberFromCase:function(b){Teamlab.removeCrmEntityMember({contactID:b},entityData.type,entityData.id,b,{before:function(c){jq("#trashImg_"+c.contactID).hide();jq("#loaderImg_"+c.contactID).show()},after:function(d){var c=jq.inArray(d.contactID,casesContactSelector.SelectedContacts);casesContactSelector.SelectedContacts.splice(c,1);jq("#contactItem_"+d.contactID).animate({opacity:"hide"},500);ASC.CRM.HistoryView.removeOptionFromContact(d.contactID);setTimeout(function(){jq("#contactItem_"+d.contactID).remove();if(casesContactSelector.SelectedContacts.length==0){jq("#addCaseParticipantButton").hide();jq("#caseParticipantPanel").hide();jq("#emptyCaseParticipantPanel").show()}},500)}})},addMemberToCase:function(c){if(jq("#contactItem_"+c.id).length>0){return false}var b={contactid:c.id,caseid:entityData.id};Teamlab.addCrmEntityMember({},entityData.type,entityData.id,c.id,b,{success:function(e,d){jq("#simpleContactTmpl").tmpl(d).prependTo("#contactTable tbody");ASC.CRM.Common.RegisterContactInfoCard();casesContactSelector.SelectedContacts.push(d.id);ASC.CRM.HistoryView.appendOptionToContact({value:d.id,title:d.displayName})}})}}})(jQuery);jq.browser.safari=(jq.browser.safari&&!/chrome/.test(navigator.userAgent.toLowerCase()))==!0;jQuery.extend({format:function jQuery_dotnet_string_format(a){if(arguments.length<=1){return a}var c=arguments.length-2;for(var b=0;b<=c;++b){a=a.replace(new RegExp("\\{"+b+"\\}","gi"),arguments[b+1])}return a}});if(typeof ASC==="undefined"){ASC={}}if(typeof ASC.CRM==="undefined"){ASC.CRM=(function(){return{}})()}jQuery.extend({forceNumericOnly:function(){return this.each(function(){jq(this).keydown(function(a){var b=a.charCode||a.keyCode||0;return(b==8||b==9||b==46||(b>=37&&b<=40)||(b>=48&&b<=57)||(b>=96&&b<=105))})})},forcePhoneSymbolsOnly:function(a){jq(a).each(function(){jq(this).keypress(function(d){var e=jq(this).val().indexOf("+");var b=jq(this).caret().begin;var c=[8,9];var f=c.join(",").match(new RegExp(d.which));if(!d.which||(48<=d.which&&d.which<=57)||f||(d.which==43&&b==0&&e==-1)||(d.which==32&&b!=0)||d.which==45||d.which==40||d.which==41){return}else{d.preventDefault()}})})},forceIntegerOnly:function(b,a){jq(b).each(function(){jq(this).keypress(function(d){var c=[8,9];var e=c.join(",").match(new RegExp(d.which));if(!d.which||(48<=d.which&&d.which<=57)||e){return}else{d.preventDefault()}});jq(this).unbind("paste").bind("paste",function(d){var f=this.value;var c=this;setTimeout(function(){var e=jq(c).val();if(isNaN(e)||e.indexOf(".")!=-1){jq(c).val(f)}else{if(typeof(a)!="undefined"){a()}}},0);return true})})},getURLParam:function(h){h=h.toLowerCase();var j="";var g=window.location.href.toLowerCase();var c=false;var e=h+"=";var d=e.length;if(g.indexOf("?")>-1){var i=g.substr(g.indexOf("?")+1);var b=i.split("&");for(var f=0;f<b.length;f++){if(b[f].substr(0,d)==e){var a=b[f].split("=");j=a[1];c=true;break}}}if(c==false){return null}if(j.indexOf("#")>-1){return j.split("#")[0]}return j}});ASC.CRM.Common=(function(){return{blockUI:function(c,f,b,d){try{f=parseInt(f||0);b=parseInt(b||0);left=parseInt(-f/2);d=parseInt(d||-b/2);jq.blockUI({message:jq(c),css:{left:"50%",top:"50%",opacity:"1",border:"none",padding:"0px",width:f>0?f+"px":"auto",height:b>0?b+"px":"auto",cursor:"default",textAlign:"left",position:"fixed","margin-left":left+"px","margin-top":d+"px","background-color":"Transparent"},overlayCSS:{backgroundColor:"#aaaaaa",cursor:"default",opacity:"0.3"},focusInput:true,baseZ:666,fadeIn:0,fadeOut:0,onBlock:function(){var e=jq(c).parents("div.blockUI:first"),g=e.removeClass("blockMsg").addClass("blockDialog").get(0),h="";if(jq.browser.msie&&jq.browser.version<9&&e.length!==0){var j=" ",h=j+g.style.cssText,k=h.toLowerCase().indexOf(j+"filter:"),i=h.indexOf(";",k);if(k!==-1){if(i!==-1){g.style.cssText=[h.substring(j.length,k),h.substring(i+1)].join("")}else{g.style.cssText=h.substring(j.length,k)}}}}})}catch(a){}},toogleAjaxInfoBlock:function(a){},tooltip:function(f,d,c){overTaskDescrPanel=false;var a=function(i){setTimeout(function(){if(!overTaskDescrPanel){i.hide(100)}},200)};if(typeof(c)!="undefined"&&jq(f).length==1){var b=jq.trim(jq(f).attr("id")).split("_")[1];var g=jq.trim(jq(f).attr("title"));var e=ASC.CRM.Common.getTooltipParams(jq(f));if(g==""&&e==""){return}if(!c){jq("#"+d+b).remove()}jq("body").append("<div class='dropDownDialog tooltip' style='display: none;' id='"+d+b+"'>                                            <div class='dropDownCorner'></div>"+Encoder.htmlEncode(g).replace(/&#10;/g,"<br/>")+e+"</div>");var h=jq("#"+d+b);jq(f).removeAttr("title").mouseenter(function(){overTaskDescrPanel=true;var i=jq(f).position().left+5;var j=jq(f).position().top+jq(f).height()+5;jq(h).css("top",j).css("left",i);jq("div[id^='"+d+"']:not(div[id='"+d+b+"'])").hide();h.fadeIn(300)}).mouseleave(function(){overTaskDescrPanel=false;a(h)});jq(h).mouseenter(function(){overTaskDescrPanel=true}).mouseleave(function(){overTaskDescrPanel=false;a(h)});return false}jq(f).each(function(){var i=jq.trim(jq(this).attr("id")).split("_")[1];var l=jq.trim(jq(this).attr("title"));var k=ASC.CRM.Common.getTooltipParams(jq(this));if(l==""&&k==""){return}jq("body").append("<div style='display:none;' class='dropDownDialog tooltip' id='"+d+i+"'>                                        <div class='dropDownCorner'></div>"+Encoder.htmlEncode(l).replace(/&#10;/g,"<br/>")+k+"</div>");var j=jq("#"+d+i);jq(this).removeAttr("title").mouseenter(function(){overTaskDescrPanel=true;var m=jq(this).position().left+5;var n=jq(this).position().top+jq(this).height()+5;jq(j).css("top",n).css("left",m);jq("div[id^='"+d+"']:not(div[id='"+d+i+"'])").hide();j.fadeIn(300)}).mouseleave(function(){overTaskDescrPanel=false;a(j)});jq(j).mouseenter(function(){overTaskDescrPanel=true}).mouseleave(function(){overTaskDescrPanel=false;a(j)})})},getTooltipParams:function(b){var c="";var a=jq.trim(jq(b).attr("ttl_label"));var d=jq.trim(jq(b).attr("ttl_value"));if(a!=""&&d!=""){c+="<div style='overflow: hidden;'><div class='param'>"+Encoder.htmlEncode(a).replace(/&#10;/g,"<br/>")+":</div><div class='value'>"+Encoder.htmlEncode(d).replace(/&#10;/g,"<br/>")+"</div></div>"}jq(b).removeAttr("ttl_label");jq(b).removeAttr("ttl_value");a=jq.trim(jq(b).attr("dscr_label"));d=jq.trim(jq(b).attr("dscr_value"));if(a!=""&&d!=""){c+="<div style='overflow: hidden;'><div class='param'>"+Encoder.htmlEncode(a).replace(/&#10;/g,"<br/>")+":</div><div class='value'>"+Encoder.htmlEncode(d).replace(/&#10;/g,"<br/>")+"</div></div>"}jq(b).removeAttr("dscr_label");jq(b).removeAttr("dscr_value");a=jq.trim(jq(b).attr("resp_label"));d=jq.trim(jq(b).attr("resp_value"));if(a!=""&&d!=""){c+="<div style='overflow: hidden;'><div class='param'>"+Encoder.htmlEncode(a).replace(/&#10;/g,"<br/>")+":</div><div class='value'>"+Encoder.htmlEncode(d).replace(/&#10;/g,"<br/>")+"</div></div>"}jq(b).removeAttr("resp_label");jq(b).removeAttr("resp_value");return c},setRowColorElements:function(b){b.removeClass("tintMedium tintLight");for(var a=0;a<b.length;a++){if(a%2==0){jq(b[a]).addClass("tintMedium")}else{jq(b[a]).addClass("tintLight")}}},changeImage:function(c,b,a){jq(c).each(function(d){jq(this).mouseover(function(){jq(this).attr("src",b)}).mousemove(function(e){}).mouseout(function(){jq(this).attr("src",a)})})},RegisterContactInfoCard:function(){var a=new PopupBox("popup_ContactInfoCard",320,140,"tintLight","borderBase","AjaxPro.AjaxProHelper.GetContactInfoCard");jq(window).bind("registerContactInfoCard",function(b,d){var c=d.attr("id");if(c!=null&&c!=""){a.RegistryElement(c,'"'+d.attr("data-id")+'"')}});jq(".crm-companyInfoCardLink, .crm-peopleInfoCardLink").each(function(b){jq(window).trigger("registerContactInfoCard",[jq(this)])})},isHiddenForScroll:function(a){var b=a.position();var d=jq(window).scrollTop();var c=jq(window).scrollLeft();if(b.top>d&&b.left>c&&b.top+a.height()<d+jq(window).height()&&b.left+a.width()<c+jq(window).width()){return false}return true},renderCustomFields:function(b,a,d,c){var h=[];for(var f=0;f<b.length;f++){var e=b[f];if(jQuery.trim(e.mask)==""){continue}e.mask=jq.evalJSON(e.mask);if(b[f].fieldType==2){h.push(b[f])}}jq("#"+d).tmpl(b).appendTo(c);for(var g=0;g<h.length;g++){jq("#"+a+h[g].id).val(h[g].value)}},changeCountInTab:function(a,f){var b;if(typeof(f)!="undefined"&&f!=""){if(jq("li.viewSwitcherTab_"+f).length==0){return false}b=jq("li.viewSwitcherTab_"+f)}else{if(jq("li[id$=_ViewSwitcherTab].viewSwitcherTabSelected").length==0){return false}b=jq("li[id$=_ViewSwitcherTab].viewSwitcherTabSelected")[0]}var c=jq(b).text().split(" ");if(typeof(a)=="string"){if(a=="add"){if(c.length>1){var e=parseInt(c[c.length-1].replace("(","").replace(")",""))+1;c[c.length-1]=jq.format("({0})",e);jq(b).text(c.join(" "))}else{jq(b).text(jq.format("{0} (1)",c[0]))}}else{if(a=="delete"){var e=parseInt(c[c.length-1].replace("(","").replace(")",""))-1;if(e>0){c[c.length-1]=jq.format("({0})",e);jq(b).text(c.join(" "))}else{jq(b).text(c[0])}}}}else{if(typeof(a)=="number"){var d=parseInt(a);if(d>0){jq(b).text(jq.format("{0} ({1})",c[0],d))}else{jq(b).text(c[0])}}}},getHexRGBColor:function(b){b=b.replace(/\s/g,"");var a=b.match(/^rgb\((\d{1,3}[%]?),(\d{1,3}[%]?),(\d{1,3}[%]?)\)$/i);if(a){b="#";for(var c=1;c<=3;c++){b+=Math.round((a[c][a[c].length-1]=="%"?2.55:1)*parseInt(a[c])).toString(16).replace(/^(.)$/,"0$1")}}else{b=b.replace(/^#?([\da-f])([\da-f])([\da-f])$/i,"$1$1$2$2$3$3")}return b},ClientTimeToServer:function(a,j){var c=new Date();var i=c.getTimezoneOffset();if(j!=undefined){i=(-1)*j}c.setTime(a.getTime()+(i*60*1000));var f=(c.getMonth()+1);var b=c.getDate();var e=c.getHours();var g=c.getMinutes();var k=c.getFullYear()+"-"+(f>9?f:("0"+f))+"-"+(b>9?b:("0"+b))+"T"+(e>9?e:("0"+e))+"-"+(g>9?g:("0"+g))+"-00.000Z";return k},stickMenuToTheTop:function(e){if(typeof(e)!="object"||typeof(e.menuSelector)=="undefined"||typeof(e.menuAnchorSelector)=="undefined"||typeof(e.menuSpacerSelector)=="undefined"){return}var b=jq(e.menuSelector);var a=jq(e.menuAnchorSelector);var c=jq(e.menuSpacerSelector);if(b.length==0||a.length==0||c.length==0){return}var d=a.offset().top+a.outerHeight();var g=jq(window).scrollTop();var f=0;if(c.css("display")=="none"){f+=b.offset().top}else{f+=c.offset().top}if(g>=f){c.show();b.addClass("fixed");jq("#files_selectorPanel").css({position:"fixed",top:d-g});if(typeof(e.userFuncNotInTop)=="function"){e.userFuncNotInTop()}if(jq.browser.mobile){b.css({top:jq(document).scrollTop()+"px",position:"absolute"})}}else{c.hide();b.removeClass("fixed");jq("#files_selectorPanel").css({position:"absolute",top:d});if(typeof(e.userFuncInTop)=="function"){e.userFuncInTop()}if(jq.browser.mobile){b.css({position:"static"})}}},animateElement:function(b){if(typeof(b)!="object"){return}var a=b.element;if(ASC.CRM.Common.isHiddenForScroll(a)){jq.scrollTo(a);if(typeof(b.whenScrollFunc)==="function"){b.whenScrollFunc()}}if(typeof(b.afterScrollFunc)==="function"){b.afterScrollFunc()}a.css({"background-color":"#ffffcc"});a.animate({backgroundColor:"#ffffff"},2000,function(){a.css({"background-color":""})})}}})();ASC.CRM.HistoryView=(function(a){Teamlab.bind(Teamlab.events.getException,i);function i(k,j){console.log("common.js ",j);LoadingBanner.hideLoading()}var h=function(l,r){l.children('option[value="-2"]').siblings().remove();var m=[];for(var o=0,q=r.length;o<q;o++){m.push('<option value="'+r[o].id+'">'+o+"</option>")}l.append(m.join(""));var p=0,j=null,k=l.children('option[value="-2"]').siblings(),s=k.length;while(s--){j=jq(k[s]);p=j.text();p=isFinite(+p)?+p:-1;if(p>-1&&p<r.length){j.text(Encoder.htmlDecode(r[p].title))}else{j.remove()}}return l};var f=function(){if(ASC.CRM.HistoryView.isFirstTime==true){ASC.CRM.HistoryView.isFirstTime=false;return}LoadingBanner.displayLoading();ASC.CRM.HistoryView.ShowMore=true;d(0)};var b=function(){if(!ASC.CRM.HistoryView.ShowMore){return false}ASC.CRM.HistoryView.EventsList={};jq("#showMoreEventsButtons .crm-showMoreLink").hide();jq("#showMoreEventsButtons .crm-loadingLink").show();var j=jq("#eventsTable tr").length;d(j)};var d=function(k){var j={};j=ASC.CRM.HistoryView.getFilterSettings();j.entityid=ASC.CRM.HistoryView.ContactID!=0?ASC.CRM.HistoryView.ContactID:ASC.CRM.HistoryView.EntityID;j.entitytype=ASC.CRM.ListTaskView.EntityType;j.Count=ASC.CRM.HistoryView.CountOfRows;j.startIndex=k;Teamlab.getCrmHistoryEvents({startIndex:k||0},{filter:j,success:ASC.CRM.HistoryView.CallbackMethods.get_events_by_filter})};var e=function(){var m=jq.trim(jq("#historyBlock textarea").val());var j,l,k;var n={content:m,categoryId:eventCategorySelector.CategoryID};if(ASC.CRM.HistoryView.ContactID!=0){n.contactID=ASC.CRM.HistoryView.ContactID;if(jq("#itemID").val()!=""&&parseInt(jq("#itemID").val())>0&&jq("#typeID").val()!=""){n.entityId=jq("#itemID").val();n.entityType=jq("#typeID").val()}}else{if(jq("#contactID").val()!=0){n.contactID=jq("#contactID").val()}n.entityId=ASC.CRM.HistoryView.EntityID;n.entityType=ASC.CRM.HistoryView.EntityType}if(jq.trim(jq("#historyBlock .textEditCalendar").val())!=""){n.created=jq("#historyBlock .textEditCalendar").datepicker("getDate");var o=new Date();n.created.setHours(o.getHours(),o.getMinutes(),o.getSeconds())}else{n.created=new Date();jq("#historyBlock .textEditCalendar").datepicker("setDate",n.created)}if(SelectedUsers.IDs.length!=0){n.notifyUserList=SelectedUsers.IDs}return n};var g=function(){var j=jq("#eventsFilterContainer").is(":hidden")==false;if(ASC.CRM.HistoryView.isFilterVisible==false&&j){ASC.CRM.HistoryView.isFilterVisible=true;if(ASC.CRM.HistoryView.advansedFilter){jq("#eventsAdvansedFilter").advansedFilter("resize")}}};var c=function(){AjaxPro.HistoryView.GetEntityItems(ASC.CRM.HistoryView.ContactID,function(o){if(o.error!=null){alert(o.error.Message);return}var j=jq(jq.parseJSON(o.value));if(j.length>0){if(!jq.browser.mobile){for(var k=0,m=j.length;k<m;k++){var l=jq("<a></a>").addClass("dropDownItem").text(j[k].title).attr("itemid",j[k].id).unbind("click").click(function(){ASC.CRM.HistoryView.changeHistoryItem(jq(this))});if(j[k].type=="case"){jq("#historyCasePanel div.dropDownContent").append(l)}else{jq("#historyDealPanel div.dropDownContent").append(l)}}}else{for(var k=0,m=j.length;k<m;k++){var l=jq("<option></option>").text(j[k].title).attr("value",j[k].id);if(j[k].type=="case"){jq("#historyCaseSelect").append(l)}else{jq("#historyDealSelect").append(l)}}}jq("#eventLinkToPanel").removeClass("empty-select")}})};return{CallbackMethods:{get_events_by_filter:function(l,j){if(typeof(l.__nextIndex)=="undefined"){ASC.CRM.HistoryView.ShowMore=false}ASC.CRM.HistoryView.EventsList=j;for(var k=0;k<j.length;k++){ASC.CRM.HistoryView.eventItemFactory(j[k])}if(l.startIndex===0){jq("#eventsTable tbody tr").remove();if(j.length==0){if(typeof(ASC.CRM.HistoryView.advansedFilter)=="undefined"||ASC.CRM.HistoryView.advansedFilter.advansedFilter().length==1){jq("#eventsList").hide();jq("#eventsFilterContainer").hide();jq("#emptyContentForEventsFilter").hide();ASC.CRM.HistoryView.ShowMore=false;LoadingBanner.hideLoading();return false}else{jq("#eventsList").hide();jq("#eventsFilterContainer").show();jq("#emptyContentForEventsFilter").show();LoadingBanner.hideLoading();return false}}jq("#historyRowTmpl").tmpl(j).appendTo("#eventsTable tbody");jq("#emptyContentForEventsFilter").hide();jq("#eventsFilterContainer").show();jq("#eventsList").show();g();LoadingBanner.hideLoading()}else{if(j.length==0&&jq("#eventsTable tbody tr").length==0){jq("#eventsList").hide();jq("#eventsFilterContainer").show();jq("#emptyContentForEventsFilter").show();LoadingBanner.hideLoading();return false}jq("#historyRowTmpl").tmpl(j).appendTo("#eventsTable tbody")}for(var k=0;k<j.length;k++){if(j[k].files!=null){jq.dropdownToggle({dropdownID:"eventAttach_"+j[k].id,switcherSelector:"#eventAttachSwither_"+j[k].id,addTop:5})}}jq("#showMoreEventsButtons .crm-loadingLink").hide();if(ASC.CRM.HistoryView.ShowMore){jq("#showMoreEventsButtons .crm-showMoreLink").show()}else{jq("#showMoreEventsButtons .crm-showMoreLink").hide()}},add_event:function(k,j){ASC.CRM.HistoryView.addEventToHistoryLayout(k,j);if(j.files!=null){if(typeof(Attachments)!="undefined"){Attachments.appendFilesToLayout(j.files)}}},delete_event:function(k,j){jq("#eventAttach_"+j.id).find("div[id^=fileContent_]").each(function(){var l=jq(this).attr("id").split("_")[1];if(typeof(Attachments)!="undefined"){Attachments.deleteFileFromLayout(l)}});jq("#event_"+j.id).animate({opacity:"hide"},500);setTimeout(function(){jq("#event_"+j.id).remove();if(jq("#eventsTable tr").length==0){if(typeof(ASC.CRM.HistoryView.advansedFilter)!="undefined"&&ASC.CRM.HistoryView.advansedFilter.advansedFilter().length==1){jq("#eventsFilterContainer").hide();jq("#eventsList").hide()}else{f()}}},500)},delete_file_from_event:function(k,j){if(typeof(Attachments)!="undefined"){Attachments.deleteFileFromLayout(j.id)}ASC.CRM.HistoryView.deleteFileFromEventLayout(j.id,k.messageID)}},init:function(j,o,n,k,m,l){ASC.CRM.HistoryView.ContactID=j;ASC.CRM.HistoryView.EntityID=n;ASC.CRM.HistoryView.EntityType=o;ASC.CRM.HistoryView.CountOfRows=k;ASC.CRM.HistoryView.EventsList={};ASC.CRM.HistoryView.ShowMore=true;ASC.CRM.HistoryView.isFilterVisible=false;ASC.CRM.HistoryView.isTabActive=false;ASC.CRM.HistoryView.isFirstTime=true;jq("#showMoreEventsButtons .crm-showMoreLink").bind("click",function(){b()});jq("#DepsAndUsersContainer").css("z-index",999);jq("#historyBlock input.textEditCalendar").mask(l);jq("#historyBlock input.textEditCalendar").datepicker().val(m);jq("#historyBlock table #selectedUsers").remove();if(!jq.browser.mobile){ASC.CRM.FileUploader.OnBeginCallback_function=function(){jq("#historyBlock div.action_block").hide();jq("#historyBlock div.ajax_info_block").show();jq("#historyBlock textarea, #historyBlock input, #historyBlock select").attr("disabled",true);jq("#attachButtonsPanel .attachLink").addClass("disabledLink")};ASC.CRM.FileUploader.OnAllUploadCompleteCallback_function=function(){var p=e();p.fileId=ASC.CRM.FileUploader.fileIDs;Teamlab.addCrmHistoryEvent({},p,{success:ASC.CRM.HistoryView.CallbackMethods.add_event,before:function(q){},after:function(q){jq("#historyBlock div.action_block a.baseLinkButton").addClass("disableLink").removeClass("baseLinkButton");jq("#historyBlock div.action_block").show();jq("#historyBlock div.ajax_info_block").hide();jq("#historyBlock textarea, #historyBlock input, #historyBlock select").attr("disabled",false);jq("#attachButtonsPanel .attachLink").removeClass("disabledLink")}})};ASC.CRM.FileUploader.activateUploader();ASC.CRM.FileUploader.fileIDs.clear()}setInterval(function(){var q=jq.trim(jq("#historyBlock textarea").val());var p=jq("#contactProfileEdit .info_for_company input[name=baseInfo_companyName]");if(q==""){jq("#historyBlock .action_block a.baseLinkButton").addClass("disableLink").removeClass("baseLinkButton")}else{jq("#historyBlock .action_block a.disableLink").addClass("baseLinkButton").removeClass("disableLink")}},500)},setFilter:function(k,j,l,m,n){f()},resetFilter:function(k,j,l,m){f()},activate:function(){if(ASC.CRM.HistoryView.isTabActive==false){ASC.CRM.HistoryView.isTabActive=true;LoadingBanner.displayLoading();c();f()}},getFilterSettings:function(){var k={};if(ASC.CRM.HistoryView.advansedFilter.advansedFilter==null){return k}var j=ASC.CRM.HistoryView.advansedFilter.advansedFilter();jq(j).each(function(o,p){switch(p.id){case"sorter":k.sortBy=p.params.id;k.sortOrder=p.params.dsc==true?"descending":"ascending";break;case"text":k.filterValue=p.params.value;break;case"fromToDate":k.fromDate=new Date(p.params.from);k.toDate=new Date(p.params.to);break;default:if(p.hasOwnProperty("apiparamname")&&p.params.hasOwnProperty("value")&&p.params.value!=null){try{var l=jq.parseJSON(p.apiparamname);var m=jq.parseJSON(p.params.value);if(l.length!=m.length){k[p.apiparamname]=p.params.value}for(var o=0,q=l.length;o<q;o++){if(m[o].trim().length!=0){k[l[o]]=m[o]}}}catch(n){k[p.apiparamname]=p.params.value}}break}});return k},eventItemFactory:function(j){if(j.entity!=null){switch(j.entity.entityType){case"opportunity":j.entityURL="deals.aspx?id="+j.entity.entityId;j.entityType=CRMJSResources.Deal;break;case"case":j.entityURL="cases.aspx?id="+j.entity.entityId;j.entityType=CRMJSResources.Case;break;default:j.entityURL="";j.entityType="";break}}},deleteFile:function(j,k){Teamlab.removeCrmFile({messageID:k},j,{success:ASC.CRM.HistoryView.CallbackMethods.delete_file_from_event})},deleteFileFromEventLayout:function(j,k){jq("#fileContent_"+j).remove();if(jq("#eventAttach_"+k+">.dropDownContent>div").length==0){jq(jq("#eventAttach_"+k).parent()).html("")}},showAttachmentPanel:function(l){if(l){var k=jq("#attachButtonsPanel a:first");if(jq(k).hasClass("disabledLink")){return false}jq("#attachOptions").show();jq(k).hide().next().show()}else{var j=jq("#attachButtonsPanel a:last");if(jq(j).hasClass("disabledLink")){return false}jq("#attachOptions").hide();jq(j).hide().prev().show()}},addEvent:function(){if(jq.trim(jq("#historyBlock textarea").val())==""){return}if(!jq.browser.mobile&&fileUploader.GetUploadFileCount()>0){jq("#"+fileUploader.ButtonID).css("visibility","hidden");jq("#pm_upload_btn_html5").hide();fileUploader.Submit()}else{var j=e();Teamlab.addCrmHistoryEvent({},j,{success:ASC.CRM.HistoryView.CallbackMethods.add_event,before:function(k){jq("#historyBlock div.action_block").hide();jq("#historyBlock div.ajax_info_block").show();jq("#historyBlock textarea, #historyBlock input, #historyBlock select").attr("disabled",true)},after:function(k){jq("#historyBlock div.action_block a.baseLinkButton").addClass("disableLink").removeClass("baseLinkButton");jq("#historyBlock div.action_block").show();jq("#historyBlock div.ajax_info_block").hide();jq("#historyBlock textarea, #historyBlock input, #historyBlock select").attr("disabled",false)}})}},addEventToHistoryLayout:function(k,j){ASC.CRM.HistoryView.eventItemFactory(j);jq("#historyBlock textarea").val("");jq("#historyBlock textarea").focus();if(jq.browser.mobile){jq("#historyTypeSelect option:first").attr("selected",true);jq("#historyTypeSelect").change();jq("#historyContactSelect option:first").attr("selected",true);jq("#historyContactSelect").change()}else{ASC.CRM.HistoryView.changeHistoryType("",jq("#historyTypePanel a.dropDownItem:first"));ASC.CRM.HistoryView.changeHistoryContact(-1,jq("#historyContactPanel a.dropDownItem:first"))}SelectedUsers.IDs.clear();SelectedUsers.Names.clear();jq("#selectedUsers div").remove();if(!jq.browser.mobile){ASC.CRM.FileUploader.activateUploader();ASC.CRM.FileUploader.fileIDs.clear();ASC.CRM.HistoryView.showAttachmentPanel(false)}if(jq("#eventsTable tbody tr").length==0){jq("#emptyContentForEventsFilter").hide();jq("#eventsFilterContainer").show();jq("#eventsList").show();g()}jq("#historyRowTmpl").tmpl(j).prependTo("#eventsTable tbody");if(j.files!=null){jq.dropdownToggle({dropdownID:"eventAttach_"+j.id,switcherSelector:"#eventAttachSwither_"+j.id,addTop:5})}},deleteEvent:function(j){Teamlab.removeCrmHistoryEvent({},j,{success:ASC.CRM.HistoryView.CallbackMethods.delete_event,before:function(k){jq("#eventTrashImg_"+j).hide();jq("#eventLoaderImg_"+j).show()},after:function(k){jq("#eventLoaderImg_"+j).hide();jq("#eventTrashImg_"+j).show()}})},showDropdownPanel:function(l,k){var j=jq(l).find("a.linkMedium").width()-26;jq.dropdownToggle().toggle(l,k,5,j)},changeHistoryType:function(k,j){if(!jq.browser.mobile){jq("#typeID").val(k);jq("#itemID").val(-1);jq("#historyTypePanel").hide();jq("#historyCasePanel").hide();jq("#historyDealPanel").hide();jq("#historyItemSwitcher a").text(CRMJSResources.Choose);if(k!=""){jq("#historyTypeSwitcher a").text(jq(j).text().trim());jq("#historyItemSwitcher").show()}else{jq("#historyTypeSwitcher a").text(CRMJSResources.Choose);jq("#historyItemSwitcher").hide();return}switch(k){case"opportunity":jq("#historyItemSwitcher").unbind("click").bind("click",function(){ASC.CRM.HistoryView.showDropdownPanel("#historyItemSwitcher","historyDealPanel")});break;case"case":jq("#historyItemSwitcher").unbind("click").bind("click",function(){ASC.CRM.HistoryView.showDropdownPanel("#historyItemSwitcher","historyCasePanel")});break;default:jq("#historyItemSwitcher").unbind("click");break}}else{jq("#typeID").val(jq("#historyTypeSelect option:selected").attr("type"));switch(jq("#historyTypeSelect option:selected").val()){case"1":jq("#historyCaseSelect").hide();jq("#historyDealSelect").show();jq("#itemID").val(jq("#historyDealSelect option:selected").val());break;case"7":jq("#historyDealSelect").hide();jq("#historyCaseSelect").show();jq("#itemID").val(jq("#historyCaseSelect option:selected").val());break;case"-1":jq("#historyCaseSelect").hide();jq("#historyDealSelect").hide();jq("#itemID").val("0");break}}},changeHistoryItem:function(j){if(!jq.browser.mobile){jq("#itemID").val(jq(j).attr("itemid"));jq("#historyItemSwitcher a").text(jq(j).text().trim());jq("#historyCasePanel").hide();jq("#historyDealPanel").hide()}else{switch(jq("#historyTypeSelect option:selected").val()){case"1":jq("#itemID").val(jq("#historyDealSelect option:selected").val());break;case"7":jq("#itemID").val(jq("#historyCaseSelect option:selected").val());break;case"-1":jq("#itemID").val("0");break}}},changeHistoryContact:function(j,k){if(!jq.browser.mobile){jq("#contactID").val(j);if(j!=-1){jq("#historyContactSwitcher a").text(jq(k).text().trim())}else{jq("#historyContactSwitcher a").text(CRMJSResources.Choose)}jq("#historyContactPanel").hide()}else{jq("#contactID").val(jq("#historyContactSelect option:selected").val())}},appendOption:function(k,l){var j;if(jq.browser.mobile){j=jq("<option></option>").text(l.title).attr("value",l.value)}else{j=jq("<a></a>").addClass("dropDownItem").text(l.title).attr("contactid",l.value).unbind("click").click(function(){ASC.CRM.HistoryView.changeHistoryContact(l.value,jq(this))})}jq(k).append(j);jq("#eventLinkToPanel").removeClass("empty-select");return jq(k)},removeOption:function(j,k){if(jq.browser.mobile){jq(j).find('option[value="'+k+'"]').remove();jq(j).find("option:first").attr("selected",true);jq(j).change()}else{jq(j).find('a[contactid="'+k+'"]').remove();ASC.CRM.HistoryView.changeHistoryContact(-1,jq(j).find("a:first"))}if(jq(j).children().length==1){jq("#eventLinkToPanel").addClass("empty-select")}return jq(j)},appendOptionToContact:function(k){var j=jq.browser.mobile?jq("#historyContactSelect"):jq("#historyContactPanel div.dropDownContent");return ASC.CRM.HistoryView.appendOption(j,k)},removeOptionFromContact:function(k){var j=jq.browser.mobile?jq("#historyContactSelect"):jq("#historyContactPanel div.dropDownContent");return ASC.CRM.HistoryView.removeOption(j,k)}}})(jQuery);ASC.CRM.ContactSelector=new function(){this.WatermarkClass="crm-watermarked";var a=function(d,g,f,e,h){jq(d).Watermark(h,ASC.CRM.ContactSelector.WatermarkClass);jq(d).autocomplete({minLength:0,delay:300,focus:function(i,j){if(typeof(j.item)!="undefined"){jq(d).val(Encoder.htmlDecode(j.item.title))}return false},select:function(i,j){if(typeof(e.SelectItemEvent)=="undefined"){e.setContact(this,j.item.id,j.item.title,j.item.img);e.showInfoContent(this);return false}else{e.SelectItemEvent(j.item,this);jq(this).val("");return false}},selectFirst:false,search:function(i,j){return true},source:function(i,j){var k=i.term;if(k in ASC.CRM.ContactSelector.Cache){j(ASC.CRM.ContactSelector.Cache[k]);return}AjaxPro.onLoading=function(l){if(l){jq("#searchImg_"+f).hide();jq("#loaderImg_"+f).show()}else{jq("#searchImg_"+f).show();jq("#loaderImg_"+f).hide()}};AjaxPro.ContactSelector.GetContactsByPrefix(k,e.SelectorType,e.EntityType,e.EntityID,function(m){if(m.error!=null){alert(m.error.Message);return}var n=jq.parseJSON(m.value);ASC.CRM.ContactSelector.Cache[k]=n;j(ASC.CRM.ContactSelector.Cache[k]);if(ASC.CRM.ContactSelector.Cache[k]==null||ASC.CRM.ContactSelector.Cache[k].length==0){var l=jq(g).children("tbody").children("tr");var o=l.width()-(l.children("td").length-3)*18-2;jq("#noMatches_"+f).css("width",o+"px");jq("#noMatches_"+f).show()}})}}).data("autocomplete")._renderItem=function(k,i){jq("#noMatches_"+f).hide();if(jq.inArray(i.id,e.SelectedContacts)!=-1){return}if(typeof(e.ExcludedArrayIDs)!="undefined"){if(jq.inArray(i.id,e.ExcludedArrayIDs)!=-1){return}}var j=i.parentID>0?jq.format("<br/><span class='textMediumDescribe'>{0}: {1}</span>",CRMJSResources.Company,i.parentTitle):"";if(e.IsInPopup){jq(k).css("position","fixed")}return jq("<li></li>").data("item.autocomplete",i).append(jq("<a href='javascript:void(0)'></a>").html(i.title+j)).appendTo(k)};jq(d).data("autocomplete")._resizeMenu=function(){var k=this.menu.element;var i=jq(g).children("tbody").children("tr");var j=i.width()-(i.children("td").length-3)*18;k.outerWidth(Math.max(j,this.element.outerWidth()))};jq(d).data("autocomplete")._suggest=function(i){var j=this.menu.element.empty().zIndex(this.element.zIndex()+1);this._renderMenu(j,i);this.menu.deactivate();this.menu.refresh();j.show();this._resizeMenu();j.position(jq.extend({of:jq(this.element).parents("table:first")},this.options.position))}};var b=function(e,d,f){jq(e).bind("click",function(g){jq("div[id^='noMatches_"+f+"']").hide();if(jq(this).val().trim()==d||jq(this).val().trim()==""){jq(this).autocomplete("search","")}else{jq(this).autocomplete("search",jq(e).val().trim())}})};var c=function(e,d){jq(e).bind("keyup",function(f){if(jq(this).val().trim()==d||jq(this).val().trim()==""){jq(this).parents("table:first").find("img.crossButton").hide()}else{jq(this).parents("table:first").find("img.crossButton").show()}})};this.ContactSelector=function(j,l,k,g,f,d,h,i){if(typeof(window[j])!="undefined"){return window[j]}this.ObjName=j;this.SelectorType=l;this.SelectedContacts=k;this.ExcludedArrayIDs=h;this.EntityType=jq("#entityType_"+j).val();this.EntityID=jq("#entityID_"+j).val();this.DescriptionText=g;this.DeleteContactText=f;this.AddContactText=d;this.CrossButtonEventClick;this.SelectItemEvent;this.IsInPopup=i;this.newCompanyTitleWatermark="";this.newContactFirstNameWatermark="";this.newContactLastNameWatermark="";var e=this;jq(document).ready(function(){ASC.CRM.ContactSelector.Cache={};var m=jq("#selector_"+j).children("div:first").children("div.contactSelector-item");jq(m[m.length-1]).addClass("withPlus");jq("#selector_"+j).find("input[id^=contactTitle_]").each(function(n){a(this,jq(this).parents("table:first"),j+"_"+n,e,g);b(this,e.DescriptionText,e.ObjName);c(this,e.DescriptionText)})});this.changeContact=function(o){var m=parseInt(jq("#contactID_"+o).val());var n=jq.inArray(m,e.SelectedContacts);if(n!=-1){e.SelectedContacts.splice(n,1)}jq(window).trigger("editContactInSelector",[jq("#item_"+o),this.ObjName]);jq("#contactID_"+o).val(0);e.showSelectorContent(jq("#contactTitle_"+o))};this.deleteContact=function(p){var n=parseInt(jq("#contactID_"+p).val());var o=jq.inArray(n,e.SelectedContacts);if(o!=-1){e.SelectedContacts.splice(o,1)}jq(window).trigger("deleteContactFromSelector",[jq("#item_"+p),this.ObjName]);jq("#item_"+p).remove();var m=jq("#selector_"+e.ObjName).children("div:first").children("div.contactSelector-item");m.filter(".withPlus").removeClass("withPlus");jq(m[m.length-1]).addClass("withPlus")};this.crossButtonEventClick=function(o){jq("#selectorContent_"+o).children(".contactSelector-inputContainer").find(".crossButton").hide();if(typeof(e.CrossButtonEventClick)=="undefined"){var m=parseInt(jq("#contactID_"+o).val());var n=jq.inArray(m,e.SelectedContacts);if(n!=-1){e.SelectedContacts.splice(n,1)}jq("#contactTitle_"+o).val("").blur();jq("#contactID_"+o).val(0);jq("#noMatches_"+o).hide()}else{e.CrossButtonEventClick()}};this.setContact=function(o,m,q,n){if(jq(o).length==0){return}var p=jq(o).attr("id").replace("contactTitle_","");jq(o).val(Encoder.htmlDecode(q));if(n!=""){jq("#infoContent_"+p).find("img:first").attr("src",n)}jq("#infoContent_"+p).find("b:first").html(q);jq("#contactID_"+p).val(m);if(jq.inArray(m,e.SelectedContacts)==-1&&m!=0){e.SelectedContacts.push(m)}};this.showInfoContent=function(m){var n=jq(m).attr("id").replace("contactTitle_","");jq("#selectorContent_"+n).hide();jq("#newContactContent_"+n).hide();jq("#infoContent_"+n).show()};this.showSelectorContent=function(m){var n=jq(m).attr("id").replace("contactTitle_","");if(jq(m).val().trim()==g||jq(m).val().trim()==""){jq(m).parents("table:first").find("img.crossButton").hide()}else{jq(m).parents("table:first").find("img.crossButton").show()}jq("#infoContent_"+n).hide();jq("#newContactContent_"+n).hide();jq("#selectorContent_"+n).show();jq(window).trigger("afterResetSelectedContact",[jq("#item_"+n),this.ObjName])};this.AddNewSelector=function(m){if(m.hasClass("disabledLink")){return}m.addClass("disabledLink");AjaxPro.onLoading=function(p){};var n=0;var o=jq("#selector_"+e.ObjName+" input[id^=contactTitle_]:last");if(jq(o).length>0){var n=parseInt(jq(o).attr("id").replace("contactTitle_"+e.ObjName+"_",""))+1}AjaxPro.ContactSelector.AddNewSelector(e.ObjName,n,e.DescriptionText,e.DeleteContactText,e.AddContactText,function(r){if(r.error!=null){alert(r.error.Message);return}jq("#selector_"+e.ObjName+" div:first").append(r.value);var p=jq("#selector_"+e.ObjName).children("div:first").children("div.contactSelector-item");p.filter(".withPlus").removeClass("withPlus");jq(p[p.length-1]).addClass("withPlus");var q=jq("#contactTitle_"+e.ObjName+"_"+n);a(q,jq(q).parents("table:first"),e.ObjName+"_"+n,e,e.DescriptionText);b(q,e.DescriptionText,e.ObjName);c(q,e.DescriptionText);m.removeClass("disabledLink")})};this.quickSearch=function(n){var m=jq("#contactTitle_"+n);if(jq(m).val().trim()==e.DescriptionText||jq(m).val().trim()==""){jq(m).autocomplete("search","")}else{jq(m).autocomplete("search",jq(m).val().trim())}};this.showNewCompany=function(m){jq("#newContactContent_"+m+" input").val("");jq("#hiddenIsCompany_"+m).val("true");jq("#noMatches_"+m).hide();jq("#infoContent_"+m).hide();jq("#selectorContent_"+m).hide();jq("#newContactImg_"+m).hide();jq("#newContactFirstName_"+m).hide();jq("#newContactLastName_"+m).hide();jq("#newContactContent_"+m).show();jq("#newCompanyImg_"+m).show();jq("#newCompanyTitle_"+m).val(jq("#contactTitle_"+m).val()).show().focus();jq("#newCompanyTitle_"+m).Watermark(this.newCompanyTitleWatermark,ASC.CRM.ContactSelector.WatermarkClass)};this.showNewContact=function(m){jq("#newContactContent_"+m+" input").val("");jq("#hiddenIsCompany_"+m).val("false");jq("#noMatches_"+m).hide();jq("#infoContent_"+m).hide();jq("#selectorContent_"+m).hide();jq("#newCompanyImg_"+m).hide();jq("#newCompanyTitle_"+m).hide();jq("#newContactContent_"+m).show();jq("#newContactImg_"+m).show();jq("#newContactLastName_"+m).Watermark(this.newContactLastNameWatermark,ASC.CRM.ContactSelector.WatermarkClass);jq("#newContactLastName_"+m).show();jq("#newContactFirstName_"+m).val(jq("#contactTitle_"+m).val()).show().focus();jq("#newContactFirstName_"+m).Watermark(this.newContactFirstNameWatermark,ASC.CRM.ContactSelector.WatermarkClass)};this.acceptNewContact=function(t){var p=jq("#hiddenIsCompany_"+t).val()=="true";var m=jq("#newCompanyTitle_"+t).length>0?jq("#newCompanyTitle_"+t).val().trim():"";var n=jq("#newContactFirstName_"+t).length>0?jq("#newContactFirstName_"+t).val().trim():"";var r=jq("#newContactLastName_"+t).length>0?jq("#newContactLastName_"+t).val().trim():"";var s=this;var o=jq("#contactTitle_"+t);var q=true;if(p&&(m==""||jq("#newCompanyTitle_"+t).hasClass(ASC.CRM.ContactSelector.WatermarkClass))){jq("#newCompanyTitle_"+t).addClass("requiredInputError");q=false}else{jq("#newCompanyTitle_"+t).removeClass("requiredInputError")}if(!p&&(n==""||jq("#newContactFirstName_"+t).hasClass(ASC.CRM.ContactSelector.WatermarkClass))){jq("#newContactFirstName_"+t).addClass("requiredInputError");q=false}else{jq("#newContactFirstName_"+t).removeClass("requiredInputError")}if(!p&&(r==""||jq("#newContactLastName_"+t).hasClass(ASC.CRM.ContactSelector.WatermarkClass))){jq("#newContactLastName_"+t).addClass("requiredInputError");q=false}else{jq("#newContactLastName_"+t).removeClass("requiredInputError")}if(!q){return false}AjaxPro.ContactSelector.AddNewContact(p,m,n,r,function(v){if(v.error!=null){return}var u=jq.parseJSON(v.value);if(typeof(s.SelectItemEvent)=="undefined"){jq("#infoContent_"+t).show();jq("#selectorContent_"+t).hide();jq("#newContactContent_"+t).hide();s.setContact(o,u.id,u.title,u.img);s.showInfoContent(o);if(p){jq("#infoContent_"+t+" img:first").attr("src",jq("#newCompanyImg_"+t).attr("src"))}else{jq("#infoContent_"+t+" img:first").attr("src",jq("#newContactImg_"+t).attr("src"))}}else{s.showSelectorContent(o);jq(o).val("");s.SelectItemEvent(u,o)}})};this.rejectNewContact=function(m){jq("#infoContent_"+m).hide();jq("#selectorContent_"+m).show();jq("#newContactContent_"+m).hide();jq("#noMatches_"+m).show();jq("#newContactContent_"+m+" input").removeClass("requiredInputError")}}};ASC.CRM.CategorySelector=new function(){this.CategorySelectorPrototype=function(a){this.ObjName=a;this.Me=function(){return jq("#"+this.ObjName)};this.CategoryTitle=jq.browser.mobile==true?jq("select[id="+this.ObjName+"_select] option:selected",this.Me()).text():jq("input[id="+this.ObjName+"_categoryTitle]",this.Me()).val();this.CategoryID=jq.browser.mobile==true?parseInt(jq("select[id="+this.ObjName+"_select] option:selected",this.Me()).val()):parseInt(jq("input[id="+this.ObjName+"_categoryID]",this.Me()).val());this.changeContact=function(c){if(!jq.browser.mobile){var b=parseInt(jq(c).attr("id").split("_")[2]);var d=jq("div",jq(c)).text();this.setContact(b,d);this.hideSelectorContent()}else{var b=parseInt(jq(c).val());var d=jq(c).text();this.setContact(b,d)}};this.setContact=function(b,c){this.CategoryID=b;this.CategoryTitle=c;if(!jq.browser.mobile){jq("input[id="+this.ObjName+"_categoryID]",this.Me()).val(b);jq("input[id="+this.ObjName+"_categoryTitle]",this.Me()).val(c)}else{jq("option[id="+this.ObjName+"_category_"+b+"]",this.Me()).attr("selected",true)}};this.hideSelectorContent=function(){jq("div[id="+this.ObjName+"_categoriesContainer]",this.Me()).hide()};this.showSelectorContent=function(){jq("div[id="+this.ObjName+"_categoriesContainer]",this.Me()).toggle()};this.getRowByContactID=function(b){if(b>0){return jq.browser.mobile?jq("option[id="+this.ObjName+"_category_"+b+"]",this.Me()):jq("div[id="+this.ObjName+"_category_"+b+"]",this.Me())}else{return jq.browser.mobile?jq("option[id^="+this.ObjName+"_category_]:first",this.Me()):jq("div[id^="+this.ObjName+"_category_]:first",this.Me())}}}};ASC.CRM.TagView=(function(a){return{init:function(b){ASC.CRM.TagView.TargetEntityType=b;if(jq("#addTagDialog a.dropDownItem").length==0){jq("#addTagDialog .h_line").hide()}jq.dropdownToggle({dropdownID:"addTagDialog",switcherSelector:"#addNewTag",addTop:5,addLeft:jq("#addNewTag").width()-35});jq("#addTagDialog input").focus().unbind("keyup").keyup(function(d){var c;if(!d){d=event}if(d.keyCode){c=d.keyCode}else{if(d.which){c=d.which}}if(c==13){if(jq("#addTagDialog input").val().trim()==""){return}ASC.CRM.TagView.addNewTag()}})},addNewTag:function(){var b=jq("#addTagDialog input").val().trim();if(b!=null&&b!=""){jq("#tagContainer .adding_tag_loading").show();jq("#addTagDialog").hide();AjaxPro.TagView.AddTag(jq.getURLParam("id"),ASC.CRM.TagView.TargetEntityType,b,function(c){jq("#tagContainer .adding_tag_loading").hide();if(c.error==null){jq("#taqTmpl").tmpl({tagText:b}).appendTo("#tagContainer div:first");jq("#addTagDialog input").val("")}})}},deleteTag:function(b){var c=b.children(".tag_title").text();AjaxPro.TagView.DeleteTag(jq.getURLParam("id"),ASC.CRM.TagView.TargetEntityType,c,function(d){if(d.error==null){b.remove();jq("#addTagDialog .h_line").show();jq("#tagInAllTagsTmpl").tmpl({tagText:c}).appendTo("#addTagDialog .dropDownContent")}})},addExistingTag:function(b){var c=jq(b).text();jq("#tagContainer .adding_tag_loading").show();jq("#addTagDialog").hide();AjaxPro.TagView.AddTag(jq.getURLParam("id"),ASC.CRM.TagView.TargetEntityType,c,function(d){jq("#tagContainer .adding_tag_loading").hide();if(d.error==null){jq("#taqTmpl").tmpl({tagText:c}).appendTo("#tagContainer div:first");jq(b).remove();if(jq("#addTagDialog a.dropDownItem").length==0){jq("#addTagDialog .h_line").hide()}jq("#addTagDialog input").val("")}})}}})(jQuery);ASC.CRM.ImportContacts=(function(a){var c;var d=0;var b;var e;var i=new Object();var j=new Object();var h=function(k){var l=jq.parseJSON(k);var m=l.data;var n=0;jq("#columnMapping tbody tr td").each(function(o){if((o+1)%3==0){jq(this).text(m[n++])}});if(l.isMaxIndex){jq("#nextSample").hide().prev().hide()}};var f=function(){AjaxPro.onLoading=function(l){if(l){jq("#columnMapping thead tr td:last span:last").block()}else{jq("#columnMapping thead tr td:last span:last").unblock()}};var k=c+""+d;if(i[k]){h(i[k]);return}AjaxPro.Utils.ImportFromCSV.GetSampleRow(c,d,jq.toJSON(j),function(l){if(l.error!=null){alert(l.error.Message);return}i[k]=l.value;h(l.value)})};var g=function(k){jq(jq.format("#importFromCSVSteps dd:eq({0})",k-1)).hide();jq(jq.format("#importFromCSVSteps dt:eq({0})",k-1)).hide();jq(jq.format("#importFromCSVSteps dd:eq({0})",k)).show();jq(jq.format("#importFromCSVSteps dt:eq({0})",k)).show()};return{init:function(k){e=k;if(e==0){jq("#removingDuplicatesBehaviorPanel").show()}else{jq("#removingDuplicatesBehaviorPanel").hide()}jq("#columnSelectorTemplate").tmpl(columnSelectorData).appendTo("#columnSelectorBase");jq("#columnSelectorBase").find("option[name=is_header]").each(function(){var l=jq(this);l.nextUntil("option[name=is_header]").wrapAll(jq("<optgroup>").attr("label",l.val()));l.remove()});b=new AjaxUpload("uploadCSVFile",{action:"ajaxupload.ashx?type=ASC.Web.CRM.Controls.Common.ImportFileHandler,ASC.Web.CRM",autoSubmit:false,onChange:function(m,l){if(l[0].toLowerCase()!="csv"){alert(CRMJSResources.ErrorMessage_NotSupportedFileFormat);return false}var n=jq("#uploadCSVFile").prev();n.show();n.text(jq.format(CRMJSResources.SelectedCSVFileLabel,m));jq("#uploadCSVFile").removeClass("import_button").addClass("linkEditButton").text(CRMJSResources.Change);jq("#importFromCSVSteps dd:first div.action_block a:first").removeClass("disableLinkButton").addClass("baseLinkButton");return true},onSubmit:function(m,l){j={has_header:jq("#ignoreFirstRow").is(":checked"),delimiter_character:jq("#delimiterCharacterSelect option:selected").val(),encoding:jq("#encodingSelect option:selected").val(),quote_character:jq("#quoteCharacterSelect option:selected").val()};this._settings.data.importSettings=jq.toJSON(j);jq("#importFromCSVSteps .action_block").hide();jq("#importFromCSVSteps div.ajax_info_block").show()},onComplete:function(l,m){var o=jq.parseJSON(m);if(!o.Success){alert(o.Error);return}var n=jq.parseJSON(jQuery.base64.decode(o.Data));c=n.assignedPath;if(n.isMaxIndex){jq("#prevSample").parent().hide()}else{jq("#prevSample").parent().show()}var q=jq("#columnMapping tbody");q.html("");jq("#columnMappingTemplate").tmpl(n,{renderSelector:function(s){var r=jq("#columnSelectorBase").clone();r.attr("id",jq.format("columnSelector_{0}",s));r.show();return jq("<div>").append(r).html()}}).appendTo(q);var p=jq("#columnMapping select");p.each(function(){try{var s=jq(this);var r=s.parent().prev().text().trim();if(jq.browser.msie){var v=jq(r.match(/\(/g)).length;var w=jq(r.match(/\)/g)).length;if(v!=w){return}}var u=s.find(jq.format("option:contains('{0}'):first",r)).attr("selected",true)}catch(t){}});p.live("change",function(){var r=jq(this);if(r.find("option:first").is(":selected")){r.parents("td").addClass("missing")}else{r.parents("td").removeClass("missing")}});p.change();jq("#uploadCSVFile").removeClass("linkEditButton").addClass("import_button");jq("#uploadCSVFile").text(CRMJSResources.SelectCSVFileButton);jq("#uploadCSVFile").prev().hide();g(1);jq("#importFromCSVSteps .action_block").show();jq("#importFromCSVSteps div.ajax_info_block").hide()}})},prevStep:function(k){jq(jq.format("#importFromCSVSteps dd:eq({0})",k+1)).hide();jq(jq.format("#importFromCSVSteps dt:eq({0})",k+1)).hide();jq(jq.format("#importFromCSVSteps dd:eq({0})",k)).show();jq(jq.format("#importFromCSVSteps dt:eq({0})",k)).show();if(k!=0){return}jq("#importFromCSVSteps dd:first div.action_block a:first").addClass("disableLinkButton").removeClass("baseLinkButton")},getPreviewImportData:function(){var k=jq("#columnMapping select");var o=k.find("option[name=firstName]:selected");var q=k.find("option[name=lastName]:selected");var m=k.find("option[name=companyName]:selected");if((o.length==0||q.length==0)&&m.length==0){alert(CRMJSResources.ErrorNotMappingBasicColumn);return}if(!((o.length==1&&q.length==1)||(m.length==1))){alert(CRMJSResources.ErrorMappingMoreBasicColumn);return}var l=0;var n=0;var p=0;if(m.length==1){l=k.index(jq(m[0]).parents("select"))}if(o.length==1&&q.length==1){n=k.index(jq(o[0]).parents("select"));p=k.index(jq(q[0]).parents("select"))}AjaxPro.onLoading=function(r){if(r){jq("#importFromCSVSteps .action_block").hide();jq("#importFromCSVSteps div.ajax_info_block").show()}else{jq("#importFromCSVSteps .action_block").show();jq("#importFromCSVSteps div.ajax_info_block").hide()}};AjaxPro.Utils.ImportFromCSV.GetPreviewImportData(c,l,n,p,function(r){if(r.error!=null){alert(r.error.Message);return}var s=jq.parseJSON(r.value);jq("#previewImportData tbody tr").remove();jq("#previewImportDataTemplate").tmpl(s).appendTo("#previewImportData tbody");jq("#importFromCSVSteps dd:eq(2) span:eq(1)").text(jq.format(CRMJSResources.ImportFromCSVStepThreeDescription,jq("#previewImportData tbody tr").length));g(2)})},getColumnMapping:function(){var k={};jq("#columnMapping select").each(function(){var m=jq(this).find("option:selected").attr("name").trim();if(m==""||m==-1){return true}if(typeof k[m]=="undefined"){k[m]=new Array()}var l=this.id.split("_");if(l.length<2){return true}k[m].push(l[1])});return k},startImport:function(){var k=ASC.CRM.ImportContacts.getColumnMapping();for(var t in k){if(k[t].length>1){alert(CRMJSResources.ErrorMappingMoreBasicColumn);return}}var l=jq("#columnMapping select");switch(e){case 0:var o=l.find("option[name=firstName]:selected");var s=l.find("option[name=lastName]:selected");var m=l.find("option[name=companyName]:selected");if((o.length==0||s.length==0)&&m.length==0){alert(CRMJSResources.ErrorContactNotMappingBasicColumn);return}break;case 1:var w=l.find("option[name=title]:selected");var v=l.find("option[name=responsible]:selected");if(w.length==0||v.length==0){alert(CRMJSResources.ErrorOpportunityNotMappingBasicColumn);return}break;case 3:var w=l.find("option[name=title]:selected");var n=l.find("option[name=due_date]:selected");var v=l.find("option[name=responsible]:selected");if(w.length==0||n.length==0||v.length==0){alert(CRMJSResources.ErrorTaskNotMappingBasicColumn);return}break;case 7:var w=l.find("option[name=title]:selected");if(w.length==0){alert(CRMJSResources.ErrorCasesNotMappingBasicColumn);return}break;default:break}var r=j;r.column_mapping=k;if(e!=3){var u=new Array(SelectedUsers.CurrentUserID);for(var q=0;q<SelectedUsers.IDs.length;q++){u.push(SelectedUsers.IDs[q])}r.access_list=u;r.is_private=jq("#isPrivate").is(":checked")}if(e==0){r.removing_duplicates_behavior=jq("input[name='removingDuplicatesBehavior']:checked").val()}AjaxPro.onLoading=function(p){if(p){jq("#importFromCSVSteps .action_block").hide();jq("#importFromCSVSteps div.ajax_info_block").show()}else{jq("#importFromCSVSteps .action_block").show();jq("#importFromCSVSteps div.ajax_info_block").hide()}};AjaxPro.Utils.ImportFromCSV.StartImport(e,c,jq.toJSON(r),function(p){if(p.error!=null){alert(p.error.Message);return}jq("#importFromCSVSteps").hide();jq("#importStartedFinalMessage").show();ASC.CRM.ImportContacts.checkImportStatus(true)})},startUploadCSVFile:function(){b.submit()},getPrevSampleRow:function(){d--;jq("#nextSample").show().prev().show();if(d==0){jq("#prevSample").hide().next().hide()}f()},getNextSampleRow:function(){d++;jq("#prevSample").show().next().show();f()},checkImportStatus:function(k){AjaxPro.onLoading=function(l){};if(k){jq("#importStartedFinalMessage div.progress_box div.progress").css("width","0%");jq("#importStartedFinalMessage div.progress_box span.percent").text("0%");jq("#importErrorBox").hide();jq("#importStartedFinalMessage div.progressErrorBox").html("")}AjaxPro.Utils.ImportFromCSV.GetStatus(e,function(l){if(l.error!=null){alert(l.error.Message);return false}if(l.value==null){jq("#importStartedFinalMessage div.progress_box div.progress").css("width","100%");jq("#importStartedFinalMessage div.progress_box span.percent").text("100%");jq("#importErrorBox").hide();jq("#importStartedFinalMessage div.progressErrorBox").html("");return false}jq("#importStartedFinalMessage div.progress_box div.progress").css("width",parseInt(l.value.Percentage)+"%");jq("#importStartedFinalMessage div.progress_box span.percent").text(parseInt(l.value.Percentage)+"%");if(l.value.Error!=null&&l.value.Error!=""){ASC.CRM.ImportContacts.buildErrorList(l)}else{if(!l.value.IsCompleted){setTimeout("ASC.CRM.ImportContacts.checkImportStatus(false)",3000)}}})},buildErrorList:function(m){var l="error";switch(typeof m.value.Error){case"object":l=m.value.Error.Message+"<br/>";break;case"string":l=m.value.Error;break}var k=jq("#importStartedFinalMessage #importLinkBox a").clone().removeClass("baseLinkButton");jq("#importStartedFinalMessage div.progressErrorBox").html(jq("<div></div>").addClass("redText").html(l)).append(k);jq("#importStartedFinalMessage #importErrorBox").show();jq("#importStartedFinalMessage #importLinkBox").hide()}}})(jQuery);if(typeof ASC==="undefined"){ASC={}}if(typeof ASC.CRM==="undefined"){ASC.CRM=(function(){return{}})()}ASC.CRM.ListContactView=(function(){var f=function(k,j){if(ASC.CRM.ListContactView.cookieKey&&ASC.CRM.ListContactView.cookieKey!=""){var i={page:k,countOnPage:j};jq.cookies.set(ASC.CRM.ListContactView.cookieKey,i,{path:location.pathname})}};var e=function(){jq("#mainDelete").removeClass("unlockAction").unbind("click");jq("#mainAddTag").removeClass("unlockAction").unbind("click");jq("#mainSetPermissions").removeClass("unlockAction").unbind("click");jq("#mainSendEmail").removeClass("unlockAction").unbind("click")};var c=function(){if(ASC.CRM.ListContactView.selectedItems.length===0){e();return}if(!jq("#mainDelete").hasClass("unlockAction")){jq("#mainDelete").addClass("unlockAction").unbind("click").bind("click",function(){ASC.CRM.ListContactView.showDeletePanel()})}if(!jq("#mainAddTag").hasClass("unlockAction")){jq("#mainAddTag").addClass("unlockAction").unbind("click").bind("click",function(){ASC.CRM.ListContactView.showAddTagDialog()})}if(!jq("#mainSetPermissions").hasClass("unlockAction")){jq("#mainSetPermissions").addClass("unlockAction").unbind("click").bind("click",function(){ASC.CRM.ListContactView.showSetPermissionsPanel({isBatch:true})})}var l=false;for(var j=0,k=ASC.CRM.ListContactView.selectedItems.length;j<k;j++){if(ASC.CRM.ListContactView.selectedItems[j].primaryEmail!=null){l=true}}if(l){jq("#mainSendEmail").addClass("unlockAction").unbind("click").bind("click",function(){ASC.CRM.ListContactView.showSendEmailDialog()})}else{jq("#mainSendEmail").removeClass("unlockAction").unbind("click")}};var h=function(k,l){var j=jq("#addPrimaryPhone_"+k);j.css("borderColor","");var i=jq("#contactItem_"+k).find(".primaryPhone");if(i.length!=0){i.remove();if(l!=null){j.val(l.data)}}else{j.val("")}j.show().focus();jq.forcePhoneSymbolsOnly(j);j.unbind("blur").bind("blur",function(){var m=j.val().trim();if(m.length==0){j.val("").hide();return}else{b(k,m,l)}});j.unbind("keyup").bind("keyup",function(m){if(ASC.CRM.ListContactView.isEnterKeyPressed(m)){var n=j.val().trim();if(n.length==0){j.val("").hide();return}else{j.unbind("blur");b(k,n,l)}}})};var b=function(i,m,k){if(k==null){var l={contactId:i};var j={data:m,isPrimary:true,infoType:"Phone",category:"Work"};Teamlab.addCrmContactInfo(l,i,j,{success:ASC.CRM.ListContactView.CallbackMethods.add_primary_phone,before:function(n){jq("#check_contact_"+n.contactId).hide();jq("#loaderImg_"+n.contactId).show()},after:function(n){jq("#check_contact_"+n.contactId).show();jq("#loaderImg_"+n.contactId).hide()}})}else{var l={contactId:i};var j={id:k.id,data:m,isPrimary:true,infoType:"Phone"};Teamlab.updateCrmContactInfo(l,i,j,{success:ASC.CRM.ListContactView.CallbackMethods.add_primary_phone,before:function(n){jq("#check_contact_"+n.contactId).hide();jq("#loaderImg_"+n.contactId).show()},after:function(n){jq("#check_contact_"+n.contactId).show();jq("#loaderImg_"+n.contactId).hide()}})}};var g=function(k,l){var j=jq("#addPrimaryEmail_"+k);j.css("borderColor","");var i=jq("#contactItem_"+k).find(".primaryEmail");if(i.length!=0){i.remove();if(l!=null){j.val(l.data)}}else{j.val("")}j.show().focus();j.unbind("blur").bind("blur",function(){var m=j.val().trim();if(m.length==0){j.val("").hide();return}else{if(ASC.CRM.ListContactView.isEmailValid(m)){a(k,m,l)}else{j.css("borderColor","#CC0000");return false}}});j.unbind("keyup").bind("keyup",function(m){if(ASC.CRM.ListContactView.isEnterKeyPressed(m)){var n=j.val().trim();if(n.length==0){j.val("").hide();return}else{if(ASC.CRM.ListContactView.isEmailValid(n)){j.unbind("blur");a(k,n,l)}else{j.css("borderColor","#CC0000");return false}}}})};var a=function(i,k,l){if(l==null){var m={contactId:i};var j={data:k,isPrimary:true,infoType:"Email",category:"Work"};Teamlab.addCrmContactInfo(m,i,j,{success:ASC.CRM.ListContactView.CallbackMethods.add_primary_email,before:function(n){jq("#check_contact_"+n.contactId).hide();jq("#loaderImg_"+n.contactId).show()},after:function(n){jq("#check_contact_"+n.contactId).show();jq("#loaderImg_"+n.contactId).hide()}})}else{var m={contactId:i};var j={id:l.id,data:k,isPrimary:true,infoType:"Email"};Teamlab.updateCrmContactInfo(m,i,j,{success:ASC.CRM.ListContactView.CallbackMethods.add_primary_email,before:function(n){jq("#check_contact_"+n.contactId).hide();jq("#loaderImg_"+n.contactId).show()},after:function(n){jq("#check_contact_"+n.contactId).show();jq("#loaderImg_"+n.contactId).hide()}})}};var d=function(i,o){var k=jq.inArray(i.id,o);i.isChecked=k!=-1;i.primaryPhone=null;i.primaryEmail=null;i.nearTask=null;for(var l=0,m=i.commonData.length;l<m;l++){if(i.commonData[l].isPrimary){if(i.commonData[l].infoType==0){i.primaryPhone={data:i.commonData[l].data,id:i.commonData[l].id}}if(i.commonData[l].infoType==1){i.primaryEmail={data:i.commonData[l].data,id:i.commonData[l].id}}}}};return{CallbackMethods:{get_contacts_by_filter:function(p,k){ASC.CRM.ListContactView.Total=p.__total||0;var r=p.__startIndex||0;if(ASC.CRM.ListContactView.Total===0&&typeof(ASC.CRM.ListContactView.advansedFilter)!="undefined"&&ASC.CRM.ListContactView.advansedFilter.advansedFilter().length==1){ASC.CRM.ListContactView.noContacts=true;ASC.CRM.ListContactView.noContactsForQuery=true}else{ASC.CRM.ListContactView.noContacts=false;if(ASC.CRM.ListContactView.Total===0){ASC.CRM.ListContactView.noContactsForQuery=true}else{ASC.CRM.ListContactView.noContactsForQuery=false}}if(ASC.CRM.ListContactView.noContacts){jq("#companyTable tbody tr").remove();jq("#mainContactList").hide();jq("#contactsEmptyScreen").show();LoadingBanner.hideLoading();return false}if(ASC.CRM.ListContactView.noContactsForQuery){jq("#companyListBox").hide();jq("#companyTable tbody tr").remove();jq("#tableForContactNavigation").hide();jq("#mainSelectAll").attr("disabled",true);jq("#mainExportCsv").next("img").hide();jq("#mainExportCsv").hide();jq("#contactsEmptyScreen").hide();jq("#emptyContentForContactsFilter").show();LoadingBanner.hideLoading();return false}jq("#totalContactsOnPage").text(ASC.CRM.ListContactView.Total);var s;if(r>=ASC.CRM.ListContactView.Total){s=r+1}else{s=ASC.CRM.ListContactView.Total}contactPageNavigator.drawPageNavigator((r/ASC.CRM.ListContactView.entryCountOnPage).toFixed(0)*1+1,s);jq("#simpleContactPageNavigator").html("");var j=jq("<div></div>");var m=0;if(jq("#divForContactPager .pagerPrevButtonCSSClass").length!=0){m++;jq("#divForContactPager .pagerPrevButtonCSSClass").clone().appendTo(j)}if(jq("#divForContactPager .pagerNextButtonCSSClass").length!=0){m++;if(m===2){jq("<span style='padding: 0 8px;'>&nbsp;</span>").clone().appendTo(j)}jq("#divForContactPager .pagerNextButtonCSSClass").clone().appendTo(j)}if(j.children().length!=0){j.appendTo("#simpleContactPageNavigator");jq("#simpleContactPageNavigator").show()}else{jq("#simpleContactPageNavigator").hide()}if(k.length==0){jq("#contactsEmptyScreen").hide();jq("#emptyContentForContactsFilter").hide();jq("#companyListBox").show();jq("#companyTable tbody tr").remove();jq("#tableForContactNavigation").show();jq("#mainSelectAll").attr("disabled",true);jq("#mainExportCsv").next("img").hide();jq("#mainExportCsv").hide();LoadingBanner.hideLoading();return false}jq("#emptyContentForContactsFilter").hide();jq("#contactsEmptyScreen").hide();jq("#companyListBox").show();jq("#mainSelectAll").removeAttr("disabled");jq("#mainExportCsv").next("img").show();jq("#mainExportCsv").show();jq("#tableForContactNavigation").show();var q=new Array();for(var l=0,o=ASC.CRM.ListContactView.selectedItems.length;l<o;l++){q.push(ASC.CRM.ListContactView.selectedItems[l].id)}for(var l=0,o=k.length;l<o;l++){d(k[l],q);ASC.CRM.ListContactView.fullContactList.push(k[l])}ASC.CRM.ListContactView.getNearestTasks(k)},get_nearest_tasks:function(p,q){if(q.length>0){for(var k=0,n=q.length;k<n;k++){for(var l=0,o=ASC.CRM.ListContactView.fullContactList.length;l<o;l++){if(q[k].contact.id==ASC.CRM.ListContactView.fullContactList[l].id){ASC.CRM.ListContactView.fullContactList[l].nearTask=q[k];break}}for(var l=0,m=p.contacts.length;l<m;l++){if(q[k].contact.id==p.contacts[l].id){p.contacts[l].nearTask=q[k];break}}}}jq("#companyTable tbody").replaceWith(jq("#contactListTmpl").tmpl({contacts:p.contacts}));ASC.CRM.Common.RegisterContactInfoCard();ASC.CRM.Common.tooltip(".nearestTask","tooltip",true);window.scrollTo(0,0);LoadingBanner.hideLoading()},add_primary_phone:function(m,j){jq("#addPrimaryPhone_"+m.contactId).hide();jq("<span></span>").attr("title",j.data).attr("class","primaryPhone").text(j.data).appendTo(jq("#addPrimaryPhone_"+m.contactId).parent());for(var k=0,l=ASC.CRM.ListContactView.fullContactList.length;k<l;k++){if(ASC.CRM.ListContactView.fullContactList[k].id==m.contactId){ASC.CRM.ListContactView.fullContactList[k].primaryPhone={data:j.data,id:j.id}}}},add_primary_email:function(m,j){jq("#addPrimaryEmail_"+m.contactId).hide();jq("<a></a>").attr("title",j.data).attr("class","primaryEmail linkMedium").text(j.data).attr("href","mailto:"+j.data).appendTo(jq("#addPrimaryEmail_"+m.contactId).parent());jq("#addPrimaryEmailMenu").hide();for(var k=0,l=ASC.CRM.ListContactView.fullContactList.length;k<l;k++){if(ASC.CRM.ListContactView.fullContactList[k].id==m.contactId){ASC.CRM.ListContactView.fullContactList[k].primaryEmail={data:j.data,id:j.id}}}},delete_batch_contacts:function(w,l){var v=new Array();for(var m=0,s=ASC.CRM.ListContactView.fullContactList.length;m<s;m++){var p=false;for(var q=0,t=w.contactIDsForDelete.length;q<t;q++){if(w.contactIDsForDelete[q]==ASC.CRM.ListContactView.fullContactList[m].id){p=true;break}}if(!p){v.push(ASC.CRM.ListContactView.fullContactList[m])}}ASC.CRM.ListContactView.fullContactList=v;ASC.CRM.ListContactView.Total-=w.contactIDsForDelete.length;jq("#totalContactsOnPage").text(ASC.CRM.ListContactView.Total);var x=new Array();for(var m=0,u=ASC.CRM.ListContactView.selectedItems.length;m<u;m++){x.push(ASC.CRM.ListContactView.selectedItems[m].id)}for(var m=0,r=w.contactIDsForDelete.length;m<r;m++){var k=jq("#contactItem_"+w.contactIDsForDelete[m]);if(k.length!=0){k.remove()}var o=jq.inArray(w.contactIDsForDelete[m],x);if(o!=-1){x.splice(o,1);ASC.CRM.ListContactView.selectedItems.splice(o,1)}}jq("#mainSelectAll").attr("checked",false);c();if(ASC.CRM.ListContactView.selectedItems.length!=0){jq("#checkedContactsCount > span").text(jq.format(CRMJSResources.ElementsSelectedCount,ASC.CRM.ListContactView.selectedItems.length))}else{jq("#checkedContactsCount > span").text("");jq("#checkedContactsCount").hide()}if(ASC.CRM.ListContactView.Total==0&&(typeof(ASC.CRM.ListContactView.advansedFilter)=="undefined"||ASC.CRM.ListContactView.advansedFilter.advansedFilter().length==1)){ASC.CRM.ListContactView.noContacts=true;ASC.CRM.ListContactView.noContactsForQuery=true}else{ASC.CRM.ListContactView.noContacts=false;if(ASC.CRM.ListContactView.Total===0){ASC.CRM.ListContactView.noContactsForQuery=true}else{ASC.CRM.ListContactView.noContactsForQuery=false}}if(ASC.CRM.ListContactView.noContacts){jq("#emptyContentForContactsFilter").hide();jq("#mainContactList").hide();jq("#contactsEmptyScreen").show();jq.unblockUI();return}if(ASC.CRM.ListContactView.noContactsForQuery){jq("#companyListBox").hide();jq("#mainSelectAll").attr("disabled",true);jq("#mainExportCsv").next("img").hide();jq("#mainExportCsv").hide();jq("#contactsEmptyScreen").hide();jq("#emptyContentForContactsFilter").show();jq.unblockUI();return}if(jq("#companyTable tbody tr").length==0){jq.unblockUI();var y=ASC.CRM.ListContactView.entryCountOnPage*(contactPageNavigator.CurrentPageNumber-1);if(y>=ASC.CRM.ListContactView.Total){y-=ASC.CRM.ListContactView.entryCountOnPage}ASC.CRM.ListContactView.renderContent(y)}else{jq.unblockUI()}},add_tag:function(j,i){jq("#addTagDialog").hide();if(j.isNewTag){var k={value:j.tagName,title:j.tagName};contactTags.push(k);ASC.CRM.ListContactView.advansedFilter=ASC.CRM.ListContactView.advansedFilter.advansedFilter({filters:[{id:"tags",options:contactTags,enable:contactTags.length>0}]})}},addNewTask:function(l,m){var k=0;for(var j=0;j<ASC.CRM.ListContactView.fullContactList.length;j++){if(l.contactid==ASC.CRM.ListContactView.fullContactList[j].id){ASC.CRM.ListContactView.fullContactList[j].nearTask=m;k=j}}jq("#contactItem_"+l.contactid).replaceWith(jq("#contactTmpl").tmpl(ASC.CRM.ListContactView.fullContactList[k]));ASC.CRM.Common.tooltip("#taskTitle_"+m.id,"tooltip",true);ASC.CRM.Common.RegisterContactInfoCard();PopupKeyUpActionProvider.EnableEsc=true;jq.unblockUI();taskContactSelector.SelectedContacts=new Array()},render_simple_content:function(j,i){jq(window).trigger("getContactsFromApi",[i]);jq("#simpleContactTmpl").tmpl(i).prependTo("#contactTable tbody");ASC.CRM.Common.RegisterContactInfoCard();LoadingBanner.hideLoading()},removeMember:function(j,i){jq("#contactItem_"+j.contactID).remove()},addMember:function(j,i){jq("#simpleContactTmpl").tmpl(i).prependTo("#contactTable tbody");ASC.CRM.Common.RegisterContactInfoCard()},update_contact_rights:function(o,l){for(var m=0;m<l.length;m++){for(var n=0;n<ASC.CRM.ListContactView.fullContactList.length;n++){if(l[m].id==ASC.CRM.ListContactView.fullContactList[n].id){var k=l[m].id;ASC.CRM.ListContactView.fullContactList[n].isPrivate=l[m].isPrivate;jq("#contactItem_"+k).replaceWith(jq("#contactTmpl").tmpl(ASC.CRM.ListContactView.fullContactList[n]));if(o.isBatch){jq("#check_contact_"+k).attr("checked",true)}else{ASC.CRM.ListContactView.selectedItems=new Array()}if(ASC.CRM.ListContactView.fullContactList[n].nearTask&&ASC.CRM.ListContactView.fullContactList[n].nearTask!=null){ASC.CRM.Common.tooltip("#taskTitle_"+ASC.CRM.ListContactView.fullContactList[n].nearTask.id,"tooltip",false)}break}}}ASC.CRM.Common.RegisterContactInfoCard();jq.unblockUI()}},fullContactList:new Array(),contactID:new Array(),isFirstTime:true,selectedItems:new Array(),currentUser:"",currentUserID:"",currentUserIsAdmin:false,entryCountOnPage:0,currentPageNumber:1,emailQuotas:0,noContacts:false,noContactsForQuery:false,cookieKey:"",init:function(p,l,m,r,q,n,j,i){ASC.CRM.ListContactView.currentUser=r;ASC.CRM.ListContactView.currentUserID=q;ASC.CRM.ListContactView.currentUserIsAdmin=n;ASC.CRM.ListContactView.entryCountOnPage=p;ASC.CRM.ListContactView.currentPageNumber=l;ASC.CRM.ListContactView.emailQuotas=m;ASC.CRM.ListContactView.cookieKey=j;LoadingBanner.displayLoading();var k=location.hash;k=k&&typeof k==="string"&&k.charAt(0)==="#"?k.substring(1):k;if(k==""||decodeURIComponent(i)==k){ASC.CRM.ListContactView.isFirstTime=true}else{ASC.CRM.ListContactView.isFirstTime=false}contactPageNavigator.NavigatorParent="#divForContactPager";contactPageNavigator.changePageCallback=function(s){ASC.CRM.ListContactView.currentPageNumber=s;f(s,contactPageNavigator.EntryCountOnPage);var t=contactPageNavigator.EntryCountOnPage*(s-1);ASC.CRM.ListContactView.renderContent(t)};jq("#contactActionMenu").show();var o=jq("#contactActionMenu .dropDownCornerRight").position().left;jq("#contactActionMenu").hide();jq.dropdownToggle({dropdownID:"contactActionMenu",switcherSelector:"#companyTable .crm-menu",addTop:4,addLeft:-o+6,showFunction:function(t,s){jq("#companyTable .crm-menu.active").removeClass("active");if(s.is(":hidden")){t.addClass("active")}},hideFunction:function(){jq("#companyTable .crm-menu.active").removeClass("active")}});jq(window).scroll(function(){ASC.CRM.Common.stickMenuToTheTop({menuSelector:"#contactsHeaderMenu",menuAnchorSelector:"#mainSelectAll",menuSpacerSelector:"#contactsHeaderMenuSpacer",userFuncInTop:function(){jq("#onTop").hide()},userFuncNotInTop:function(){jq("#onTop").show()}})});if(!jq.browser.mobile){ASC.CRM.FileUploader.OnAllUploadCompleteCallback_function=function(){jq("#sendEmailPanel").hide();jq("#sendProcessPanel").show();ASC.CRM.ListContactView.changePageTitle(pageTitles.mailSend);var s=new Array();for(var t=0,u=ASC.CRM.ListContactView.selectedItems.length;t<u;t++){if(ASC.CRM.ListContactView.selectedItems[t].primaryEmail!=null){s.push(ASC.CRM.ListContactView.selectedItems[t].id)}}var x=jq.format("<div style='color:#787878;font-size:12px;margin-top:10px'>{0}</div>",jq.format(CRMJSResources.TeamlabWatermark,jq.format("<a style='color:#787878;font-size:12px;' href='http://www.teamlab.com'>{0}</a>","Teamlab.com")));var w=jq("#sendEmailPanel #tbxEmailSubject").val().trim();if(w==""){w=CRMJSResources.NoSubject}var v=jq("#storeInHistory").is(":checked");AjaxPro.ListContactView.SendEmail(ASC.CRM.FileUploader.fileIDs,s,w,ASC.CRM.ListContactView._fckEditor.GetHTML()+x,v,function(y){if(y.error!=null){alert(y.error.Message);return}ASC.CRM.ListContactView.checkSendStatus(true)})}}},isEnterKeyPressed:function(i){return i.keyCode==13},isEmailValid:function(i){var j=new RegExp("^[-a-z0-9!#$%&'*+/=?^_`{|}~]+(?:.[-a-z0-9!#$%&'*+/=?^_`{|}~]+)*@(?:[a-z0-9]([-a-z0-9]{0,61}[a-z0-9])?.)*(?:aero|arpa|asia|biz|cat|com|coop|edu|gov|info|int|jobs|mil|mobi|museum|name|net|org|pro|tel|travel|[a-z][a-z])$","i");if(i==""||!j.test(i)){return false}return true},getFilterSettings:function(){var j={sortBy:"displayName",sortOrder:"ascending",tags:[]};if(ASC.CRM.ListContactView.advansedFilter.advansedFilter==null){return j}var i=ASC.CRM.ListContactView.advansedFilter.advansedFilter();jq(i).each(function(k,l){switch(l.id){case"sorter":j.sortBy=l.params.id;j.sortOrder=l.params.dsc==true?"descending":"ascending";break;case"text":j.filterValue=l.params.value;break;default:if(l.hasOwnProperty("apiparamname")&&l.params.hasOwnProperty("value")&&l.params.value!=null){j[l.apiparamname]=l.params.value}break}});return j},changeFilter:function(){if(ASC.CRM.ListContactView.isFirstTime==true){ASC.CRM.ListContactView.isFirstTime=false;if(typeof(contactsForFirstRequest)!="undefined"){contactsForFirstRequest=jq.parseJSON(jQuery.base64.decode(contactsForFirstRequest))}else{contactsForFirstRequest=[]}var i=ASC.CRM.ListContactView.entryCountOnPage*(ASC.CRM.ListContactView.currentPageNumber-1);ASC.CRM.ListContactView.CallbackMethods.get_contacts_by_filter({__startIndex:i,__nextIndex:contactsForFirstRequest.nextIndex,__total:contactsForFirstRequest.total},Teamlab.create("crm-contacts",null,contactsForFirstRequest.response));return}f(0,contactPageNavigator.EntryCountOnPage);ASC.CRM.ListContactView.deselectAll();ASC.CRM.ListContactView.renderContent(0)},renderContent:function(i){ASC.CRM.ListContactView.fullContactList=new Array();LoadingBanner.displayLoading();jq("#mainSelectAll").attr("checked",false);ASC.CRM.ListContactView.getContacts(i)},addRecordsToContent:function(){if(!ASC.CRM.ListContactView.showMore){return false}jq("#showMoreContactsButtons .crm-showMoreLink").hide();jq("#showMoreContactsButtons .crm-loadingLink").show();var i=jq("#companyTable tbody tr").length;ASC.CRM.ListContactView.getContacts(i)},getContacts:function(j){var i=ASC.CRM.ListContactView.getFilterSettings();if(typeof j=="undefined"){i.StartIndex=0}else{i.StartIndex=j}i.Count=ASC.CRM.ListContactView.entryCountOnPage;EventTracker.Track("crm_search_contacts_by_filter");Teamlab.getCrmContacts({},{filter:i,success:ASC.CRM.ListContactView.CallbackMethods.get_contacts_by_filter})},getNearestTasks:function(j){var p={contacts:j};var l=new Array();for(var m=0,o=ASC.CRM.ListContactView.fullContactList.length;m<o;m++){l.push(ASC.CRM.ListContactView.fullContactList[m].id)}var k={contactid:l};Teamlab.getCrmContactTasks(p,k,{success:ASC.CRM.ListContactView.CallbackMethods.get_nearest_tasks})},changeCountOfRows:function(j){if(isNaN(j)){return}var i=j*1;ASC.CRM.ListContactView.entryCountOnPage=i;contactPageNavigator.EntryCountOnPage=i;f(1,i);ASC.CRM.ListContactView.renderContent(0)},selectAll:function(l){if(jq(l).is(":checked")){ASC.CRM.ListContactView.selectedItems=new Array();for(var j=0,k=ASC.CRM.ListContactView.fullContactList.length;j<k;j++){ASC.CRM.ListContactView.selectedItems.push({id:ASC.CRM.ListContactView.fullContactList[j].id,isCompany:ASC.CRM.ListContactView.fullContactList[j].isCompany,primaryEmail:ASC.CRM.ListContactView.fullContactList[j].primaryEmail,displayName:ASC.CRM.ListContactView.fullContactList[j].displayName})}jq("#companyTable input:checkbox").attr("checked",true);jq("#checkedContactsCount > span").text(jq.format(CRMJSResources.ElementsSelectedCount,ASC.CRM.ListContactView.selectedItems.length));jq("#checkedContactsCount").show();jq("#companyTable tr").addClass("selectedRow");c()}else{ASC.CRM.ListContactView.deselectAll()}},selectItem:function(o){var k=parseInt(jq(o).attr("id").split("_")[2]);var p=null;for(var j=0,m=ASC.CRM.ListContactView.fullContactList.length;j<m;j++){if(k==ASC.CRM.ListContactView.fullContactList[j].id){p={id:ASC.CRM.ListContactView.fullContactList[j].id,isCompany:ASC.CRM.ListContactView.fullContactList[j].isCompany,primaryEmail:ASC.CRM.ListContactView.fullContactList[j].primaryEmail,displayName:ASC.CRM.ListContactView.fullContactList[j].displayName}}}var q=new Array();for(var j=0,m=ASC.CRM.ListContactView.selectedItems.length;j<m;j++){q.push(ASC.CRM.ListContactView.selectedItems[j].id)}var l=jq.inArray(k,q);if(jq(o).is(":checked")){jq("#contactItem_"+k).addClass("selectedRow");if(l==-1){ASC.CRM.ListContactView.selectedItems.push(p)}}else{jq("#mainSelectAll").attr("checked",false);jq("#contactItem_"+k).removeClass("selectedRow");if(l!=-1){ASC.CRM.ListContactView.selectedItems.splice(l,1)}}c();if(ASC.CRM.ListContactView.selectedItems.length!=0){jq("#checkedContactsCount > span").text(jq.format(CRMJSResources.ElementsSelectedCount,ASC.CRM.ListContactView.selectedItems.length));jq("#checkedContactsCount").show()}else{jq("#checkedContactsCount > span").text("");jq("#checkedContactsCount").hide()}},deselectAll:function(){ASC.CRM.ListContactView.selectedItems=new Array();jq("#companyTable input:checkbox").attr("checked",false);jq("#mainSelectAll").attr("checked",false);jq("#companyTable tr.selectedRow").removeClass("selectedRow");jq("#checkedContactsCount > span").text("");jq("#checkedContactsCount").hide();e()},showDeletePanel:function(){var m=false;var n=false;jq("#deleteList dd.confirmRemoveCompanies, dd.confirmRemovePersons").html("");for(var j=0,l=ASC.CRM.ListContactView.selectedItems.length;j<l;j++){if(ASC.CRM.ListContactView.selectedItems[j].isCompany){m=true;var k=jq("<label></label>").attr("title",ASC.CRM.ListContactView.selectedItems[j].displayName).text(ASC.CRM.ListContactView.selectedItems[j].displayName);jq("#deleteList dd.confirmRemoveCompanies").append(k.prepend(jq("<input>").attr("type","checkbox").attr("checked",true).attr("id","company_"+ASC.CRM.ListContactView.selectedItems[j].id)))}else{n=true;var k=jq("<label></label>").attr("title",ASC.CRM.ListContactView.selectedItems[j].displayName).text(ASC.CRM.ListContactView.selectedItems[j].displayName);jq("#deleteList dd.confirmRemovePersons").append(k.prepend(jq("<input>").attr("type","checkbox").attr("checked",true).attr("id","person_"+ASC.CRM.ListContactView.selectedItems[j].id)))}}if(m){jq("#deleteList dt.confirmRemoveCompanies, dd.confirmRemoveCompanies").show()}else{jq("#deleteList dt.confirmRemoveCompanies, dd.confirmRemoveCompanies").hide()}if(n){jq("#deleteList dt.confirmRemovePersons, dd.confirmRemovePersons").show()}else{jq("#deleteList dt.confirmRemovePersons, dd.confirmRemovePersons").hide()}jq("#deletePanel div.action-block").show();jq("#deletePanel div.info-block").hide();ASC.CRM.Common.blockUI("#deletePanel",500,500,0)},deleteBatchContacts:function(){var i=new Array();jq("#deletePanel input:checked").each(function(){i.push(parseInt(jq(this).attr("id").split("_")[1]))});var j={contactIDsForDelete:i};Teamlab.removeCrmContact(j,i,{success:ASC.CRM.ListContactView.CallbackMethods.delete_batch_contacts,before:function(k){jq("#deletePanel div.action-block").hide();jq("#deletePanel div.info-block").show()},after:function(k){jq("#deletePanel div.action-block").show();jq("#deletePanel div.info-block").hide()}})},showSetPermissionsPanel:function(i){if(jq("#setPermissionsPanel div.tintMedium").length>0){jq("#setPermissionsPanel div.tintMedium span.headerBase").remove();jq("#setPermissionsPanel div.tintMedium").removeClass("tintMedium").css("padding","0px")}jq("#isPrivate").attr("checked",false);changeIsPrivateCheckBox();jq("#selectedUsers div.selectedUser[id^=selectedUser_]").remove();SelectedUsers.IDs=new Array();jq("#setPermissionsPanel div.action-block").show();jq("#setPermissionsPanel div.info-block").hide();jq("#setPermissionsPanel .setPermissionsLink").unbind("click").bind("click",function(){ASC.CRM.ListContactView.setPermissions(i)});ASC.CRM.Common.blockUI("#setPermissionsPanel",600,500,0)},setPermissions:function(m){var p=SelectedUsers.IDs;p.push(SelectedUsers.CurrentUserID);var o=new Array();for(var k=0,l=ASC.CRM.ListContactView.selectedItems.length;k<l;k++){o.push(ASC.CRM.ListContactView.selectedItems[k].id)}var j={contactid:o,isPrivate:jq("#isPrivate").is(":checked"),accessList:p};Teamlab.updateCrmContactRights(m,j,{success:ASC.CRM.ListContactView.CallbackMethods.update_contact_rights,before:function(){jq("#setPermissionsPanel div.action-block").hide();jq("#setPermissionsPanel div.info-block").show()},after:function(){jq("#setPermissionsPanel div.action-block").show();jq("#setPermissionsPanel div.info-block").hide()}})},showActionMenu:function(l,p,n,r,m){var k=CRMJSResources.AddNewPhone;var j=CRMJSResources.AddNewEmail;var s=null;var r=null;for(var o=0,q=ASC.CRM.ListContactView.fullContactList.length;o<q;o++){if(l==ASC.CRM.ListContactView.fullContactList[o].id){if(ASC.CRM.ListContactView.fullContactList[o].primaryPhone!=null){k=CRMJSResources.EditPhone;s=ASC.CRM.ListContactView.fullContactList[o].primaryPhone}if(ASC.CRM.ListContactView.fullContactList[o].primaryEmail!=null){j=CRMJSResources.EditEmail;r=ASC.CRM.ListContactView.fullContactList[o].primaryEmail}break}}jq("#contactActionMenu .addTaskLink").unbind("click").bind("click",function(){jq("#contactActionMenu").hide();jq("#taskActionMenu").hide();jq("#companyTable .crm-menu.active").removeClass("active");ASC.CRM.ListContactView.showTaskPanel(l)});jq("#contactActionMenu .addDealLink").attr("href",jq.format("deals.aspx?action=manage&contactID={0}",l));jq("#contactActionMenu .addCaseLink").attr("href",jq.format("cases.aspx?action=manage&contactID={0}",l));jq("#contactActionMenu .addPhoneLink").text(k);jq("#contactActionMenu .addPhoneLink").unbind("click").bind("click",function(){jq("#contactActionMenu").hide();jq("#companyTable .crm-menu.active").removeClass("active");h(l,s)});jq("#contactActionMenu .addEmailLink").text(j);jq("#contactActionMenu .addEmailLink").unbind("click").bind("click",function(){jq("#contactActionMenu").hide();jq("#companyTable .crm-menu.active").removeClass("active");g(l,r)});jq("#contactActionMenu .editContactLink").attr("href",jq.format("default.aspx?id={0}&action=manage{1}",l,!p?"&type=people":""));jq("#contactActionMenu .deleteContactLink").unbind("click").bind("click",function(){jq("#contactActionMenu").hide();jq("#companyTable .crm-menu.active").removeClass("active");if(ASC.CRM.ContactActionView.confirmForDelete(p,decodeURI(n))){var i=new Array();i.push(l);var t={contactIDsForDelete:i};Teamlab.removeCrmContact(t,i,{success:ASC.CRM.ListContactView.CallbackMethods.delete_batch_contacts,before:function(u){jq("#contactActionMenu").hide()},after:function(u){}})}});jq("#contactActionMenu .showProfileLink").attr("href",jq.format("default.aspx?id={0}{1}",l,!p?"&type=people":""));if(ASC.CRM.ListContactView.currentUserIsAdmin||ASC.CRM.ListContactView.currentUserID==m){jq("#contactActionMenu .setPermissionsLink").show();jq("#contactActionMenu .setPermissionsLink").unbind("click").bind("click",function(){jq("#contactActionMenu").hide();jq("#companyTable .crm-menu.active").removeClass("active");ASC.CRM.ListContactView.deselectAll();ASC.CRM.ListContactView.selectedItems.push({id:l,isCompany:p,primaryEmail:r,displayName:n});ASC.CRM.ListContactView.showSetPermissionsPanel({isBatch:false})})}else{jq("#contactActionMenu .setPermissionsLink").hide()}},initTaskPanel:function(m){jq("#tbxTitle").val("");jq("#tbxDescribe").val("");taskResponsibleSelector.ClearFilter();taskResponsibleSelector.ChangeDepartment(taskResponsibleSelector.Groups[0].ID);var r;if(!jq.browser.mobile){r=document.getElementById("User_"+ASC.CRM.ListContactView.currentUserID);if(r!=null){taskResponsibleSelector.SelectUser(r)}}else{r=jq("#taskResponsibleSelector select option[value="+ASC.CRM.ListContactView.currentUserID+"]");if(r.length>0){taskResponsibleSelector.SelectUser(r);jq(r).attr("selected",true)}}jq("#taskDeadline").datepicker("setDate",new Date());jq("#optDeadlineHours_-1").attr("selected",true);jq("#optDeadlineMinutes_-1").attr("selected",true);r=taskCategorySelector.getRowByContactID(0);taskCategorySelector.changeContact(r);var p=0;for(var o=0;o<ASC.CRM.ListContactView.fullContactList.length;o++){if(ASC.CRM.ListContactView.fullContactList[o].id==m){p=o}}taskContactSelector.SelectedContacts=new Array();taskContactSelector.setContact(jq("#contactTitle_taskContactSelector_0"),ASC.CRM.ListContactView.fullContactList[p].id,Encoder.htmlEncode(ASC.CRM.ListContactView.fullContactList[p].displayName),ASC.CRM.ListContactView.fullContactList[p].smallFotoUrl);taskContactSelector.showInfoContent(jq("#contactTitle_taskContactSelector_0"));if(ASC.CRM.ListContactView.fullContactList[p].isPrivate){var l=new Array();for(var o=0;o<taskResponsibleSelector.Groups.length;o++){for(var q=0;q<taskResponsibleSelector.Groups[o].Users.length;q++){l.push(taskResponsibleSelector.Groups[o].Users[q].ID)}}var k=new Array();for(var o=0;o<ASC.CRM.ListContactView.fullContactList[p].accessList.length;o++){k.push(ASC.CRM.ListContactView.fullContactList[p].accessList[o].id)}for(var o=0;o<adminList.length;o++){k.push(adminList[o].id)}for(var o=0;o<l.length;o++){var n=false;for(var q=0;q<k.length;q++){if(l[o]==k[q]){n=true}}if(!n){taskResponsibleSelector.HideUser(l[o])}}}else{taskResponsibleSelector.DisplayAll()}PopupKeyUpActionProvider.EnableEsc=false;HideRequiredError()},showTaskPanel:function(i){ASC.CRM.ListContactView.initTaskPanel(i);ASC.CRM.Common.blockUI("#addTaskPanel",650,600,0);jq("#addTaskPanel input[id$=tbxTitle]").focus();jq("#addTaskPanel a.baseLinkButton:first").unbind("click").bind("click",function(){ASC.CRM.ListContactView.addNewTask(i)})},addNewTask:function(i){var k=null;if(jq.trim(jq("#addTaskPanel input[id$=taskDeadline]").val())!=""){k=jq("#taskDeadline").datepicker("getDate");if(parseInt(jq("#taskDeadlineHours option:selected").val())!=-1){k.setHours(parseInt(jq("#taskDeadlineHours option:selected").val()))}else{k.setHours(0)}if(parseInt(jq("#taskDeadlineMinutes option:selected").val())!=-1){k.setMinutes(parseInt(jq("#taskDeadlineMinutes option:selected").val()))}else{k.setMinutes(0)}k=Teamlab.serializeTimestamp(k)}var j={id:0,title:jq("#tbxTitle").val(),description:jq("#tbxDescribe").val(),deadline:k,responsibleid:taskResponsibleSelector.SelectedUserId,categoryid:taskCategorySelector.CategoryID,isnotify:jq("#notifyResponsible").is(":checked"),contactid:i};var m=true;var l=(parseInt(jq("#taskDeadlineHours option:selected").val())==-1&&parseInt(jq("#taskDeadlineMinutes option:selected").val())!=-1)||(parseInt(jq("#taskDeadlineHours option:selected").val())!=-1&&parseInt(jq("#taskDeadlineMinutes option:selected").val())==-1);if(jq.trim(jq("#tbxTitle").val())==""){AddRequiredErrorText(jq("#tbxTitle"),CRMJSResources.EmptyTaskTitle);ShowRequiredError(jq("#tbxTitle"),true);m=false}else{RemoveRequiredErrorClass(jq("#tbxTitle"))}if(j.responsibleid==null){AddRequiredErrorText(jq("#addTaskPanel #inputUserName"),CRMJSResources.EmptyTaskResponsible);ShowRequiredError(jq("#addTaskPanel #inputUserName"),true);m=false}else{RemoveRequiredErrorClass(jq("#addTaskPanel #inputUserName"))}if(j.deadline==null||l){AddRequiredErrorText(jq("#taskDeadline"),CRMJSResources.EmptyTaskDeadline);ShowRequiredError(jq("#taskDeadline"),true);if(l){jq("#taskDeadlineHours").addClass("requiredInputError");jq("#taskDeadlineMinutes").addClass("requiredInputError")}else{jq("#taskDeadlineHours").removeClass("requiredInputError");jq("#taskDeadlineMinutes").removeClass("requiredInputError")}m=false}else{RemoveRequiredErrorClass(jq("#taskDeadline"));jq("#taskDeadlineHours").removeClass("requiredInputError");jq("#taskDeadlineMinutes").removeClass("requiredInputError")}if(!m){return false}Teamlab.addCrmTask({contactid:i},j,{success:ASC.CRM.ListContactView.CallbackMethods.addNewTask,before:function(n){jq("#addTaskPanel .action_block").hide();jq("#addTaskPanel .ajax_info_block").show()},after:function(n){jq("#addTaskPanel .ajax_info_block").hide();jq("#addTaskPanel .action_block").show()}})},showAddTagDialog:function(){jq("#addTagDialog div.dropDownContent").html("");jq("#addTagDialog input.textEdit").val("");for(var j=0;j<contactTags.length;j++){var k=jq("<a></a>").addClass("dropDownItem").text(contactTags[j].title).unbind("click").bind("click",function(){ASC.CRM.ListContactView.addTag(this)});jq("#addTagDialog div.dropDownContent").append(k)}jq.dropdownToggle().toggle("#mainAddTag","addTagDialog",5,0)},addTag:function(l){var p=jq(l).text();var o=new Array();for(var j=0,k=ASC.CRM.ListContactView.selectedItems.length;j<k;j++){o.push(ASC.CRM.ListContactView.selectedItems[j].id)}var m={contactIDs:o,tagName:p,isNewTag:false};Teamlab.addCrmTag(m,"contact",m.contactIDs,m.tagName,{success:ASC.CRM.ListContactView.CallbackMethods.add_tag,before:function(q){for(var n=0;n<q.contactIDs.length;n++){jq("#check_contact_"+q.contactIDs[n]).hide();jq("#loaderImg_"+q.contactIDs[n]).show()}},after:function(q){for(var n=0;n<q.contactIDs.length;n++){jq("#check_contact_"+q.contactIDs[n]).show();jq("#loaderImg_"+q.contactIDs[n]).hide()}}})},addNewTag:function(){var l=jq("#addTagDialog input").val().trim();if(l==""){return false}var o=new Array();for(var j=0,k=ASC.CRM.ListContactView.selectedItems.length;j<k;j++){o.push(ASC.CRM.ListContactView.selectedItems[j].id)}var m={contactIDs:o,tagName:l,isNewTag:true};Teamlab.addCrmTag(m,"contact",m.contactIDs,m.tagName,{success:ASC.CRM.ListContactView.CallbackMethods.add_tag,before:function(p){for(var n=0;n<p.contactIDs.length;n++){jq("#check_contact_"+p.contactIDs[n]).hide();jq("#loaderImg_"+p.contactIDs[n]).show()}},after:function(p){for(var n=0;n<p.contactIDs.length;n++){jq("#check_contact_"+p.contactIDs[n]).show();jq("#loaderImg_"+p.contactIDs[n]).hide()}}})},showSendEmailDialog:function(){jq.dropdownToggle().toggle("#mainSendEmail","sendEmailDialog",5,0)},showExportDialog:function(){jq.dropdownToggle().toggle("#mainExportCsv","exportDialog",7,-20)},showCreateLinkPanel:function(){var l=new Array();jq("#sendEmailDialog").hide();jq("#createLinkPanel #linkList").html("");jq("#cbxBlind").attr("checked",false);jq("#tbxBatchSize").val("10");jq.forceIntegerOnly("#tbxBatchSize");for(var j=0,k=ASC.CRM.ListContactView.selectedItems.length;j<k;j++){if(ASC.CRM.ListContactView.selectedItems[j].primaryEmail!=null){l.push(ASC.CRM.ListContactView.selectedItems[j].primaryEmail.data)}}jq("#createLinkPanel div.action-block a:first").unbind("click").bind("click",function(){ASC.CRM.ListContactView.createLink(l)});ASC.CRM.Common.blockUI("#createLinkPanel",500,500,0)},createLink:function(m){jq("#createLinkPanel #linkList").html("");jq("#createLinkPanel div.action-block").hide();jq("#createLinkPanel div.info-block").show();var k=jq("#cbxBlind").is(":checked")?"bcc=":"cc=";var j=jq("#tbxBatchSize").val().trim()==""?0:parseInt(jq("#tbxBatchSize").val().trim());var n="mailto:?";var r=new Array();var q=n;var l=0;var p="";if(ASC.CRM.ListContactView.selectedItems.length-m.length>0){p=jq.format(CRMJSResources.GenerateLinkInfo,jq.format(CRMJSResources.RecipientsWithoutEmail,ASC.CRM.ListContactView.selectedItems.length-m.length))}else{p=jq.format(CRMJSResources.GenerateLinkInfo,"")}jq("#createLinkPanel #linkList").append(jq("<div></div>").text(p).addClass("headerPanel-splitter"));if(m.length==1){r.push(jq.format("mailto:{0}",m[0]))}else{if(j==1){for(var o=0;o<m.length;o++){r.push(jq.format("mailto:{0}",m[o]))}}else{for(var o=0;o<m.length;o++){q+=k+m[o]+"&";l++;if(j!=0&&l==j){l=0;r.push(q.substring(0,q.length-1));q=n}if(o==m.length-1&&m.length%j!=0){r.push(q.substring(0,q.length-1))}}}}for(var o=0;o<r.length;o++){l=o+1;jq("#linkList").append(jq("<a></a>").text(CRMJSResources.Batch+" "+l).attr("href",r[o]));if(o!=r.length-1){jq("#linkList").append(jq("<span><span/>").addClass("splitter").text(","))}}jq("#createLinkPanel div.action-block").show();jq("#createLinkPanel div.info-block").hide();jq("#linkList").show()},initSMTPSettingsPanel:function(){jq.forceIntegerOnly("#tbxPort");jq("#smtpSettingsContent div.errorBox").remove();jq("#smtpSettingsContent div.okBox").remove();if(smtpSettings!=null){jq("#tbxHost").val(smtpSettings.Host);jq("#tbxPort").val(smtpSettings.Port);jq("#tbxHostLogin").val(smtpSettings.HostLogin);jq("#tbxHostPassword").val(smtpSettings.HostPassword);jq("#tbxSenderDisplayName").val(smtpSettings.SenderDisplayName);jq("#tbxSenderEmailAddress").val(smtpSettings.SenderEmailAddress);jq("#cbxEnableSSL").attr("checked",smtpSettings.EnableSSL);if(smtpSettings.RequiredHostAuthentication){jq("#cbxAuthentication").attr("checked",true);jq("#tbxHostLogin").removeAttr("disabled");jq("#tbxHostPassword").removeAttr("disabled")}else{jq("#cbxAuthentication").attr("checked",false);jq("#tbxHostLogin").attr("disabled",true);jq("#tbxHostPassword").attr("disabled",true)}}},changeAuthentication:function(){if(jq("#cbxAuthentication").is(":checked")){jq("#tbxHostLogin").removeAttr("disabled");jq("#tbxHostPassword").removeAttr("disabled")}else{jq("#tbxHostLogin").attr("disabled",true);jq("#tbxHostPassword").attr("disabled",true)}},checkSMTPSettings:function(){if(smtpSettings==null){return false}if(smtpSettings.RequiredHostAuthentication){if(smtpSettings.Host==""||smtpSettings.Port==""||smtpSettings.HostLogin==""||smtpSettings.HostPassword==""||smtpSettings.SenderDisplayName==""||smtpSettings.SenderEmailAddress==""){return false}}if(!smtpSettings.RequiredHostAuthentication){if(smtpSettings.Host==""||smtpSettings.Port==""||smtpSettings.SenderDisplayName==""||smtpSettings.SenderEmailAddress==""){return false}}return true},saveSMTPSettings:function(o){jq("#smtpSettingsContent div.errorBox").remove();jq("#smtpSettingsContent div.okBox").remove();var k=jq("#tbxHost").val().trim();var p=jq("#tbxPort").val().trim();var i=jq("#cbxAuthentication").is(":checked");var l=jq("#tbxHostLogin").val().trim();var m=jq("#tbxHostPassword").val().trim();var q=jq("#tbxSenderDisplayName").val().trim();var r=jq("#tbxSenderEmailAddress").val().trim();var j=jq("#cbxEnableSSL").is(":checked");var n=true;if(i&&(k==""||p==""||l==""||m==""||q==""||r=="")){n=false}if(!i&&(k==""||p==""||q==""||r=="")){n=false}if(!n){jq("#smtpSettingsContent").prepend(jq("<div></div>").addClass("errorBox").text(CRMJSResources.EmptyFieldsOfSettings));return}AjaxPro.onLoading=function(s){if(s){}else{}};AjaxPro.CommonSettingsView.SaveSMTPSettings(k,p,i,l,m,q,r,j,function(s){if(s.error!=null){jq("#smtpSettingsContent").prepend(jq("<div></div>").addClass("errorBox").text(s.error.Message));return}smtpSettings={};smtpSettings.Host=k;smtpSettings.Port=p;smtpSettings.RequiredHostAuthentication=i;smtpSettings.HostLogin=l;smtpSettings.HostPassword=m;smtpSettings.SenderDisplayName=q;smtpSettings.SenderEmailAddress=r;smtpSettings.EnableSSL=j;jq("#smtpSettingsContent div.errorBox").remove();jq("#smtpSettingsContent").prepend(jq("<div></div>").addClass("okBox").text(CRMJSResources.SettingsUpdated));setTimeout(function(){jq("#smtpSettingsContent div.okBox").remove();if(!jq.browser.mobile){ASC.CRM.ListContactView.showSendEmailPanel(o)}else{ASC.CRM.ListContactView.showSendEmailPanel()}jq.unblockUI()},1000)})},showSendEmailPanel:function(l){var m=new Array();for(var j=0,k=ASC.CRM.ListContactView.selectedItems.length;j<k;j++){if(ASC.CRM.ListContactView.selectedItems[j].primaryEmail!=null){var o={};o.primaryEmail=ASC.CRM.ListContactView.selectedItems[j].primaryEmail.data;o.title=ASC.CRM.ListContactView.selectedItems[j].displayName;o.id=ASC.CRM.ListContactView.selectedItems[j].id;m.push(o)}}if(m.length>ASC.CRM.ListContactView.emailQuotas){alert(jq.format(CRMJSResources.ErrorEmailRecipientsCount,ASC.CRM.ListContactView.emailQuotas));return false}AjaxPro.onLoading=function(i){};jq("#sendEmailDialog").hide();if(!ASC.CRM.ListContactView.checkSMTPSettings()){ASC.CRM.ListContactView.initSMTPSettingsPanel();ASC.CRM.Common.blockUI("#smtpSettingsPanel",500,500,0);return false}AjaxPro.ListContactView.GetStatus(function(i){if(i.error!=null){alert(i.error.Message);return}if(i.value==null||i.value.IsCompleted){jq("#sendEmailPanel #emailFromLabel").text(jq.format("{0} ({1})",smtpSettings.SenderDisplayName,smtpSettings.SenderEmailAddress));jq("#sendEmailPanel #previewEmailFromLabel").text(jq.format("{0} ({1})",smtpSettings.SenderDisplayName,smtpSettings.SenderEmailAddress));if(!jq.browser.mobile){if(typeof ASC.CRM.ListContactView._fckEditor=="undefined"){ASC.CRM.ListContactView._fckEditor=l}ASC.CRM.ListContactView._fckEditor.Config.ToolbarSets.Email=[["Source"],["Undo","Redo"],["Bold","Italic","Underline","StrikeThrough"],["Link","Unlink"],["TextColor","BGColor"],["FontSize","FontName"],["Smiley"],["UnorderedList","OrderedList"],["JustifyLeft","JustifyCenter","JustifyRight"]];ASC.CRM.ListContactView._fckEditor.ToolbarSet.Load("Email");ASC.CRM.FileUploader.activateUploader();ASC.CRM.FileUploader.fileIDs.clear()}jq("#tbxEmailSubject").val("");if(!jq.browser.mobile){ASC.CRM.ListContactView._fckEditor.SetHTML("<br />")}else{jq("#mobileMessageBody").val("")}jq("#storeInHistory").attr("checked",false);jq("#sendEmailPanel div.action-block #sendButton").text(CRMJSResources.NextPreview).unbind("click").bind("click",function(){ASC.CRM.ListContactView.showSendEmailPanelPreview(m)});jq("#sendEmailPanel div.action-block #backButton a.baseLinkButton").unbind("click").bind("click",function(){ASC.CRM.ListContactView.showSendEmailPanelCreate(m)});AjaxPro.AjaxProHelper.ChooseNumeralCase(m.length,CRMJSResources.AddressNominative,CRMJSResources.AddressGenitiveSingular,CRMJSResources.AddressGenitivePlural,function(n){if(n.error!=null){alert(n.error.Message);return}jq("#emailAddresses").html(jq.format("{0} {1}",m.length,n.value));jq("#previewEmailAddresses").html(jq.format("{0} {1}",m.length,n.value));jq("#mainContactList").hide();jq("#sendEmailPanel").show();jq("#sendEmailPanel #createContent").show();ASC.CRM.ListContactView.changePageTitle(pageTitles.composeMail);jq("#sendEmailPanel #previewContent").hide();jq("#sendProcessPanel").hide()})}else{ASC.CRM.ListContactView.checkSendStatus(true)}})},closeSendEmailPanel:function(){jq("#mainContactList").show();ASC.CRM.ListContactView.changePageTitle(pageTitles.contacts);jq("#sendEmailPanel").hide();jq("#sendProcessPanel").hide();jq("#sendEmailPanel #tbxEmailSubject").val("");if(!jq.browser.mobile){ASC.CRM.ListContactView._fckEditor.SetHTML("<br />")}else{jq("#mobileMessageBody").val("")}jq("#sendEmailPanel div.action-block #backButton").hide()},showSendEmailPanelCreate:function(i){jq("#sendEmailPanel #createContent").show();ASC.CRM.ListContactView.changePageTitle(pageTitles.composeMail);jq("#sendEmailPanel #previewContent").hide();jq("#sendProcessPanel").hide();jq("#sendEmailPanel div.action-block #backButton").hide();jq("#sendEmailPanel div.action-block #sendButton").text(CRMJSResources.NextPreview).unbind("click").bind("click",function(){ASC.CRM.ListContactView.showSendEmailPanelPreview(i)})},showSendEmailPanelPreview:function(j){AjaxPro.onLoading=function(l){if(l){jq("#sendEmailPanel div.action-block").hide();jq("#sendEmailPanel div.info-block").show()}else{jq("#sendEmailPanel div.action-block").show();jq("#sendEmailPanel div.info-block").hide()}};var i="";if(!jq.browser.mobile){i=ASC.CRM.ListContactView._fckEditor.GetHTML();if(i=="<br />"){AddRequiredErrorText(jq("#requiredMessageBody"),CRMJSResources.EmptyLetterBodyContent);ShowRequiredError(jq("#requiredMessageBody"),true);return false}else{RemoveRequiredErrorClass(jq("#requiredMessageBody"))}}else{i=jq("#mobileMessageBody").val().trim();if(i==""){AddRequiredErrorText(jq("#requiredMessageBody"),CRMJSResources.EmptyLetterBodyContent);ShowRequiredError(jq("#requiredMessageBody"),true);return false}else{RemoveRequiredErrorClass(jq("#requiredMessageBody"))}}ASC.CRM.ListContactView.changePageTitle(pageTitles.previewMail);var k=jq("#sendEmailPanel #tbxEmailSubject").val().trim();if(k==""){k=CRMJSResources.NoSubject}AjaxPro.ListContactView.GetMessagePreview(i,j[0].id,function(m){if(m.error!=null){alert(m.error.Message);jq("#sendEmailPanel div.action-block").show();jq("#sendEmailPanel div.info-block").hide();return false}jq("#previewSubject").text(k);var n=jq.format("<div style='color:#787878;font-size:12px;margin-top:10px'>{0}</div>",jq.format(CRMJSResources.TeamlabWatermark,jq.format("<a style='color:#787878;font-size:12px;' href='http://www.teamlab.com'>{0}</a>","Teamlab.com")));jq("#previewMessage").html(m.value+n);if(!jq.browser.mobile){var l=jq("#history_uploadContainer div.studioFileUploaderFileName");jq("#previewAttachments span").html("");if(l.length>0){l.each(function(o){jq("#previewAttachments span").append(jq(this).text());if(o!=l.length-1){jq("#previewAttachments span").append(", ")}});jq("#previewAttachments").show()}else{jq("#previewAttachments").hide()}}jq("#sendProcessPanel").hide();jq("#sendEmailPanel #createContent").hide();jq("#sendEmailPanel #previewContent").show();jq("#sendEmailPanel div.action-block #backButton").show();jq("#sendEmailPanel div.action-block #sendButton").text(CRMJSResources.Send).unbind("click").bind("click",function(){ASC.CRM.ListContactView.sendEmail(j);EventTracker.Track("crm_send_mass_email")})})},sendEmail:function(m){AjaxPro.onLoading=function(i){};if(!jq.browser.mobile&&fileUploader.GetUploadFileCount()>0){jq("#"+fileUploader.ButtonID).css("visibility","hidden");jq("#pm_upload_btn_html5").hide();fileUploader.Submit()}else{var j=new Array();for(var k=0;k<m.length;k++){j.push(m[k].id)}var o=jq("#sendEmailPanel #tbxEmailSubject").val().trim();if(o==""){o=CRMJSResources.NoSubject}var p=jq.format("<div style='color:#787878;font-size:12px;margin-top:10px'>{0}</div>",jq.format(CRMJSResources.TeamlabWatermark,jq.format("<a style='color:#787878;font-size:12px;' href='http://www.teamlab.com'>{0}</a>","Teamlab.com")));var n=jq("#storeInHistory").is(":checked");var l="";if(!jq.browser.mobile){l=ASC.CRM.ListContactView._fckEditor.GetHTML()}else{l=jq("#mobileMessageBody").val().trim()}AjaxPro.ListContactView.SendEmail(new Array(),j,o,l+p,n,function(i){if(i.error!=null){alert(i.error.Message);return}ASC.CRM.ListContactView.checkSendStatus(true)})}},checkSendStatus:function(i){AjaxPro.onLoading=function(j){};jq("#mainContactList").hide();jq("#sendEmailPanel").hide();jq("#sendProcessPanel").show();jq("#sendProcessPanel #abortButton").show();jq("#sendProcessPanel #okButton").hide();if(i){jq("#sendProcessProgress div").css("width","0%");jq("#sendProcessProgress span").text("0%");jq("#emailsTotalCount").html("");jq("#emailsAlreadySentCount").html("");jq("#emailsEstimatedTime").html("");jq("#emailsErrorsCount").html("")}ASC.CRM.ListContactView.changePageTitle(pageTitles.mailSend);AjaxPro.ListContactView.GetStatus(function(j){if(j.error!=null){alert(j.error.Message);return}if(j.value==null){jq("#sendProcessProgress div").css("width","100%");jq("#sendProcessProgress span").text("100%");jq("#abortButton").hide();jq("#okButton").show();return}else{jq("#sendProcessProgress div").css("width",j.value.Percentage+"%");jq("#sendProcessProgress span").text(j.value.Percentage+"%");jq("#emailsAlreadySentCount").html(j.value.Status.DeliveryCount);jq("#emailsEstimatedTime").html(j.value.Status.EstimatedTime);jq("#emailsTotalCount").html(j.value.Status.RecipientCount);jq("#emailsErrorsCount").html("0")}if(j.value.Error!=null&&j.value.Error!=""){ASC.CRM.ListContactView.buildErrorList(j);jq("#abortButton").hide();jq("#okButton").show()}else{if(j.value.IsCompleted){jq("#abortButton").hide();jq("#okButton").show()}else{setTimeout("ASC.CRM.ListContactView.checkSendStatus(false)",3000)}}})},buildErrorList:function(j){var i="error";switch(typeof j.value.Error){case"object":i=j.value.Error.Message+"<br/>";break;case"string":i=j.value.Error;break}jq("#emailsErrorsCount").html(jq("<div></div>").addClass("redText").html(i)).append(jq("<a></a>").attr("href","settings.aspx?type=common").text(CRMJSResources.GoToSettings))},abortMassSend:function(){AjaxPro.onLoading=function(i){};AjaxPro.ListContactView.Cancel(function(i){if(i.error!=null){alert(i.error.Message);return}jq("#mainContactList").show();jq("#sendEmailPanel").hide();jq("#sendProcessPanel").hide();jq("#sendEmailPanel #tbxEmailSubject").val("");if(!jq.browser.mobile){ASC.CRM.ListContactView._fckEditor.SetHTML("<br />")}else{jq("#mobileMessageBody").val("")}jq("#sendEmailPanel div.action-block #backButton").hide();ASC.CRM.ListContactView.changePageTitle(pageTitles.contacts)})},changePageTitle:function(i){jq("div.mainContainerClass div.containerHeaderBlock table tbody tr td div").text(i)},emailInsertTag:function(){var j=jq("#emailTagTypeSelector option:selected").val()=="company";var m=j?jq("#emailCompanyTagSelector option:selected").val():jq("#emailPersonTagSelector option:selected").val();if(!jq.browser.mobile){ASC.CRM.ListContactView._fckEditor.InsertHtml(m)}else{var i=jq("#mobileMessageBody").caret().begin;var l=jq("#mobileMessageBody").val();var k=l.slice(0,i)+m+l.slice(i);jq("#mobileMessageBody").val(k)}},renderTagSelector:function(){var i=jq("#emailTagTypeSelector option:selected").val()=="company";if(i){jq("#emailPersonTagSelector").hide();jq("#emailCompanyTagSelector").show()}else{jq("#emailCompanyTagSelector").hide();jq("#emailPersonTagSelector").show()}},exportToCsv:function(){var k=window.location.href.indexOf("#");var j=k>=0?window.location.href.substr(0,k):window.location.href;var i=k>=0?window.location.href.substr(k,window.location.href.length):"";jq("#exportDialog").hide();window.location.href=j+"?action=export"+i},openExportFile:function(){var j=window.location.href.indexOf("#");var i=j>=0?window.location.href.substr(0,j):window.location.href;jq("#exportDialog").hide();window.open(i+"?action=export&view=editor")},renderSimpleContent:function(){if(typeof entityData!="undefined"&&entityData!=null&&entityData.id!=0){LoadingBanner.displayLoading();Teamlab.getCrmEntityMembers({},entityData.type,entityData.id,{success:ASC.CRM.ListContactView.CallbackMethods.render_simple_content})}},removeMember:function(i){Teamlab.removeCrmEntityMember({contactID:i},entityData.type,entityData.id,i,{before:function(j){jq("#trashImg_"+j.contactID).hide();jq("#loaderImg_"+j.contactID).show()},after:ASC.CRM.ListContactView.CallbackMethods.removeMember})},addMember:function(i){var j={contactid:i,personid:i,caseid:entityData.id,companyid:entityData.id,opportunityid:entityData.id};Teamlab.addCrmEntityMember({},entityData.type,entityData.id,i,j,{success:ASC.CRM.ListContactView.CallbackMethods.addMember})}}})();ASC.CRM.ContactDetailsView=(function(a){return{init:function(){if(!jq.browser.mobile){new AjaxUpload("changeLogo",{action:"ajaxupload.ashx?type=ASC.Web.CRM.Classes.ContactPhotoHandler,ASC.Web.CRM",autoSubmit:true,data:{contactID:jq.getURLParam("id")},onChange:function(n,i){if(jQuery.inArray("."+i,imgExst)==-1){alert(CRMJSResources.ErrorMessage_NotImageSupportFormat);return false}PopupKeyUpActionProvider.CloseDialog();jq(".under_logo #linkChangePhoto").hide();jq(".under_logo .ajax_info_block").show();return true},onComplete:function(i,q){var r=jq.evalJSON(q);if(!r.Success){alert(CRMJSResources.ErrorMessage_SaveImageError);jq(".under_logo .ajax_info_block").hide();jq(".under_logo #linkChangePhoto").show();return}var n=new Date();jq("#contactProfile .additionInfo .contact_photo").attr("src",jq.evalJSON(q).Data);jq(".under_logo .ajax_info_block").hide();jq(".under_logo #linkChangePhoto").show()},parentDialog:jq("#divLoadPhotoWindow"),isInPopup:true,name:"changeLogo"})}if(typeof(contactNetworks)!="undefined"&&contactNetworks!=""){var b;for(var h=0,k=contactNetworks.length;h<k;h++){if(contactNetworks[h].InfoType==7){var d=jq.parseJSON(Encoder.htmlDecode(contactNetworks[h].Data));var m=Encoder.htmlEncode(d.street);var o=d.city!=""?Encoder.htmlEncode(d.city)+", ":"";if(d.state!=""){o+=Encoder.htmlEncode(d.state)+", "}if(d.zip!=""){o+=Encoder.htmlEncode(d.zip)}o=o.trim();o=o.charAt(o.length-1)===","?o.substring(0,o.length-1):o;if(o!=""){m=m!=""?m+",<br/>"+o:o}m=m!=""&&d.country!=""?m+",<br/>"+d.country:m;var g="";if(d.street!=""){g+=Encoder.htmlEncode(d.street)+", "}if(d.city!=""){g+=Encoder.htmlEncode(d.city)+", "}if(d.state!=""){g+=Encoder.htmlEncode(d.state)+", "}if(d.zip!=""){g+=Encoder.htmlEncode(d.zip)+", "}if(d.country!=""){g+=d.country+", "}g=g.trim();g=g.charAt(g.length-1)===","?g.substring(0,g.length-1):g;var c=jq("#addressTmpl").tmpl();c.html(m);jq("#showOnMapAndAddressTypeTmpl").tmpl({value:g,category:contactNetworks[h].CategoryName}).appendTo(c);jq(c).appendTo(jq("#generalList dd.addressContainerDetails"));jq("#generalList .addressContainerDetails").removeClass("hiddenFields");continue}if(h==0||contactNetworks[h-1].InfoType!=contactNetworks[h].InfoType){var j=contactNetworks[h];b=jq("#collectionContainerTmpl").tmpl({Type:j.InfoTypeLocalName}).insertBefore(jq("#generalList dt.addressContainerDetails")).filter("dd");if(j.InfoType==2){if(j.Data.indexOf("://")==-1){j.Href="http://"+j.Data}else{j.Href=j.Data}}jq("#collectionTmpl").tmpl(j).appendTo(b)}else{var j=contactNetworks[h];if(j.InfoType==2){if(j.Data.indexOf("://")==-1){j.Href="http://"+j.Data}else{j.Href=j.Data}}jq("#collectionTmpl").tmpl(j).appendTo(b)}}}for(var h=0,k=customFieldList.length;h<k;h++){var f=customFieldList[h];if(jQuery.trim(f.mask)==""){continue}f.mask=jq.evalJSON(f.mask)}jq("#customFieldTmpl").tmpl(customFieldList).appendTo("#generalList");jq("#generalList dt.headerBase").each(function(i){var n=jq(this);if(n.next().nextUntil("dt.headerBase").length==0){n.next().remove();n.remove();return}if(i!=0){jq(this).click()}});var e=[];for(var h=0;h<sliderListItems.Items.length;h++){e[h]=sliderListItems.Items[h].Color}var p=[];p[0]="";var l=0;for(var h=0;h<sliderListItems.Items.length;h++){p[h+1]=sliderListItems.Items[h].Title;if(sliderListItems.Items[h].ID==sliderListItems.Status){l=h+1}}if(jq("#loyaltySliderDetails").length!=0){jq("#loyaltySliderDetails").sliderWithSections({value:l,values:p,max:sliderListItems.PositionsCount,colors:e,marginWidth:1,sliderOptions:{stop:function(i,n){if(n.value!=0){ASC.CRM.ContactDetailsView.changeStatus(sliderListItems.Items[n.value-1].ID)}else{ASC.CRM.ContactDetailsView.changeStatus(0)}}}})}if(jq("#listContactsToMerge").length!=0){jq("#listContactsToMerge input[type='radio']:first").attr("checked",true);jq("#listContactsToMerge #contactTitle").attr("disabled",true);jq("#listContactsToMerge input[type='radio']").click(function(){if(jq(this).is("#radioBtn_0")){jq("#listContactsToMerge #contactTitle").attr("disabled",false)}else{jq("#listContactsToMerge #contactTitle").attr("disabled",true)}})}},changeStatus:function(b){AjaxPro.onLoading=function(c){};AjaxPro.ContactDetailsView.ChangeStatus(sliderListItems.ID,b,function(c){if(c.error!=null){alert(c.message)}})},showMergePanel:function(c,b){jq("#mergePanel .infoPanel").hide();ASC.CRM.Common.blockUI("#mergePanel",400,400,0)},mergeContacts:function(b,c){var d=jq("#mergePanel input[name=contactToMerge]:checked").val()*1;if(d==0){if(typeof(contactToMergeSelector.SelectedContacts[0])=="undefined"){jq("#mergePanel .infoPanel > div").text(CRMJSResources.ErrorContactIsNotSelected);jq("#mergePanel .infoPanel").show();return}d=contactToMergeSelector.SelectedContacts[0]*1}jq("#mergePanel .action_block").hide();jq("#mergePanel div.ajax_info_block").show();AjaxPro.ContactDetailsView.MergeContacts(b,d,c=="true",function(e){if(e.error!=null){jq("#mergePanel .action_block").show();jq("#mergePanel div.ajax_info_block").hide();alert(e.error.Message);return}else{location.href=e.value}})},removePersonFromCompany:function(b){Teamlab.removeCrmEntityMember({contactID:b},entityData.type,entityData.id,b,{before:function(c){jq("#trashImg_"+c.contactID).hide();jq("#loaderImg_"+c.contactID).show()},after:function(d){var c=jq.inArray(d.contactID,contactSelector.SelectedContacts);contactSelector.SelectedContacts.splice(c,1);jq("#contactItem_"+d.contactID).animate({opacity:"hide"},500);setTimeout(function(){jq("#contactItem_"+d.contactID).remove();if(contactSelector.SelectedContacts.length==0){jq("#addPeopleButton").hide();jq("#peopleInCompanyPanel").hide();jq("#emptyPeopleInCompanyPanel").show()}},500)}})},addPersonToCompany:function(c){if(jq("#contactItem_"+c.id).length>0){return false}var b={personid:c.id,companyid:entityData.id};Teamlab.addCrmEntityMember({},entityData.type,entityData.id,c.id,b,{success:function(e,d){jq("#simpleContactTmpl").tmpl(d).prependTo("#contactTable tbody");ASC.CRM.Common.RegisterContactInfoCard();contactSelector.SelectedContacts.push(d.id);jq("#emptyPeopleInCompanyPanel").hide()}})}}})(jQuery);ASC.CRM.ContactActionView=(function(a){var j=false;var i={};this.ContactData=null;var g=function(o,t,p,w,q,v,x,r){if(jq("#addressContainer").children("div").length!=1){o.attr("style","margin-top: 10px;")}if(typeof(t)!="undefined"){c(o,t)}if(typeof(p)!="undefined"){var n=o.find("select.address_category").children('option[category="'+p+'"]');if(n.length==1){n.attr("selected","selected");b(o.find("select.address_category"),p)}}var u=jq("#addressContainer").children("div:last").attr("selectname").split("_");var s=u[2]*1+1;o.find("input, textarea, select").not(".address_category").each(function(){if(jq(this).attr("name")!=""){var y=jq(this).attr("name").split("_");y[2]=s;jq(this).attr("name",y.join("_"))}});var u=o.attr("selectname").split("_");u[2]=s;o.attr("selectname",u.join("_"));if(w&&w!=""){o.find("textarea.contact_street").val(w)}if(q&&q!=""){o.find("input.contact_city").val(q)}if(v&&v!=""){o.find("input.contact_state").val(v)}if(x&&x!=""){o.find("input.contact_zip").val(x)}if(r&&r!=""){o.find("select.contact_country").val(r)}o.find("textarea.contact_street").Watermark(CRMJSResources.AddressWatermark,ASC.CRM.ContactActionView.WatermarkClass);o.find("input.contact_city").Watermark(CRMJSResources.CityWatermark,ASC.CRM.ContactActionView.WatermarkClass);o.find("input.contact_state").Watermark(CRMJSResources.StateWatermark,ASC.CRM.ContactActionView.WatermarkClass);o.find("input.contact_zip").Watermark(CRMJSResources.ZipCodeWatermark,ASC.CRM.ContactActionView.WatermarkClass);o.find("select.contact_country").attr("name",o.attr("selectname"));jq('<option value="" style="display:none;"></option>').prependTo(o.find("select.contact_country"));return o};var c=function(n,p){var s=p?1:0;var r=p?"is_primary primary_field":"is_primary not_primary_field";var o=n.find(".is_primary");o.attr("class",r);o.attr("alt",CRMJSResources.Primary);o.attr("title",CRMJSResources.Primary);var q=n.attr("selectname").split("_");q[5]=s;n.attr("selectname",q.join("_"));n.find("input, textarea, select").not(".address_category").each(function(){var t=jq(this).attr("name").split("_");t[5]=s;jq(this).attr("name",t.join("_"))})};var e=function(n,q){var t=q?1:0;var s=q?"is_primary primary_field":"is_primary not_primary_field";var p=n.find(".is_primary");p.attr("class",s);p.attr("alt",CRMJSResources.Primary);p.attr("title",CRMJSResources.Primary);var o=n.find("input.textEdit");var r=o.attr("name").split("_");r[4]=t;o.attr("name",r.join("_"))};var d=function(p,r,o){jq(p).text(r);var n=jq(p).parents("tr:first").find("input");var q=n.attr("name").split("_");q[3]=o;n.attr("name",q.join("_"));jq("#baseCategoriesPanel").hide()};var f=function(p,r,o){jq(p).text(r);var n=jq(p).parents("tr:first").find("input");var q=n.attr("name").split("_");q[3]=o;n.attr("name",q.join("_"));jq("#phoneCategoriesPanel").hide()};var b=function(o,n){jq(o).parents("table:first").find("input, textarea, select").not(".address_category").each(function(){var p=jq(this).attr("name").split("_");p[3]=n;jq(this).attr("name",p.join("_"))})};var k=function(o){jq("#trashImg_"+o).hide();jq("#loaderImg_"+o).show();if(typeof(o)=="number"){var p=jq.inArray(o,assignedContactSelector.SelectedContacts);assignedContactSelector.SelectedContacts.splice(p,1)}else{for(var n=0;n<ASC.CRM.SocialMedia.selectedPersons.length;n++){if(ASC.CRM.SocialMedia.selectedPersons[n].id==o){ASC.CRM.SocialMedia.selectedPersons.splice(n,1);break}}}jq("#contactItem_"+o).animate({opacity:"hide"},500);setTimeout(function(){jq("#contactItem_"+o).remove();if(jq("#contactTable tr").length==0){jq("#contactListBox").parent().addClass("hiddenFields")}},500)};var h=function(n){if(jq("#contactItem_"+n.id).length>0){return false}Teamlab.getCrmContact({},n.id,{success:function(p,o){jq("#simpleContactTmpl").tmpl(o).prependTo("#contactTable tbody");jq("#contactListBox").parent().removeClass("hiddenFields");ASC.CRM.Common.RegisterContactInfoCard();assignedContactSelector.SelectedContacts.push(o.id);jq("#assignedContactsListEdit .assignedContacts").addClass("hiddenFields")}})};var l=function(n){var p=n.value.trim();var o=jq(n).parents("table:first");var q=new RegExp("^[-a-z0-9!#$%&'*+/=?^_`{|}~]+(?:.[-a-z0-9!#$%&'*+/=?^_`{|}~]+)*@(?:[a-z0-9]([-a-z0-9]{0,61}[a-z0-9])?.)*(?:aero|arpa|asia|biz|cat|com|coop|edu|gov|info|int|jobs|mil|mobi|museum|name|net|org|pro|tel|travel|[a-z][a-z])$","i");if(p==""||q.test(p)){o.css("borderColor","");o.parent().children(".requiredErrorText").hide();return true}else{o.css("borderColor","#CC0000");o.parent().children(".requiredErrorText").show();n.focus();return false}};var m=function(n){var p=n.value.trim();var o=jq(n).parents("table:first");var q=new RegExp(/(^\+)?(\d+)/);if(p==""||q.test(p)){o.css("borderColor","");o.parent().children(".requiredErrorText").hide();return true}else{o.css("borderColor","#CC0000");o.parent().children(".requiredErrorText").show();n.focus();return false}};return{init:function(s){if(j===false){j=true;ASC.CRM.ListContactView.renderSimpleContent();ASC.CRM.ContactActionView.WatermarkClass="crm-watermarked";ASC.CRM.Common.renderCustomFields(customFieldList,"custom_field_","customFieldTmpl","#generalListEdit");jq("#generalListEdit .headerExpand:not(:first)").click();jq("input.textEditCalendar").mask(s);jq("input.textEditCalendar").datepicker();jq("#generalListEdit .not_primary_field").live("click",function(){ASC.CRM.ContactActionView.choosePrimaryElement(jq(this),jq(this).parent().parent().parent().attr("id")=="addressContainer")});if(typeof(contactNetworks)!="undefined"&&contactNetworks!=""){for(var u=0;u<contactNetworks.length;u++){if(contactNetworks[u].hasOwnProperty("InfoType")&&contactNetworks[u].hasOwnProperty("Data")){if(contactNetworks[u].InfoType==7){var q=jq.parseJSON(Encoder.htmlDecode(contactNetworks[u].Data));var n=g(jq("#addressContainer").children("div:first").clone(),contactNetworks[u].IsPrimary,contactNetworks[u].Category,q.street,q.city,q.state,q.zip,q.country);n.insertAfter(jq("#addressContainer").children("div:last")).show();continue}var r;var o;if(contactNetworks[u].InfoType==0){r="phoneContainer";o=ASC.CRM.ContactActionView.createNewCommunication(r,Encoder.htmlDecode(contactNetworks[u].Data),contactNetworks[u].IsPrimary);f(o.children("table").find("a"),jq("#phoneCategoriesPanel div.dropDownContent").children("a[category="+contactNetworks[u].Category+"]").text(),contactNetworks[u].Category)}else{if(contactNetworks[u].InfoType==1){r="emailContainer";o=ASC.CRM.ContactActionView.createNewCommunication(r,Encoder.htmlDecode(contactNetworks[u].Data),contactNetworks[u].IsPrimary);d(o.children("table").find("a"),jq("#baseCategoriesPanel div.dropDownContent").children("a[category="+contactNetworks[u].Category+"]").text(),contactNetworks[u].Category)}else{r="websiteAndSocialProfilesContainer";o=ASC.CRM.ContactActionView.createNewCommunication(r,Encoder.htmlDecode(contactNetworks[u].Data));d(o.find("a.social_profile_category"),jq("#baseCategoriesPanel div.dropDownContent").children("a[category="+contactNetworks[u].Category+"]").text(),contactNetworks[u].Category);ASC.CRM.ContactActionView.changeSocialProfileCategory(o.find("a.social_profile_type"),contactNetworks[u].InfoType,jq("#socialProfileCategoriesPanel div.dropDownContent").children("a[category="+contactNetworks[u].InfoType+"]").text(),jq("#socialProfileCategoriesPanel div.dropDownContent").children("a[category="+contactNetworks[u].InfoType+"]").attr("categoryName"))}}o.insertAfter(jq("#"+r).children("div:last")).show();continue}}var p="crm-addNewLink";var t="crm-deleteLink";if(jq("#emailContainer").children("div").length>1){jq("#emailContainer").prev("dt").removeClass("crm-withGrayPlus")}jq("#emailContainer").children("div:not(:first)").find("."+p).hide();jq("#emailContainer").children("div:last").find("."+p).show();if(jq("#phoneContainer").children("div").length>1){jq("#phoneContainer").prev("dt").removeClass("crm-withGrayPlus")}jq("#phoneContainer").children("div:not(:first)").find("."+p).hide();jq("#phoneContainer").children("div:last").find("."+p).show();if(jq("#websiteAndSocialProfilesContainer").children("div").length>1){jq("#websiteAndSocialProfilesContainer").prev("dt").removeClass("crm-withGrayPlus")}jq("#websiteAndSocialProfilesContainer").children("div:not(:first)").find("."+p).hide();jq("#websiteAndSocialProfilesContainer").children("div:last").find("."+p).show();if(jq("#addressContainer").children("div").length>1){jq("#addressContainer").prev("dt").removeClass("crm-withGrayPlus")}jq("#addressContainer").children("div:not(:first)").find("."+p).hide();jq("#addressContainer").children("div:last").find("."+p).show()}jq("#generalListEdit .crm-withGrayPlus").live("click",function(w){var v=jq(this).next("dd").attr("id");if(v=="addressContainer"){ASC.CRM.ContactActionView.editAddress(jq("#addressContainer > div:first .crm-addNewLink"))}else{ASC.CRM.ContactActionView.editCommunications(jq("#"+v).children("div:first").find(".crm-addNewLink"),v)}jq(this).removeClass("crm-withGrayPlus")});jq.dropdownToggle({dropdownID:"phoneCategoriesPanel",switcherSelector:"#phoneContainer .input_with_type a",addTop:0,addLeft:0});jq.dropdownToggle({dropdownID:"baseCategoriesPanel",switcherSelector:"#emailContainer .input_with_type a",noActiveSwitcherSelector:"#websiteAndSocialProfilesContainer .input_with_type a.social_profile_category",addTop:0,addLeft:0});jq.dropdownToggle({dropdownID:"baseCategoriesPanel",switcherSelector:"#websiteAndSocialProfilesContainer .input_with_type a.social_profile_category",noActiveSwitcherSelector:"#emailContainer .input_with_type a",addTop:0,addLeft:0});jq.dropdownToggle({dropdownID:"socialProfileCategoriesPanel",switcherSelector:"#websiteAndSocialProfilesContainer .input_with_type a.social_profile_type",addTop:0,addLeft:0});if(typeof(assignedContactSelector)!="undefined"){if(assignedContactSelector.SelectedContacts.length==0){jq("#contactListBox").parent().addClass("hiddenFields")}assignedContactSelector.SelectItemEvent=h;ASC.CRM.ListContactView.removeMember=k}if(jq("#typeAddedContact").val()=="people"){setInterval(function(){var v=jq("#contactProfileEdit .info_for_person input[name=baseInfo_firstName]");var w=jq("#contactProfileEdit .info_for_person input[name=baseInfo_lastName]");if(v.val().trim()==""||w.val().trim()==""){jq("#contactProfileEdit .info_for_person .findInSocialMediaButton_Enabled").hide();jq("#contactProfileEdit .info_for_person .findInSocialMediaButton_Disabled").show()}else{jq("#contactProfileEdit .info_for_person .findInSocialMediaButton_Disabled").hide();jq("#contactProfileEdit .info_for_person .findInSocialMediaButton_Enabled").show()}},500)}else{setInterval(function(){var v=jq("#contactProfileEdit .info_for_company input[name=baseInfo_companyName]");if(v.val().trim()==""){jq("#contactProfileEdit .info_for_company .findInSocialMediaButton_Enabled").hide();jq("#contactProfileEdit .info_for_company .findInSocialMediaButton_Disabled").show()}else{jq("#contactProfileEdit .info_for_company .findInSocialMediaButton_Disabled").hide();jq("#contactProfileEdit .info_for_company .findInSocialMediaButton_Enabled").show()}},500)}}},editCommunicationsEvent:function(p,o){p=p||window.event;var n=jq(p.target||p.srcElement);ASC.CRM.ContactActionView.editCommunications(n,o)},editCommunications:function(q,s){var r="crm-addNewLink";var t="crm-deleteLink";var v="primary_field";if(q.length==0&&s=="overviewContainer"||q.hasClass(r)){var o=jq("#"+s).children("div:visible:last");if(o.length!=0){o.find("."+r).hide()}var u=jq("#"+s).find(".primary_field").length==0?true:undefined;var p=ASC.CRM.ContactActionView.createNewCommunication(s,"",u);p.insertAfter(jq("#"+s).children("div:last")).show();p.find("input.textEdit").focus()}else{if(q.hasClass(t)){var n=q.parent().parent();if(jq("#"+s).children("div").length==2){n.parent().prev("dt").addClass("crm-withGrayPlus")}n.remove();if(n.find("."+v).length==1&&jq("#"+s).children("div:not(:first)").length>=1){ASC.CRM.ContactActionView.choosePrimaryElement(jq(jq("#"+s).children("div:not(:first)")[0]).find(".is_primary"),false)}jq("#"+s).children("div:not(:first)").find("."+r).hide();jq("#"+s).children("div:last").find("."+r).show()}}},createNewCommunication:function(q,u,s){var n=jq("#"+q).children("div:first").clone();if(q!="overviewContainer"){var p=jq("#"+q).children("div:last").find("input.textEdit");if(p.length!=0){var t=p.attr("name").split("_");var r=t[2]*1+1;t=n.find("input.textEdit").attr("name").split("_");t[2]=r;n.find("input.textEdit").attr("name",t.join("_"))}if(u&&u!=""){n.children("table").find("input").val(u)}if(q==="phoneContainer"){jq.forcePhoneSymbolsOnly(n.children("table").find("input"))}if(typeof(s)!="undefined"){var o=n.children(".actions_for_item").children(".is_primary");if(o.length!=0){e(n,s)}}}else{if(u&&u!=""){n.children("textarea").val(u)}}return n},editAddressEvent:function(o){o=o||window.event;var n=jq(o.target||o.srcElement);ASC.CRM.ContactActionView.editAddress(n)},editAddress:function(q){var r="crm-addNewLink";var s="crm-deleteLink";var u="primary_field";if(q.hasClass(r)){var o=jq("#addressContainer").children("div:visible:last");if(o.length!=0){o.find("."+r).hide()}var t=jq("#addressContainer").find(".primary_field").length==0?true:undefined;var p=g(jq("#addressContainer").children("div:first").clone(),t).insertAfter(jq("#addressContainer").children("div:last")).show();p.find("textarea").focus()}else{if(q.hasClass(s)){var n=q.parent().parent();if(jq("#addressContainer").children("div").length==2){n.parent().prev("dt").addClass("crm-withGrayPlus")}n.remove();if(n.find("."+u).length==1&&jq("#addressContainer").children("div:not(:first)").length>=1){ASC.CRM.ContactActionView.choosePrimaryElement(jq(jq("#addressContainer").children("div:not(:first)")[0]).find(".is_primary"),true)}jq("#addressContainer").children("div:not(:first)").find("."+r).hide();jq("#addressContainer").children("div:last").find("."+r).show()}}},changeSocialProfileCategory:function(u,p,w,q){var n=jq(u).parents("table:first").parent();jq(u).text(w);$inputObj=jq(u).parents("tr:first").find("input");var v=$inputObj.attr("name").split("_");v[1]=q;$inputObj.attr("name",v.join("_"));var o=n.find(".find_profile");var t=false;var s="";var x="";var r=" ";switch(p){case 4:t=true;x=CRMJSResources.FindTwitter;r=CRMJSResources.ContactTwitterDescription;s=(function(y,z){return function(){ASC.CRM.SocialMedia.FindTwitterProfiles(jq(this),jq("#typeAddedContact").val(),y,z)}})(-3,5);break;case 5:if(jq("#typeAddedContact").val()==="company"){t=false}else{t=true}x=CRMJSResources.FindLinkedIn;r=CRMJSResources.ContactLinkedInDescription;s=(function(y,z){return function(){ASC.CRM.SocialMedia.FindLinkedInProfiles(jq(this),jq("#typeAddedContact").val(),y,z)}})(-3,5);break;case 6:t=true;x=CRMJSResources.FindFacebook;r=CRMJSResources.ContactFacebookDescription;s=(function(y,z){return function(){ASC.CRM.SocialMedia.FindFacebookProfiles(jq(this),jq("#typeAddedContact").val(),y,z)}})(-3,5);break}if(t){o.unbind("click").click(s);o.attr("title",x).show()}else{o.hide()}n.children(".textMediumDescribe").text(r);jq("#socialProfileCategoriesPanel").hide()},choosePrimaryElement:function(q,p){if(!p){var o=jq(q).parent().parent();e(o,true);jq(q).parents("dd:first").children("div:not(:first)").not(o).each(function(){e(jq(this),false)})}else{var n=jq(q).parent().parent();c(n,true);jq(q).parents("dd:first").children("div:not(:first)").not(n).each(function(){c(jq(this),false)})}jq(q).parents("dd:first").find(".is_primary").not(q).attr("class","is_primary not_primary_field");jq(q).parents("dd:first").find(".is_primary").not(q).attr("alt",CRMJSResources.CheckAsPrimary);jq(q).parents("dd:first").find(".is_primary").not(q).attr("title",CRMJSResources.CheckAsPrimary)},changeContactPhoto:function(n,o){jq("#contactProfileEdit").unblock();var p=jq.parseJSON("("+o+")");if(p.Success){jq("#uploadPhotoMessage").html("");jq("#uploadPhotoPath").val(p.Data);jq("#contactPhoto").html('<img alt="" class="contactPhoto" src="'+p.Data+'" />')}else{jq("#uploadPhotoMessage").html('<div class="errorBox">'+p.Message+"</div>")}},confirmForDelete:function(o,n){if(o==1){return confirm(jq.format(CRMJSResources.DeleteCompanyConfirmMessage,Encoder.htmlDecode(n))+"\n"+CRMJSResources.DeleteConfirmNote)}else{return confirm(jq.format(CRMJSResources.DeletePersonConfirmMessage,Encoder.htmlDecode(n))+"\n"+CRMJSResources.DeleteConfirmNote)}},submitForm:function(o){jq("input, select, textarea").attr("readonly","readonly").addClass("disabled");jq("#contactProfileEdit .input_with_type").addClass("disabled");HideRequiredError();if(jq("#typeAddedContact").val()=="people"){var t=true;if(jq("#contactProfileEdit input[name=baseInfo_firstName]").val().trim()==""){ShowRequiredError(jq("#contactProfileEdit input[name=baseInfo_firstName]"));t=false}if(jq("#contactProfileEdit input[name=baseInfo_lastName]").val().trim()==""){ShowRequiredError(jq("#contactProfileEdit input[name=baseInfo_lastName]"));t=false}if(!t){jq("#contactProfileEdit input, select, textarea").removeAttr("readonly").removeClass("disabled");jq("#contactProfileEdit .input_with_type").removeClass("disabled");return false}if(typeof(companySelector)!="undefined"){jq("#companySelectorsContainer input[name=baseInfo_compID]").val(typeof(companySelector.SelectedContacts[0])!="undefined"?companySelector.SelectedContacts[0]:"");jq("#companySelectorsContainer input[name=baseInfo_compName]").val(jq("#contactTitle_companySelector_0").hasClass(ASC.CRM.ContactActionView.WatermarkClass)?"":jq("#contactTitle_companySelector_0").val())}}else{var t=true;if(jq("#contactProfileEdit input[name=baseInfo_companyName]").val().trim()==""){ShowRequiredError(jq("#contactProfileEdit input[name=baseInfo_companyName]"));t=false}if(!t){jq("#contactProfileEdit input, select, textarea").removeAttr("readonly").removeClass("disabled");jq("#contactProfileEdit .input_with_type").removeClass("disabled");return false}}var s=true;jq("#emailContainer > div:not(:first) > table input").each(function(){if(!l(this)){s=false}});if(!s){jq("#contactProfileEdit input, select, textarea").removeAttr("readonly").removeClass("disabled");jq("#contactProfileEdit .input_with_type").removeClass("disabled");jq.scrollTo(jq("#emailContainer").position().top-100,{speed:400});return false}jq("#contactActionPanelButtons").hide();jq("#crm_contactMakerDialog .ajax_info_block").show();jq("#addressContainer").children("div:first").find("input, textarea, select").attr("name","");jq("#emailContainer").children("div:first").find("input").attr("name","");jq("#phoneContainer").children("div:first").find("input").attr("name","");jq("#websiteAndSocialProfilesContainer").children("div:first").find("input").attr("name","");jq("#overviewContainer").children("div:first").find("textarea").attr("name","");jq("#emailContainer").children("div:not(:first)").find("input").each(function(){if(jq(this).val().trim()!=""){jq(this).parents("table:first").parent().addClass("not_empty")}});jq("#phoneContainer").children("div:not(:first)").find("input").each(function(){if(jq(this).val().trim()!=""){jq(this).parents("table:first").parent().addClass("not_empty")}});jq("#websiteAndSocialProfilesContainer").children("div:not(:first)").find("input").each(function(){if(jq(this).val().trim()!=""){jq(this).parents("table:first").parent().addClass("not_empty")}});jq("#addressContainer").children("div:not(:first)").each(function(){if(jq(this).find(".contact_street").hasClass(ASC.CRM.ContactActionView.WatermarkClass)&&jq(this).find(".contact_city").hasClass(ASC.CRM.ContactActionView.WatermarkClass)&&jq(this).find(".contact_state").hasClass(ASC.CRM.ContactActionView.WatermarkClass)&&jq(this).find(".contact_zip").hasClass(ASC.CRM.ContactActionView.WatermarkClass)&&jq(this).find(".contact_country").val()==CRMJSResources.ChooseCountry){jq(this).find("input, textarea, select").attr("name","")}else{jq(this).addClass("not_empty");jq(this).find("."+ASC.CRM.ContactActionView.WatermarkClass).val(" ");if(jq(this).find(".contact_country").val()==CRMJSResources.ChooseCountry){jq(this).find(".contact_country").val("")}}});if((jq("#emailContainer").children("div:not(:first)").find(".primary_field").length==0||!jq("#emailContainer").children("div:not(:first)").find(".primary_field").parent().parent().hasClass("not_empty"))&&jq("#emailContainer").children("div.not_empty").length>0){ASC.CRM.ContactActionView.choosePrimaryElement(jq(jq("#emailContainer").children("div.not_empty")[0]).children(".actions_for_item").children(".is_primary"),false)}if((jq("#phoneContainer").children("div:not(:first)").find(".primary_field").length==0||!jq("#phoneContainer").children("div:not(:first)").find(".primary_field").parent().parent().hasClass("not_empty"))&&jq("#phoneContainer").children("div.not_empty").length>0){ASC.CRM.ContactActionView.choosePrimaryElement(jq(jq("#phoneContainer").children("div.not_empty")[0]).children(".actions_for_item").children(".is_primary"),false)}if((jq("#addressContainer").children("div:not(:first)").find(".primary_field").length==0||!jq("#addressContainer").children("div:not(:first)").find(".primary_field").parent().parent().hasClass("not_empty"))&&jq("#addressContainer").children("div.not_empty").length>0){ASC.CRM.ContactActionView.choosePrimaryElement(jq(jq("#addressContainer").children("div.not_empty")[0]).children(".actions_for_item").children(".is_primary"),true)}if(!jq("#isPrivate").is(":checked")){SelectedUsers.IDs=new Array();jq("#cbxNotify").removeAttr("checked")}jq("#isPrivateContact").val(jq("#isPrivate").is(":checked"));jq("#notifyPrivateUsers").val(jq("#cbxNotify").is(":checked"));jq("#selectedPrivateUsers").val(SelectedUsers.IDs.join(","));var n=jq("#generalListEdit input[type='checkbox'][id^='custom_field_']");if(n){for(var q=0;q<n.length;q++){if(jq(n[q]).is(":checked")){var r=n[q].id.replace("custom_field_","");jq("#generalListEdit input[name='customField_"+r+"']").val(jq(n[q]).is(":checked"))}}}if(jq("#typeAddedContact").val()=="people"){return true}else{if(ASC.CRM.SocialMedia.selectedPersons.length==0){jq("#assignedContactsListEdit input[name='baseInfo_assignedContactsIDs']").val(assignedContactSelector.SelectedContacts);return true}else{var p=new Array();for(var q=0;q<ASC.CRM.SocialMedia.selectedPersons.length;q++){p.push({Key:ASC.CRM.SocialMedia.selectedPersons[q].Key,Value:ASC.CRM.SocialMedia.selectedPersons[q].Value})}Teamlab.addCrmPerson({buttonId:o},p,{success:function(v,x){var w=new Array();for(var u=0;u<x.length;u++){if(x[u]){w.push(x[u].id)}}w=w.concat(assignedContactSelector.SelectedContacts);jq("#assignedContactsListEdit input[name='baseInfo_assignedContactsIDs']").val(w);__doPostBack(v.buttonId,"")}});return false}}},showBaseCategoriesPanel:function(n){jq("#baseCategoriesPanel a.dropDownItem").unbind("click").click(function(){d(n,jq(this).text(),jq(this).attr("category"))})},showPhoneCategoriesPanel:function(n){jq("#phoneCategoriesPanel a.dropDownItem").unbind("click").click(function(){f(n,jq(this).text(),jq(this).attr("category"))})},showSocialProfileCategoriesPanel:function(n){jq("#socialProfileCategoriesPanel a.dropDownItem").unbind("click").click(function(){ASC.CRM.ContactActionView.changeSocialProfileCategory(n,jq(this).attr("category")*1,jq(this).text(),jq(this).attr("categoryName"))})},changeAddressCategory:function(n){b(n,jq(n).find("option:selected").attr("category"))},showAssignedContactPanel:function(){jq("#assignedContactsListEdit .assignedContacts").removeClass("hiddenFields");if(jq("#assignedContactsListEdit .headerCollapse").length==1){jq("#assignedContactsListEdit .headerCollapse span").click()}},toggleAssignedContactsListEdit:function(o){var n=jq(o).parent();if(n.hasClass("headerExpand")){n.next("dd:first").nextUntil().hide()}else{n.next("dd:first").nextUntil().show()}n.toggleClass("headerExpand");n.toggleClass("headerCollapse")},gotoAddCustomFieldPage:function(){if(confirm(CRMJSResources.ConfirmGoToCustomFieldPage)){if(jq("#typeAddedContact").val()==="company"){document.location="settings.aspx?type=custom_field&view=company"}else{if(jq("#typeAddedContact").val()==="people"){document.location="settings.aspx?type=custom_field&view=person"}else{document.location="settings.aspx?type=custom_field"}}}}}})(jQuery);jQuery.fn.sliderWithSections=function(h){var f=jQuery.extend({value:null,colors:null,values:null,defaultColor:"#E1E1E1",liBorderWidth:1,sliderOptions:null,max:0,marginWidth:1,slide:function(i,o){}},h);var k={step:1,min:0,orientation:"horizontal",max:f.max,range:false,slide:function(p,t){var s=jQuery(t.handle);s.attr("aria-valuetext",f.values[t.value]).attr("aria-valuenow",t.value);if(t.value!=0){s.find(".ui-slider-tooltip .ttContent").html(f.values[t.value]);s.removeClass("ui-slider-tooltip-hide")}else{s.addClass("ui-slider-tooltip-hide")}var r=jQuery(this).children("ol.ui-slider-scale").children("li");for(var q=0;q<k.max;q++){if(q<t.value){var o=f.colors!=null&&f.colors[q]?f.colors[q]:"transparent";jQuery(r[q]).css("background-color",o)}else{jQuery(r[q]).css("background-color",f.defaultColor)}}f.slide(p,t)},value:f.value};f.sliderOptions=(h)?jQuery.extend(k,h.sliderOptions):k;var j=jQuery("<div></div>");var a=jQuery('<a href="#" tabindex="0" class="ui-slider-handle" role="slider" aria-valuenow="'+f.value+'" aria-valuetext="'+f.values[f.value]+'"><span class="ui-slider-tooltip ui-widget-content ui-corner-all"><span class="ttContent"></span><span class="ui-tooltip-pointer-down ui-widget-content"><span class="ui-tooltip-pointer-down-inner"></span></span></span></a>').data("handleNum",f.value).appendTo(j);j.find(".ui-slider-tooltip .ttContent").html(f.values[f.value]);if(f.values[f.value]==""){j.children(".ui-slider-handle").addClass("ui-slider-tooltip-hide")}var g=j.append('<ol class="ui-slider-scale ui-helper-reset" role="presentation" style="width: 100%; height: 100%;"></ol>').find(".ui-slider-scale:eq(0)");var l=jQuery(this).css("width").replace("px","")*1;var n=((l-f.marginWidth*(k.max-1)-2*f.liBorderWidth*k.max)/k.max).toFixed(4);for(var c=0;c<=k.max;c++){var m=(c==k.max||c==0)?"display: none;":"";var e=(c==k.max)?"display: none;":"";var b="transparent";if(c<f.value){b=f.colors!=null&&f.colors[c]?f.colors[c]:"transparent"}else{b=f.defaultColor}g.append('<li style="left:'+d(c,l)+"; background-color:"+b+"; height: 100%; width:"+n+"px;"+e+'"></li>')}function d(o,p){var q=((p-f.marginWidth*(k.max-1)-2*f.liBorderWidth*k.max)/k.max);return((q+2*f.liBorderWidth+f.marginWidth)*o).toFixed(4)+"px"}j.appendTo(jQuery(this)).slider(f.sliderOptions).attr("role","application");j.find(".ui-tooltip-pointer-down-inner").each(function(){var o=jQuery(".ui-tooltip-pointer-down-inner").css("borderTopWidth");var i=jQuery(this).parents(".ui-slider-tooltip").css("backgroundColor");jQuery(this).css("border-top",o+" solid "+i)});return this};jq(document).ready(function(){jq.dropdownToggle({switcherSelector:".noContentBlock .hintTypes",dropdownID:"files_hintTypesPanel",fixWinSize:false});jq.dropdownToggle({switcherSelector:".noContentBlock .hintCsv",dropdownID:"files_hintCsvPanel",fixWinSize:false})});if(typeof ASC==="undefined"){ASC={}}if(typeof ASC.CRM==="undefined"){ASC.CRM=(function(){return{}})()}ASC.CRM.myFilter={filterId:"dealsAdvansedFilter",idFilterByContact:"contactID",idFilterByParticipant:"participantID",type:"custom-contact",hiddenContainerId:"hiddenBlockForContactSelector",containerId:"selector_contactSelectorForFilter",onSelectContact:function(b){var a=jq("#contactTitle_"+contactSelectorForFilter.ObjName+"_0");jq("#infoContent_"+contactSelectorForFilter.ObjName+"_0").show();jq("#selectorContent_"+contactSelectorForFilter.ObjName+"_0").hide();contactSelectorForFilter.setContact(a,b.id,b.title,b.img);contactSelectorForFilter.showInfoContent(a);contactSelectorForFilter.SelectedContacts=[];contactSelectorForFilter.SelectedContacts.push(b.id);if(ASC.CRM.myFilter.filterId){jq("#"+ASC.CRM.myFilter.filterId).advansedFilter(ASC.CRM.myFilter.idFilterByContact,{id:b.id,displayName:b.title,photoUrl:b.img,value:jq.toJSON([b.id,false])});jq("#"+ASC.CRM.myFilter.filterId).advansedFilter("resize")}},onSelectParticipant:function(b){var a=jq("#contactTitle_"+contactSelectorForFilter.ObjName+"_0");jq("#infoContent_"+contactSelectorForFilter.ObjName+"_0").show();jq("#selectorContent_"+contactSelectorForFilter.ObjName+"_0").hide();contactSelectorForFilter.setContact(a,b.id,b.title,b.img);contactSelectorForFilter.showInfoContent(a);contactSelectorForFilter.SelectedContacts=[];contactSelectorForFilter.SelectedContacts.push(b.id);if(ASC.CRM.myFilter.filterId){jq("#"+ASC.CRM.myFilter.filterId).advansedFilter(ASC.CRM.myFilter.idFilterByParticipant,{id:b.id,displayName:b.title,photoUrl:b.img,value:jq.toJSON([b.id,true])});jq("#"+ASC.CRM.myFilter.filterId).advansedFilter("resize")}},createFilterByContact:function(a){var b=document.createElement("div");b.innerHTML=['<div class="default-value">','<span class="title">',a.title,"</span>",'<span class="selector-wrapper">','<span class="contact-selector"></span>',"</span>",'<span class="btn-delete"></span>',"</div>"].join("");return b},customizeFilterByContact:function(a,b,c){contactSelectorForFilter.SelectItemEvent=ASC.CRM.myFilter.onSelectContact;if(ASC.CRM.myFilter.containerId){jq("#"+ASC.CRM.myFilter.containerId).appendTo(b.find("span.contact-selector:first"))}},destroyFilterByContact:function(a,b,c){if(ASC.CRM.myFilter.containerId&&ASC.CRM.myFilter.hiddenContainerId){jq("#"+ASC.CRM.myFilter.containerId).appendTo(jq("#"+ASC.CRM.myFilter.hiddenContainerId));contactSelectorForFilter.changeContact("contactSelectorForFilter_0")}},createFilterByParticipant:function(a){var b=document.createElement("div");b.innerHTML=['<div class="default-value">','<span class="title">',a.title,"</span>",'<span class="selector-wrapper">','<span class="contact-selector"></span>',"</span>",'<span class="btn-delete"></span>',"</div>"].join("");return b},customizeFilterByParticipant:function(a,b,c){contactSelectorForFilter.SelectItemEvent=ASC.CRM.myFilter.onSelectParticipant;if(ASC.CRM.myFilter.containerId){jq("#"+ASC.CRM.myFilter.containerId).appendTo(b.find("span.contact-selector:first"))}},destroyFilterByParticipant:function(a,b,c){if(ASC.CRM.myFilter.containerId&&ASC.CRM.myFilter.hiddenContainerId){jq("#"+ASC.CRM.myFilter.containerId).appendTo(jq("#"+ASC.CRM.myFilter.hiddenContainerId));contactSelectorForFilter.changeContact("contactSelectorForFilter_0")}},processFilter:function(a,b,c,e){if(e&&e.id&&isFinite(e.id)){var d=jq("#contactTitle_"+contactSelectorForFilter.ObjName+"_0");contactSelectorForFilter.setContact(d,e.id,e.hasOwnProperty("displayName")?e.displayName:"",e.hasOwnProperty("photoUrl")?e.photoUrl:"");contactSelectorForFilter.showInfoContent(d);contactSelectorForFilter.SelectedContacts=[];contactSelectorForFilter.SelectedContacts.push(e.id)}}};ASC.CRM.ListDealView=(function(a){Teamlab.bind(Teamlab.events.getException,l);function l(n,m){console.log("deals.js ",m);LoadingBanner.hideLoading()}var k=function(o,n){if(ASC.CRM.ListDealView.cookieKey&&ASC.CRM.ListDealView.cookieKey!=""){var m={page:o,countOnPage:n};jq.cookies.set(ASC.CRM.ListDealView.cookieKey,m,{path:location.pathname})}};var g=function(){jq("#dealTable tbody tr").remove();if(ASC.CRM.ListDealView.Total==0){jq("#dealList").hide();jq("#emptyContentForDealsFilter").show();LoadingBanner.hideLoading();return false}jq("#dealButtonsPanel").show();jq("#dealList").show();jq("#dealTmpl").tmpl(ASC.CRM.ListDealView.dealList).prependTo("#dealTable tbody");ASC.CRM.Common.RegisterContactInfoCard();if(ASC.CRM.ListDealView.bidList.length==0){jq("#dealList .showTotalAmount").hide()}else{jq("#dealList .showTotalAmount").show()}LoadingBanner.hideLoading()};var h=function(){if(ASC.CRM.ListDealView.dealList.length==0){return false}jq("#dealTmpl").tmpl(ASC.CRM.ListDealView.dealList).appendTo("#dealTable tbody");ASC.CRM.Common.RegisterContactInfoCard();if(ASC.CRM.ListDealView.bidList.length==0){jq("#dealList .showTotalAmount").hide()}else{jq("#dealList .showTotalAmount").show()}};var b=function(){if(!ASC.CRM.ListDealView.showMore){return false}ASC.CRM.ListDealView.dealList=new Array();var m=jq("#dealTable tbody tr").length;jq("#showMoreDealsButtons .crm-showMoreLink").hide();jq("#showMoreDealsButtons .crm-loadingLink").show();f(m)};var f=function(n){var m={contactID:ASC.CRM.ListDealView.contactID,count:ASC.CRM.ListDealView.entryCountOnPage,startIndex:n,contactAlsoIsParticipant:true};Teamlab.getCrmOpportunities({startIndex:n||0},{filter:m,success:ASC.CRM.ListDealView.CallbackMethods.get_opportunities_for_contact})};var e=function(n){var m=ASC.CRM.ListDealView.getFilterSettings(n);Teamlab.getCrmOpportunities({startIndex:n||0},{filter:m,success:ASC.CRM.ListDealView.CallbackMethods.get_opportunities_by_filter})};var j=function(){var m=jq("#dealFilterContainer").is(":hidden")==false;if(ASC.CRM.ListDealView.isFilterVisible==false&&m){ASC.CRM.ListDealView.isFilterVisible=true;if(ASC.CRM.ListDealView.advansedFilter){jq("#dealsAdvansedFilter").advansedFilter("resize")}}};var d=function(m){var r=new Date();var q=new Date(r.getFullYear(),r.getMonth(),r.getDate(),0,0,0,0);m.isOverdue=false;switch(m.stage.stageType){case 1:m.closedStatusString=CRMJSResources.SuccessfullyClosed+": "+m.actualCloseDateString;break;case 2:m.closedStatusString=CRMJSResources.UnsuccessfullyClosed+": "+m.actualCloseDateString;break;case 0:m.closedStatusString="";if(m.expectedCloseDateString!=""&&m.expectedCloseDate.getTime()<q.getTime()){m.isOverdue=true}break}m.bidNumberFormat=ASC.CRM.ListDealView.numberFormat(m.bidValue,{before:m.bidCurrency.symbol,thousands_sep:" ",dec_point:ASC.CRM.ListDealView.currencyDecimalSeparator});if(typeof(m.bidValue)!="undefined"&&m.bidValue!=0){if(typeof(m.perPeriodValue)=="undefined"||m.perPeriodValue==0){m.perPeriodValue=1}var n=false;for(var o=0,p=ASC.CRM.ListDealView.bidList.length;o<p;o++){if(ASC.CRM.ListDealView.bidList[o].bidCurrencyAbbreviation==m.bidCurrency.abbreviation){ASC.CRM.ListDealView.bidList[o].bidValue+=m.bidValue*m.perPeriodValue;n=true;break}}if(!n){ASC.CRM.ListDealView.bidList.push({bidValue:m.bidValue*m.perPeriodValue,bidCurrencyAbbreviation:m.bidCurrency.abbreviation,bidCurrencySymbol:m.bidCurrency.symbol,isConvertable:m.bidCurrency.isConvertable})}}};var c=function(){if(ASC.CRM.ListDealView.contactID==0&&ASC.CRM.ListDealView.isFirstTime==true){ASC.CRM.ListDealView.isFirstTime=false;jq("#emptyContentForDealsFilter").css("min-height","250px");if(typeof(opportunitiesForFirstRequest)!="undefined"){opportunitiesForFirstRequest=jq.parseJSON(jQuery.base64.decode(opportunitiesForFirstRequest))}else{opportunitiesForFirstRequest=[]}var m=ASC.CRM.ListDealView.entryCountOnPage*(ASC.CRM.ListDealView.currentPageNumber-1);ASC.CRM.ListDealView.CallbackMethods.get_opportunities_by_filter({__startIndex:m,__nextIndex:opportunitiesForFirstRequest.nextIndex,__total:opportunitiesForFirstRequest.total},Teamlab.create("crm-opportunities",null,opportunitiesForFirstRequest.response));return}k(0,dealPageNavigator.EntryCountOnPage);i(0)};var i=function(m){ASC.CRM.ListDealView.dealList=new Array();ASC.CRM.ListDealView.bidList=new Array();LoadingBanner.displayLoading();e(m)};return{CallbackMethods:{get_opportunities_by_filter:function(s,r){for(var o=0,q=r.length;o<q;o++){d(r[o])}ASC.CRM.ListDealView.dealList=r;jq(window).trigger("getDealsFromApi",[s,r]);ASC.CRM.ListDealView.Total=s.__total||0;var t=s.__startIndex||0;if(ASC.CRM.ListDealView.Total===0){ASC.CRM.ListDealView.noDealsForQuery=true}else{ASC.CRM.ListDealView.noDealsForQuery=false}if(ASC.CRM.ListDealView.noDealsForQuery){jq("#dealList").hide();jq("#dealButtonsPanel").show();jq("#mainExportCsv").next("img").hide();jq("#mainExportCsv").hide();jq("#dealFilterContainer").show();j();jq("#emptyContentForDealsFilter").show();LoadingBanner.hideLoading();return false}jq("#totalDealsOnPage").text(ASC.CRM.ListDealView.Total);jq("#emptyContentForDealsFilter").hide();jq("#dealButtonsPanel").show();jq("#mainExportCsv").next("img").show();jq("#mainExportCsv").show();jq("#dealFilterContainer").show();j();jq("#dealList").show();jq("#dealTable tbody").replaceWith(jq("#dealListTmpl").tmpl({opportunities:ASC.CRM.ListDealView.dealList}));ASC.CRM.Common.RegisterContactInfoCard();var u;if(t>=ASC.CRM.ListDealView.Total){u=t+1}else{u=ASC.CRM.ListDealView.Total}dealPageNavigator.drawPageNavigator((t/ASC.CRM.ListDealView.entryCountOnPage).toFixed(0)*1+1,u);jq("#simpleDealPageNavigator").html("");var m=jq("<div></div>");var p=0;if(jq("#divForDealPager .pagerPrevButtonCSSClass").length!=0){p++;jq("#divForDealPager .pagerPrevButtonCSSClass").clone().appendTo(m)}if(jq("#divForDealPager .pagerNextButtonCSSClass").length!=0){p++;if(p===2){jq("<span style='padding: 0 8px;'>&nbsp;</span>").clone().appendTo(m)}jq("#divForDealPager .pagerNextButtonCSSClass").clone().appendTo(m)}if(m.children().length!=0){m.appendTo("#simpleDealPageNavigator");jq("#simpleDealPageNavigator").show()}else{jq("#simpleDealPageNavigator").hide()}if(ASC.CRM.ListDealView.bidList.length==0){jq("#dealList .showTotalAmount").hide()}else{jq("#dealList .showTotalAmount").show()}window.scrollTo(0,0);LoadingBanner.hideLoading()},get_opportunities_for_contact:function(q,p){for(var m=0,o=p.length;m<o;m++){d(p[m]);ASC.CRM.ListDealView.dealList.push(p[m])}jq(window).trigger("getDealsFromApi",[q,p]);ASC.CRM.ListDealView.Total=q.__total||0;if(typeof(q.__nextIndex)=="undefined"){ASC.CRM.ListDealView.showMore=false}if(!q.__startIndex){g()}else{h()}jq("#showMoreDealsButtons .crm-loadingLink").hide();if(ASC.CRM.ListDealView.showMore){jq("#showMoreDealsButtons .crm-showMoreLink").show()}else{jq("#showMoreDealsButtons .crm-showMoreLink").hide()}}},init:function(n,s,r,o,p,m){ASC.CRM.ListDealView.contactID=n;ASC.CRM.ListDealView.entryCountOnPage=s;ASC.CRM.ListDealView.currentPageNumber=r;ASC.CRM.ListDealView.currencyDecimalSeparator=p;ASC.CRM.ListDealView.cookieKey=o;ASC.CRM.ListDealView.isFilterVisible=false;var q=location.hash;q=q&&typeof q==="string"&&q.charAt(0)==="#"?q.substring(1):q;if(q==""||decodeURIComponent(m)==q){ASC.CRM.ListDealView.isFirstTime=true}else{ASC.CRM.ListDealView.isFirstTime=false}ASC.CRM.ListDealView.bidList=new Array();ASC.CRM.ListDealView.dealList=new Array();dealPageNavigator.NavigatorParent="#divForDealPager";dealPageNavigator.changePageCallback=function(t){ASC.CRM.ListDealView.currentPageNumber=t;k(t,dealPageNavigator.EntryCountOnPage);var u=dealPageNavigator.EntryCountOnPage*(t-1);i(u)};jq(window).bind("afterResetSelectedContact",function(t,u,v){if(v==="contactSelectorForFilter"&&ASC.CRM.myFilter.filterId){jq("#"+ASC.CRM.myFilter.filterId).advansedFilter("resize")}})},initTab:function(m,o,n){ASC.CRM.ListDealView.contactID=m;ASC.CRM.ListDealView.entryCountOnPage=o;ASC.CRM.ListDealView.currencyDecimalSeparator=n;jq("#showMoreDealsButtons .crm-showMoreLink").bind("click",function(){b()});ASC.CRM.ListDealView.showMore=true;ASC.CRM.ListDealView.isTabActive=false;ASC.CRM.ListDealView.bidList=new Array();ASC.CRM.ListDealView.dealList=new Array()},setFilter:function(n,m,o,p,q){c()},resetFilter:function(n,m,o,p){c()},activate:function(){if(ASC.CRM.ListDealView.isTabActive==false){ASC.CRM.ListDealView.isTabActive=true;LoadingBanner.displayLoading();f(0)}},getFilterSettings:function(o){o=o||0;var n={startIndex:o,count:ASC.CRM.ListDealView.entryCountOnPage};if(!ASC.CRM.ListDealView.advansedFilter){return n}var m=ASC.CRM.ListDealView.advansedFilter.advansedFilter();jq(m).each(function(s,t){switch(t.id){case"sorter":n.sortBy=t.params.id;n.sortOrder=t.params.dsc==true?"descending":"ascending";break;case"text":n.filterValue=t.params.value;break;case"fromToDate":n.fromDate=new Date(t.params.from);n.toDate=new Date(t.params.to);break;default:if(t.hasOwnProperty("apiparamname")&&t.params.hasOwnProperty("value")&&t.params.value!=null){try{var p=jq.parseJSON(t.apiparamname);var q=jq.parseJSON(t.params.value);if(p.length!=q.length){n[t.apiparamname]=t.params.value}for(var s=0,u=p.length;s<u;s++){n[p[s]]=q[s]}}catch(r){n[t.apiparamname]=t.params.value}}break}});return n},expectedValue:function(m,n){switch(m){case 1:return CRMJSResources.BidType_PerHour+" "+jq.format(CRMJSResources.PerPeriodHours,n);case 2:return CRMJSResources.BidType_PerDay+" "+jq.format(CRMJSResources.PerPeriodDays,n);case 3:return CRMJSResources.BidType_PerWeek+" "+jq.format(CRMJSResources.PerPeriodWeeks,n);case 4:return CRMJSResources.BidType_PerMonth+" "+jq.format(CRMJSResources.PerPeriodMonths,n);case 5:return CRMJSResources.BidType_PerYear+" "+jq.format(CRMJSResources.PerPeriodYears,n);default:return""}},changeCountOfRows:function(n){if(isNaN(n)){return}var m=n*1;ASC.CRM.ListDealView.entryCountOnPage=m;dealPageNavigator.EntryCountOnPage=m;k(1,m);i(0)},exportToCsv:function(){var o=window.location.href.indexOf("#");var n=o>=0?window.location.href.substr(0,o):window.location.href;var m=o>=0?window.location.href.substr(o,window.location.href.length):"";jq("#exportDialog").hide();window.location.href=n+"?action=export"+m},openExportFile:function(){var n=window.location.href.indexOf("#");var m=n>=0?window.location.href.substr(0,n):window.location.href;jq("#exportDialog").hide();window.open(m+"?action=export&view=editor")},showExportDialog:function(){jq.dropdownToggle().toggle("#mainExportCsv","exportDialog",7,-20)},numberFormat:function(o,m){function q(s,u){var t={};for(key in s){if(typeof u[key]!=="undefined"){t[key]=u[key]}else{t[key]=s[key]}}return t}function r(u,y){if(u.length<=3){return u}var s=u.length;var w="";var t=0;for(var x=(s-1);x>=0;x--){var v=u.substr(x,1);if(t%3==0&&t!=0&&!isNaN(parseFloat(v))){w=y+w}w=v+w;t++}return w}if(typeof o!=="number"){o=parseFloat(o);if(isNaN(o)){return false}}var n={before:"",after:"",decimals:2,dec_point:".",thousands_sep:","};if(m&&typeof m==="object"){m=q(n,m)}else{m=n}o=o.toFixed(m.decimals);if(o.indexOf(".")!=-1){var p=o.split(".");var o=r(p[0],m.thousands_sep)+m.dec_point+p[1]}else{var o=r(o,m.thousands_sep)}return m.before+o+m.after},showExchangeRatePopUp:function(){if(ASC.CRM.ListDealView.bidList.length==0){return}ASC.CRM.ExchangeRateView.renderTotalAmount(ASC.CRM.ListDealView.bidList,ASC.CRM.ListDealView.currencyDecimalSeparator);ASC.CRM.Common.blockUI("#exchangeRatePopUp",550,700,0)}}})(jQuery);ASC.CRM.DealActionView=(function(a){function b(c,g,d){ASC.CRM.Common.renderCustomFields(customFieldList,"custom_field_","customFieldRowTemplate","#dealForm dl:last");jq("#dealForm .headerExpand").click();jq("input.textEditCalendar").mask(d);jq("input.textEditCalendar").datepicker();jq.forceIntegerOnly("#perPeriodValue, #probability");jq("#probability").focusout(function(h){var i=jq.trim(jq("#probability").val());if(i!=""&&i*1>100){jq("#probability").val(100)}});jq("#bidValue").keypress(function(i){var h=[8,9];var j=h.join(",").match(new RegExp(i.which));if((!i.which||(48<=i.which&&i.which<=57)||j)||(jq(this).val().length-jq(this).val().replace(c,"").length<1&&i.which==g*1)){return}else{i.preventDefault()}});jq("#bidValue").unbind("paste").bind("paste",function(i){var j=this.value;var h=this;setTimeout(function(){var k=jq(h).val();if(isNaN(k)){jq(h).val(j)}else{if(c!="."){k.replace(".",c);jq(h).val(k)}}},0);return true});for(var f=0;f<dealMilestones.length;f++){var e=dealMilestones[f];jq("<option>").attr("value",e.id).text(e.title).appendTo(jq("#dealMilestone"))}jq("#probability").val(dealMilestones[jq("#dealMilestone")[0].selectedIndex].probability)}return{init:function(c,e,d,f){b(c,e,d);if(jq.getURLParam("id")!=null){jq("#nameDeal").val(targetDeal.title);jq("#descriptionDeal").val(targetDeal.description);jq("#bidValue").val(targetDeal.bid_value.toString().replace(/[\.\,]/g,c));jq(jq.format("#bidCurrency option[value={0}]",targetDeal.bid_currency)).attr("selected","selected");if(targetDeal.bid_type>0){jq(jq.format("#bidType [value={0}]",targetDeal.bid_type)).attr("selected","selected");jq("#bidType").nextAll().show();jq("#perPeriodValue").val(targetDeal.per_period_value);jq("#bidType").change()}jq("#probability").val(targetDeal.deal_milestone_probability);jq("#expectedCloseDate").val(targetDeal.expected_close_date);jq(jq.format("#dealMilestone option[value={0}]",targetDeal.deal_milestone)).attr("selected","selected");jq("#contactID").val("contact_id")}else{jq("#expectedCloseDate").val(f)}jq(window).bind("editContactInSelector",function(h,g,i){if(i=="dealMemberSelector"){dealClientSelector.ExcludedArrayIDs=dealMemberSelector.SelectedContacts.slice(0)}if(i=="dealClientSelector"){dealMemberSelector.ExcludedArrayIDs=[]}});jq(window).bind("deleteContactFromSelector",function(h,g,i){if(i=="dealMemberSelector"){dealClientSelector.ExcludedArrayIDs=dealMemberSelector.SelectedContacts.slice(0);if(jq("div[id^='item_dealMemberSelector_']").length==1){jq("#dealMembersHeader").hide();jq("#dealMembersBody").hide();jq("#item_dealClientSelector_0").removeClass("hasMembers")}}if(i=="dealClientSelector"){dealMemberSelector.ExcludedArrayIDs=[]}});jq("#selectorContent_dealClientSelector_0 .crm-addNewLink").parent().remove();jq("#newContactContent_dealClientSelector_0 .crm-addNewLink").remove();jq("#infoContent_dealClientSelector_0 .crm-addNewLink").removeAttr("onclick");jq("#infoContent_dealClientSelector_0 .crm-addNewLink").click(function(){jq("#item_dealClientSelector_0").addClass("hasMembers");if(jq("div[id^='item_dealMemberSelector_']").length==0){dealMemberSelector.AddNewSelector(jq(this))}jq("#dealMembersHeader").show();jq("#dealMembersBody").show()});if(dealMemberSelector.SelectedContacts.length!=0){jq("#item_dealClientSelector_0").addClass("hasMembers")}jq("#infoContent_dealClientSelector_0 .crm-editLink").bind("click",function(){dealMemberSelector.ExcludedArrayIDs=[]})},chooseMainContact:function(d,c){dealClientSelector.setContact(c,d.id,d.title,d.img);dealClientSelector.showInfoContent(c);dealMemberSelector.ExcludedArrayIDs=[d.id]},chooseMemberContact:function(d,c){dealMemberSelector.setContact(c,d.id,d.title,d.img);dealMemberSelector.showInfoContent(c);dealClientSelector.ExcludedArrayIDs.push(d.id)},selectBidTypeEvent:function(g){var d=g.selectedIndex;if(d!=0){jq(g).nextAll().show()}else{jq(g).nextAll().hide()}var c=jq(g).nextAll("span.splitter");var f="";switch(d){case 1:f=CRMJSResources.PerPeriodHours;break;case 2:f=CRMJSResources.PerPeriodDays;break;case 3:f=CRMJSResources.PerPeriodWeeks;break;case 4:f=CRMJSResources.PerPeriodMonths;break;case 5:f=CRMJSResources.PerPeriodYears;break}var e=f.split("{0}");jq(c).each(function(h){jq(this).text(jq.trim(e[h]))})},deleteDeal:function(d){if(!confirm(jq.format(CRMJSResources.DeleteDealConfirmMessage,jq("#nameDeal").val())+"\n"+CRMJSResources.DeleteConfirmNote)){return}var c=jq.trim(jq.getURLParam("contact_id"));Teamlab.removeCrmOpportunity({contact_id:c},d,{before:function(){jq("#dealForm input, #dealForm select, #dealForm textarea").attr("disabled",true);jq("#dealForm  .ajax_info_block span").text(CRMJSResources.DeleteDealInProgress);jq("#dealForm  .action_block").hide();jq("#dealForm  .ajax_info_block").show()},success:function(f,e){jq("#dealForm  .action_block").show();jq("#dealForm  .ajax_info_block").hide();if(f.contact_id!=""){location.href=jq.format("default.aspx?id={0}#deals",f.contact_id)}else{location.href="deals.aspx"}}})},submitForm:function(){var g=true;if(jq.trim(jq("#nameDeal").val())==""){ShowRequiredError(jq("#nameDeal"));g=false}else{RemoveRequiredErrorClass(jq("#nameDeal"))}if(userSelector.SelectedUserId==null){ShowRequiredError(jq("#inputUserName"));g=false}else{RemoveRequiredErrorClass(jq("#inputUserName"))}if(!g){return false}var d=jq.trim(jq("#probability").val());if(d==""){d=0;jq("#probability").val(0)}else{d=d*1;if(d>100){jq("#probability").val(100)}}jq("#dealForm input, select, textarea").attr("readonly","readonly").addClass("disabled");jq("#responsibleID").val(userSelector.SelectedUserId);if(dealClientSelector.SelectedContacts.length>0){jq("#selectedContactID").val(dealClientSelector.SelectedContacts[0])}else{jq("#selectedContactID").val(0)}jq("#selectedMembersID").val(dealMemberSelector.SelectedContacts.join(","));if(jq.getURLParam("id")!=null){jq("div.ajax_info_block span").text(CRMJSResources.EditingDealProgress)}else{jq("div.ajax_info_block span").text(CRMJSResources.AddNewDealProgress)}jq("div.action_block").hide();jq("div.ajax_info_block").show();if(!jq("#isPrivate").is(":checked")){SelectedUsers.IDs=new Array();jq("#cbxNotify").removeAttr("checked")}jq("#isPrivateDeal").val(jq("#isPrivate").is(":checked"));jq("#notifyPrivateUsers").val(jq("#cbxNotify").is(":checked"));jq("#selectedPrivateUsers").val(SelectedUsers.IDs.join(","));var c=jq("#dealForm input[type='checkbox'][id^='custom_field_']");if(c){for(var e=0;e<c.length;e++){if(jq(c[e]).is(":checked")){var f=c[e].id.replace("custom_field_","");jq("#dealForm input[name='customField_"+f+"']").val(jq(c[e]).is(":checked"))}}}return true},gotoAddCustomFieldPage:function(){if(confirm(CRMJSResources.ConfirmGoToCustomFieldPage)){document.location="settings.aspx?type=custom_field&view=opportunity"}}}})(jQuery);ASC.CRM.DealDetailsView=(function(a){return{init:function(){for(var c=0;c<customFieldList.length;c++){var b=customFieldList[c];if(jQuery.trim(b.mask)==""){continue}b.mask=jq.evalJSON(b.mask)}jq("#customFieldTmpl").tmpl(customFieldList).appendTo("#dealInfo");jq("#dealInfo dt.headerBase").each(function(d){var e=jq(this);if(e.next().nextUntil("dt.headerBase").length==0){e.next().remove();e.remove();return}jq(this).click()});jq.dropdownToggle({dropdownID:"dealMilestoneDropDown",switcherSelector:"#dealMilestoneSwitcher",addTop:5,addLeft:jq("#dealMilestoneSwitcher").width()-81})},changeDealMilestone:function(b,c,d){AjaxPro.DealDetailsView.ChangeDealMilestone(b*1,c*1,function(e){if(e.error==null){jq("#dealMilestoneDropDown").hide();jq("#dealMilestoneSwitcher .baseLinkAction").text(d);jq("#dealMilestoneProbability").text(e.value.rs1+"%");if(e.value.rs3=="true"){jq("#closeDealDate span").text(CRMJSResources.ActualCloseDate+":");jq("#closeDealDate p").text(e.value.rs2)}else{if(e.value.rs2!=""){jq("#closeDealDate span").text(CRMJSResources.ExpectedCloseDate+":");jq("#closeDealDate p").text(e.value.rs2)}else{jq("#closeDealDate span").text(CRMJSResources.ExpectedCloseDate+":");jq("#closeDealDate p").text(CRMJSResources.NoCloseDate)}}}})},removeMemberFromDeal:function(b){Teamlab.removeCrmEntityMember({contactID:b},entityData.type,entityData.id,b,{before:function(c){jq("#trashImg_"+c.contactID).hide();jq("#loaderImg_"+c.contactID).show()},after:function(d){var c=jq.inArray(d.contactID,dealContactSelector.SelectedContacts);dealContactSelector.SelectedContacts.splice(c,1);jq("#contactItem_"+d.contactID).animate({opacity:"hide"},500);ASC.CRM.HistoryView.removeOptionFromContact(d.contactID);setTimeout(function(){jq("#contactItem_"+d.contactID).remove();if(dealContactSelector.SelectedContacts.length==0){jq("#addDealParticipantButton").hide();jq("#dealParticipantPanel").hide();jq("#emptyDealParticipantPanel").show()}},500)}})},addMemberToDeal:function(c){if(jq("#contactItem_"+c.id).length>0){return false}var b={contactid:c.id,opportunityid:entityData.id};Teamlab.addCrmEntityMember({},entityData.type,entityData.id,c.id,b,{success:function(e,d){jq("#simpleContactTmpl").tmpl(d).prependTo("#contactTable tbody");ASC.CRM.Common.RegisterContactInfoCard();dealContactSelector.SelectedContacts.push(d.id);ASC.CRM.HistoryView.appendOptionToContact({value:d.id,title:d.displayName})}})}}})(jQuery);ASC.CRM.ExchangeRateView=(function(a){var b=function(){var c=jq("#amount").val().trim();if(c!=""){jq("#introducedAmount").text(c);jq("#conversionResult").text(c*1*ASC.CRM.ExchangeRateView.Rate+" "+jq("#toCurrency").val())}};return{init:function(){ASC.CRM.ExchangeRateView.Rate=1;jq.forceIntegerOnly("#amount",b);jq("#amount").keyup(function(d){b()});ASC.CRM.ExchangeRateView.ExchangeRates={};if(typeof(exchangeRatesArray)!="undefined"){for(var c=0;c<exchangeRatesArray.length;c++){ASC.CRM.ExchangeRateView.ExchangeRates[exchangeRatesArray[c].abbreviation]=exchangeRatesArray[c].value}}},changeCurrency:function(){var c=jq("#fromCurrency").val();var d=jq("#toCurrency").val();AjaxPro.ExchangeRateView.ChangeCurrency(c,d,function(e){if(e.error==null){ASC.CRM.ExchangeRateView.Rate=e.value.Rate;jq("#conversionRate").text("1 "+c+" = "+e.value.Rate+" "+d);jq("#introducedFromCurrency").text(e.value.FromCurrencyTitle+":");jq("#introducedToCurrency").text(e.value.ToCurrencyTitle+":");b()}})},updateSummaryTable:function(c){AjaxPro.ExchangeRateView.UpdateSummaryTable(c,function(e){if(e.error==null){for(var d=0;d<e.value.length;d++){jq("#"+e.value[d].CurrencyAbbr).text(e.value[d].Rate)}}})},renderTotalAmount:function(c,d){jq("#totalOnPage .diferrentBids").html("");jq("#totalOnPage .totalBid").html("");var h=0;var k;var f=false;for(var e=0,g=c.length;e<g;e++){if(c[e].bidCurrencyAbbreviation!=defaultCurrency.Abbreviation){f=true}k=ASC.CRM.ListDealView.numberFormat(c[e].bidValue,{before:c[e].bidCurrencySymbol,thousands_sep:" ",dec_point:d});jq("#bidFormat").tmpl({number:k,abbreviation:c[e].bidCurrencyAbbreviation}).appendTo("#totalOnPage .diferrentBids");if(!c[e].isConvertable){jq("#bidFormat").tmpl({number:k,abbreviation:c[e].bidCurrencyAbbreviation}).appendTo("#totalOnPage .totalBid")}var j=ASC.CRM.ExchangeRateView.ExchangeRates[c[e].bidCurrencyAbbreviation];if(c[e].isConvertable&&typeof(j)!="undefined"){h+=c[e].bidValue/j}}k=ASC.CRM.ListDealView.numberFormat(h,{before:defaultCurrency.Symbol,thousands_sep:" ",dec_point:d});jq("#bidFormat").tmpl({number:k,abbreviation:defaultCurrency.Abbreviation}).prependTo("#totalOnPage .totalBid");if(f==true){jq("#totalOnPage .totalBidAndExchangeRateLink").show()}else{jq("#totalOnPage .totalBidAndExchangeRateLink").hide()}jq("#totalOnPage").show()}}})(jQuery);jq(document).ready(function(){jq.dropdownToggle({switcherSelector:".noContentBlock .hintStages",dropdownID:"files_hintStagesPanel",fixWinSize:false})});if(typeof ASC==="undefined"){ASC={}}if(typeof ASC.CRM==="undefined"){ASC.CRM=function(){return{}}}ASC.CRM.FileUploader=(function(a){return{fileUploader:null,filesUploadedInfo:new Array(),swfu:new Object,fileIDs:new Array(),OnAllUploadCompleteCallback_function:function(){},OnUploadCompleteCallback_function:function(b){ASC.CRM.FileUploader.fileIDs.push(b.Data)},OnBeginCallback_function:function(b){jq(".pm-ajax-info-block span").text(jq.format(CRMJSResources.UploadingProgress,b.CurrentFile))},isFileAPI:function(){return typeof FileReader!="undefined"&&typeof(new XMLHttpRequest()).upload!="undefined"},activateUploader:function(){var f=1000;jq("object[id*='SWFUpload']").before('<span id="asc_fileuploaderSWFObj"></span>');try{jq("object[id*='SWFUpload']").remove()}catch(c){}var b=jq("#pm_upload_btn").attr("id")||jq("#pm_swf_button_container a.pm_upload_btn").attr("id");if(ASC.CRM.FileUploader.isFileAPI()){jq("#pm_swf_button_container").hide();jq("#pm_upload_pnl").hide();b=jq(".pm_upload_btn_html5").attr("id")}else{jq("#pm_swf_button_container").show();jq("#pm_upload_pnl").show()}if(typeof FileReader=="undefined"){jq("#pm_upload_pnl").show()}var d={FileUploadHandler:"ASC.Web.CRM.Classes.FileUploaderHandler, ASC.Web.CRM",AutoSubmit:false,UploadButtonID:b,TargetContainerID:"history_uploadContainer",ProgressTimeSpan:f,Data:{UserID:currUserID},FileSizeLimit:fileSizeLimit,OnAllUploadComplete:ASC.CRM.FileUploader.OnAllUploadCompleteCallback_function,OnUploadComplete:ASC.CRM.FileUploader.OnUploadCompleteCallback_function,OnBegin:ASC.CRM.FileUploader.OnBeginCallback_function,DeleteLinkCSSClass:"pm_deleteLinkCSSClass",LoadingImageCSSClass:"pm_loadingCSSClass",CompleteCSSClass:"pm_completeCSSClass",DragDropHolder:jq("#pm_DragDropHolder"),OverAllProcessHolder:jq("#pm_overallprocessHolder"),OverAllProcessBarCssClass:"pm_overAllProcessBarCssClass",AddFilesText:CRMJSResources.UploadFile,SelectFilesText:CRMJSResources.UploadFile,OverallProgressText:CRMJSResources.OverallProgress};fileUploader=FileHtml5Uploader.InitFileUploader(d);jq("#"+b).unbind("mouseover");setTimeout(function(){jq("#history_uploadContainer").html("")},f+1);jq("#asc_fileuploaderSWFContainer").attr("style","");jq("#"+fileUploader.ButtonID).css("visibility","");jq("#pm_upload_btn_html5").show()},showFileUploaderDialog:function(){var b=jq(window).scrollTop()-135;b=b+"px";jq.blockUI({message:jq("#fileUploaderPanel"),css:{left:"50%",top:"25%",opacity:"1",border:"none",padding:"0px",width:"550px",cursor:"default",textAlign:"left",position:"absolute","margin-left":"-300px","margin-top":b,"background-color":"White"},overlayCSS:{backgroundColor:"#AAA",cursor:"default",opacity:"0.3"},focusInput:false,baseZ:666,fadeIn:0,fadeOut:0})}}})(jQuery);if(typeof ASC==="undefined"){ASC={}}if(typeof ASC.CRM==="undefined"){ASC.CRM=function(){return{}}}ASC.CRM.Reports=(function(){var d={getContacts:function(){alert("1")}};var a=function(){var e=[{label:"?????? 1",color:0,data:[["2010/10/01",0],["2010/11/01",1],["2010/12/01",7]]},{label:"?????? 2",color:1,data:[["2010/10/01",13],["2010/11/01",23],["2010/12/01",32]]}];for(var g=0;g<e.length;++g){for(var f=0;f<e[g].data.length;++f){e[g].data[f][0]=Date.parse(e[g].data[f][0])}}var h={series:{lines:{show:true,lineWidth:2}},xaxis:{mode:"time",timeformat:"%y/%m/%d"}};jq.plot(jq("#placeholder"),e,h)};function b(){c()}function c(){alert("3")}return{callbackMethods:d,bred:a,bred1:b}})();if(typeof ASC==="undefined"){ASC={}}if(typeof ASC.CRM==="undefined"){ASC.CRM=function(){return{}}}ASC.CRM.SettingsPage=(function(a){var g=function(){jq("#customFieldList").sortable({cursor:"move",handle:".sort_row_handle",items:"li",start:function(k,l){jq("#customFieldActionMenu").hide();jq("#customFieldList .crm-menu.active").removeClass("active")},beforeStop:function(k,l){jq(l.item[0]).attr("style","")},update:function(k,m){var l=new Array();jq("#customFieldList li").find("[id^=custom_field_]").each(function(){l.push(jq(this).attr("id").split("_")[2])});AjaxPro.onLoading=function(n){};AjaxPro.CustomFieldsView.ReorderFields(l,function(n){})}})};var f=function(){if(jq("#customFieldActionMenu").length!=1){return}jq("#customFieldActionMenu").show();var k=jq("#customFieldActionMenu .dropDownCornerRight").position().left;jq("#customFieldActionMenu").hide();jq.dropdownToggle({dropdownID:"customFieldActionMenu",switcherSelector:"#customFieldList .crm-menu",addTop:4,addLeft:-k+6,showFunction:function(m,l){jq("#customFieldList .crm-menu.active").removeClass("active");if(l.is(":hidden")){m.addClass("active");if(m.attr("fieldid")!=l.attr("fieldid")){l.attr("fieldid",m.attr("fieldid"))}}},hideFunction:function(){jq("#customFieldList .crm-menu.active").removeClass("active")}})};var e=function(k){for(var l=0,m=ASC.CRM.SettingsPage.customFieldList.length;l<m;l++){if(ASC.CRM.SettingsPage.customFieldList[l].id==k){return l}}return -1};var i=function(){jq("#manageField dl input:first").val("");jq("#manageField dl dd:last ul li:not(:first)").remove();jq("#manageField select").attr("value","0");jq("#manageField dl .field_mask").hide();jq("#manageField dl .text_field").show()};var d=function(l,k){if(jQuery.trim(l.mask)==""){l.maskObj=""}else{l.maskObj=jq.evalJSON(l.mask)}l.relativeItemsCount=k;l.relativeItemsString=ASC.CRM.SettingsPage.getLinkContactStringByIndex(k,jq.getURLParam("type"),jq.getURLParam("view"))};var j=function(){if(jq("#manageField dl input:first").val().trim()==""){ShowRequiredError(jq("#manageField dl input:first"),true);return false}else{RemoveRequiredErrorClass(jq("#manageField dl input:first"));return true}};var h=function(m){var n=jq.getURLParam("view");var k={label:jq("#manageField dl input:first").val().trim(),fieldType:parseInt(jq("#manageField dl select:first").val()),entityType:n!=null&&n!=""?n:"contact",position:m};switch(k.fieldType){case 0:k.mask=jq.toJSON({size:jq("#text_field_size").val()});break;case 1:k.mask=jq.toJSON({rows:jq("#textarea_field_rows").val(),cols:jq("#textarea_field_cols").val()});break;case 2:var l=new Array();jq("#manageField dd.select_options :input").each(function(){var o=jq(this).val().trim();if(o==""){return}l.push(jq(this).val())});if(l.length==0){alert(CRMJSResources.EmptyItemList);return}k.mask=jq.toJSON(l);break;default:k.mask="";break}return k};var b=function(){if(!j()){return}var k=jq("#customFieldList li");var l=h(k.length);var n=0;for(var m=0,o=k.length;m<o;m++){if(jq(k[m]).find(".customFieldTitle").text().trim()==l.label){n=m+1;break}}if(n==0){Teamlab.addCrmCustomField({},l.entityType,l,{before:function(p){jq("#manageField .action_block").hide();jq("#manageField .ajax_info_block").show()},after:function(p){jq("#manageField .action_block").show();jq("#manageField .ajax_info_block").hide()},success:ASC.CRM.SettingsPage.CallbackMethods.add_customField})}else{ASC.CRM.Common.animateElement({element:jq(k[n-1]),afterScrollFunc:jq.unblockUI()})}};var c=function(r,o,q){if(!j()){return}var k=jq("#customFieldList li");var l=h(q);l.id=o;var p=0;for(var m=0,s=k.length;m<s;m++){if(jq(k[m]).find(".customFieldTitle").text().trim()==l.label&&jq(k[m]).not(jq(r)).length!=0){p=m+1;break}}if(p==0){Teamlab.updateCrmCustomField({liObj:r,indexOfField:q},l.entityType,l.id,l,{before:function(){jq("#manageField .action_block").hide();jq("#manageField .ajax_info_block").show()},after:function(){jq("#manageField .action_block").show();jq("#manageField .ajax_info_block").hide()},success:ASC.CRM.SettingsPage.CallbackMethods.edit_customField})}else{ASC.CRM.Common.animateElement({element:jq(k[p-1]),afterScrollFunc:jq.unblockUI()})}};return{CallbackMethods:{add_customField:function(m,l){d(l,0);ASC.CRM.SettingsPage.customFieldList.push(l);var k=jq("#customFieldRowTemplate").tmpl(l);if(jq("#customFieldList li").length==0){jq("#emptyCustomFieldContent").hide();jq("#customFieldList").show()}k.appendTo("#customFieldList");ASC.CRM.Common.animateElement({element:k,afterScrollFunc:jq.unblockUI()})},edit_customField:function(m,l){d(l,0);ASC.CRM.SettingsPage.customFieldList[m.indexOfField]=l;var k=jq("#customFieldRowTemplate").tmpl(l);m.liObj.hide();k.insertAfter(m.liObj);m.liObj.remove();ASC.CRM.Common.animateElement({element:k,afterScrollFunc:jq.unblockUI()})},delete_customField:function(m,k){m.liObj.remove();var l=e(k.id);if(l!=-1){ASC.CRM.SettingsPage.customFieldList.splice(l,1)}if(jq("#customFieldList li").length==0){jq("#customFieldList").hide();jq("#emptyCustomFieldContent").show()}}},init:function(){if(typeof(customFieldList)=="undefined"||typeof(relativeItems)=="undefined"||customFieldList.length!=relativeItems.length){return}for(var k=0,l=customFieldList.length;k<l;k++){d(customFieldList[k],relativeItems[k])}ASC.CRM.SettingsPage.customFieldList=customFieldList;if(ASC.CRM.SettingsPage.customFieldList.length!=0){jq("#customFieldList").show();jq("#customFieldRowTemplate").tmpl(ASC.CRM.SettingsPage.customFieldList).appendTo("#customFieldList")}else{jq("#emptyCustomFieldContent").show()}g();f();jq.forceIntegerOnly("#text_field_size");jq.forceIntegerOnly("#textarea_field_rows");jq.forceIntegerOnly("#textarea_field_cols")},startExportData:function(){jq("#exportDataContent a.baseLinkButton").hide();jq("#exportDataContent p.headerBaseSmall").show();AjaxPro.CommonSettingsView.StartExportData(function(k){if(k.error!=null){alert(k.error.Message);return}ASC.CRM.SettingsPage.checkExportStatus(true)})},changeDefaultCurrency:function(l){var k=jq(l);AjaxPro.onLoading=function(m){if(m){k.attr("disabled",true);k.next().show();k.next("span").hide()}else{k.attr("disabled",false);k.next().hide();k.next().next().show()}};AjaxPro.CommonSettingsView.SaveChangeSettings(k.val(),function(m){if(m.error!=null){alert(m.error.Message);return}})},showAddFieldPanel:function(){jq("#manageField div.containerHeaderBlock td:first").text(ASC.CRM.SettingsPage.PopupWindowText);jq("#manageField div.action_block a.baseLinkButton").text(ASC.CRM.SettingsPage.PopupSaveButtonText);i();RemoveRequiredErrorClass(jq("#manageField dl input:first"));jq("#manageField div.action_block a.baseLinkButton").unbind("click").click(function(){b()});ASC.CRM.Common.blockUI("#manageField",400,400,0)},deleteField:function(){jq("#customFieldActionMenu").hide();jq("#customFieldList .crm-menu.active").removeClass("active");var m=jq("#customFieldActionMenu").attr("fieldid");if(typeof(m)==="undefined"||m==""){return}var k=jq("#fieldMenu_"+m);if(k.length!=1){return}var n=jq(k.parents("li").get(0));var o=jq.getURLParam("view");var l=o!=null&&o!=""?o:"contact";Teamlab.removeCrmCustomField({liObj:n},l,m,{before:function(p){p.liObj.find(".crm-menu").hide();p.liObj.find("div.ajax_loader").show()},success:ASC.CRM.SettingsPage.CallbackMethods.delete_customField})},showEditFieldPanel:function(){jq("#customFieldActionMenu").hide();jq("#customFieldList .crm-menu.active").removeClass("active");var m=jq("#customFieldActionMenu").attr("fieldid");if(typeof(m)==="undefined"||m==""){return}var k=jq("#fieldMenu_"+m);if(k.length!=1){return}var p=jq(k.parents("li").get(0));var o=e(m);if(o===-1){return}var l=ASC.CRM.SettingsPage.customFieldList[o];jq("#manageField div.containerHeaderBlock td:first").text(CRMJSResources.EditSelectedCustomField.replace("{0}",l.label));jq("#manageField div.action_block a.baseLinkButton").text(CRMJSResources.SaveChanges);i();jq("#manageField dl input:first").val(l.label);jq("#manageField dl select:first").val(l.fieldType);jq("#manageField dl .field_mask").hide();switch(l.fieldType){case 0:jq("#text_field_size").val(l.maskObj.size);jq("#manageField dl .text_field").show();break;case 1:jq("#textarea_field_rows").val(l.maskObj.rows);jq("#textarea_field_cols").val(l.maskObj.cols);jq("#manageField dl .textarea_field").show();break;case 2:for(var n=0;n<l.maskObj.length;n++){ASC.CRM.SettingsPage.toSelectBox(jq("#addOptionButton"));jq("#manageField dd.select_options ul li:last input").val(l.maskObj[n])}jq("#manageField dl .select_options").show();break;default:break}RemoveRequiredErrorClass(jq("#manageField dl input:first"));jq("#manageField div.action_block a.baseLinkButton").unbind("click").click(function(){c(p,m,o)});ASC.CRM.Common.blockUI("#manageField",400,400,0)},selectTypeEvent:function(l){var k=l.selectedIndex;var m=parseInt(l.options[k].value);jq("#manageField dl .field_mask").hide();switch(m){case 0:jq("#manageField dl .text_field").show();break;case 1:jq("#manageField dl .textarea_field").show();break;case 2:jq("#manageField dl .select_options").show();break}},toSelectBox:function(k){var l=jq(k).prev();l.children(":first").clone().show().appendTo(l).focus()},getLinkContactStringByIndex:function(k,o,p){var n="";var m="";var l="";if(o==null){o=""}if(p==null){p=""}switch(o.trim()){case"deal_milestone":m=CRMJSResources.OneDeal;l=CRMJSResources.ManyDeals;break;case"contact_stage":m=CRMJSResources.OneContact;l=CRMJSResources.ManyContacts;break;case"task_category":m=CRMJSResources.OneTask;l=CRMJSResources.ManyTasks;break;case"history_category":m=CRMJSResources.OneEvent;l=CRMJSResources.ManyEvents;break;case"custom_field":case"tag":switch(p.trim()){case"deals":m=CRMJSResources.OneDeal;l=CRMJSResources.ManyDeals;break;case"cases":m=CRMJSResources.OneCase;l=CRMJSResources.ManyCases;break;case"company":m=CRMJSResources.OneCompany;l=CRMJSResources.ManyCompanies;break;case"people":m=CRMJSResources.OnePerson;l=CRMJSResources.ManyPersons;break;default:m=CRMJSResources.OneContact;l=CRMJSResources.ManyContacts;break}}if(k==0){return ASC.CRM.SettingsPage.getNoContactString(o,p)}if(k==1){n="1 "+m}else{n=k+" "+l}return n},getNoContactString:function(l,m){var k="";if(l==null){l=""}if(m==null){m=""}switch(l.trim()){case"deal_milestone":k=CRMJSResources.NoDeals;break;case"contact_stage":k=CRMJSResources.NoContacts;break;case"task_category":k=CRMJSResources.NoTasks;break;case"history_category":k=CRMJSResources.NoEvents;break;case"custom_field":case"tag":switch(m.trim()){case"deals":k=CRMJSResources.NoDeals;break;case"cases":k=CRMJSResources.NoCases;break;case"company":k=CRMJSResources.NoCompanies;break;case"people":k=CRMJSResources.NoPersons;break;default:k=CRMJSResources.NoContacts;break}}return k},toggleCollapceExpand:function(k){$Obj=jq(k);var l=$Obj.hasClass("headerCollapse");if(l){$Obj.parents("li").nextUntil("#customFieldList li.expand_collapce_element").show()}else{$Obj.parents("li").nextUntil("#customFieldList li.expand_collapce_element").hide()}$Obj.toggleClass("headerExpand");$Obj.toggleClass("headerCollapse")},changeAuthentication:function(){if(jq("#cbxAuthentication").is(":checked")){jq("#tbxHostLogin").removeAttr("disabled");jq("#tbxHostPassword").removeAttr("disabled")}else{jq("#tbxHostLogin").attr("disabled",true);jq("#tbxHostPassword").attr("disabled",true)}},saveSMTPSettings:function(){jq("#smtpSettingsContent div.errorBox").remove();jq("#smtpSettingsContent div.okBox").remove();var m=jq("#tbxHost").val().trim();var q=jq("#tbxPort").val().trim();var k=jq("#cbxAuthentication").is(":checked");var n=jq("#tbxHostLogin").val().trim();var o=jq("#tbxHostPassword").val().trim();var r=jq("#tbxSenderDisplayName").val().trim();var s=jq("#tbxSenderEmailAddress").val().trim();var l=jq("#cbxEnableSSL").is(":checked");var p=true;if(k&&(m==""||q==""||n==""||o==""||r==""||s=="")){p=false}if(!k&&(m==""||q==""||r==""||s=="")){p=false}if(!p){jq("#smtpSettingsContent").prepend(jq("<div></div>").addClass("errorBox").text(CRMJSResources.EmptyFieldsOfSettings));return}AjaxPro.onLoading=function(t){if(t){}else{}};AjaxPro.CommonSettingsView.SaveSMTPSettings(m,q,k,n,o,r,s,l,function(t){if(t.error!=null){jq("#smtpSettingsContent").prepend(jq("<div></div>").addClass("errorBox").text(t.error.Message));return}jq("#smtpSettingsContent div.errorBox").remove();jq("#smtpSettingsContent").prepend(jq("<div></div>").addClass("okBox").text(CRMJSResources.SettingsUpdated));setTimeout(function(){jq("#smtpSettingsContent div.okBox").remove()},3000)})},checkExportStatus:function(k){AjaxPro.onLoading=function(l){};if(k){ASC.CRM.SettingsPage.closeExportProgressPanel()}AjaxPro.CommonSettingsView.GetStatus(function(l){if(l.error!=null){alert(l.error.Message);return false}if(l.value==null){ASC.CRM.SettingsPage.closeExportProgressPanel();return false}jq("#exportDataContent div.progress_box div.progress").css("width",parseInt(l.value.Percentage)+"%");jq("#exportDataContent div.progress_box span.percent").text(parseInt(l.value.Percentage)+"%");jq("#exportDataContent a.baseLinkButton").hide();jq("#exportDataContent div.progress_box").parent().show();jq("#exportDataContent p.headerBaseSmall").show();jq("#exportDataContent #abortButton").show();jq("#exportDataContent #okButton").hide();if(l.value.Error!=null&&l.value.Error!=""){ASC.CRM.SettingsPage.buildErrorList(l)}else{if(l.value.IsCompleted){jq("#exportDataContent #exportLinkBox span").html(jq("<a></a>").attr("href",l.value.Status).text("exportdata.zip"));jq("#exportDataContent p.headerBaseSmall").hide();jq("#exportDataContent #exportLinkBox").show();jq("#exportDataContent #abortButton").hide();jq("#exportDataContent #okButton").show()}else{setTimeout("ASC.CRM.SettingsPage.checkExportStatus(false)",3000)}}})},abortExport:function(){AjaxPro.onLoading=function(k){};AjaxPro.CommonSettingsView.Cancel(function(k){if(k.error!=null){alert(k.error.Message);return}ASC.CRM.SettingsPage.closeExportProgressPanel()})},closeExportProgressPanel:function(){jq("#exportDataContent div.progress_box div.progress").css("width","0%");jq("#exportDataContent div.progress_box span.percent").text("0%");jq("#exportDataContent #abortButton").show();jq("#exportDataContent #okButton").hide();jq("#exportDataContent div.progress_box").parent().hide();jq("#exportDataContent a.baseLinkButton").show();jq("#exportDataContent #exportErrorBox").hide();jq("#exportDataContent #exportLinkBox").hide();jq("#exportDataContent p.headerBaseSmall").hide();jq("#exportDataContent div.progressErrorBox").html("");jq("#exportDataContent #exportLinkBox span").html("")},buildErrorList:function(l){var k="error";switch(typeof l.value.Error){case"object":k=l.value.Error.Message+"<br/>";break;case"string":k=l.value.Error;break}jq("#exportDataContent div.progressErrorBox").html(jq("<div></div>").addClass("redText").html(k));jq("#exportDataContent #exportErrorBox").show()}}})(jQuery);ASC.CRM.ListItemView=(function(a){var i=function(){jq("#listView").sortable({cursor:"move",handle:".sort_drag_handle",items:"li",start:function(n,o){jq("#colorsPanel").hide();jq(".iconsPanelSettings").hide();jq("#popup_colorsPanel").hide();jq("#listItemActionMenu").hide();jq("#listView .crm-menu.active").removeClass("active")},beforeStop:function(n,o){jq(o.item[0]).attr("style","")},update:function(n,p){var o=new Array();jq("#listView li[id*='list_item_id_']").each(function(){o.push(jq(this).find("td.headerBaseSmall").text())});AjaxPro.onLoading=function(q){};AjaxPro.ListItemView.ReorderItems(o,ASC.CRM.ListItemView.CurrentType,function(q){if(q.error!=null){}})}})};var h=function(){if(jq("#listItemActionMenu").length!=1){return}jq("#listItemActionMenu").show();var n=jq("#listItemActionMenu .dropDownCornerRight").position().left;jq("#listItemActionMenu").hide();jq.dropdownToggle({dropdownID:"listItemActionMenu",switcherSelector:"#listView .crm-menu",addTop:4,addLeft:-n+6,showFunction:function(p,o){jq("#listView .crm-menu.active").removeClass("active");if(o.is(":hidden")){p.addClass("active");if(p.attr("listitemid")!=o.attr("listitemid")){o.attr("listitemid",p.attr("listitemid"))}}},hideFunction:function(){jq("#listView .crm-menu.active").removeClass("active")}})};var f=function(p){for(var o=0,q=ASC.CRM.ListItemView.itemList.length;o<q;o++){if(ASC.CRM.ListItemView.itemList[o].id==p){return o}}return -1};var l=function(){jq("#manageItem input").val("");jq("#manageItem textarea").val("");if(ASC.CRM.ListItemView.CurrentType===2||ASC.CRM.ListItemView.CurrentType===3){var p=jq("#iconsPanel_"+ASC.CRM.ListItemView.CurrentType);if(p.length==1){var o=p.children("img:first");if(o.length==1){jq("#manageItem img.selectedIcon").attr("src",o.attr("src"));jq("#manageItem img.selectedIcon").attr("title",o.attr("title"));jq("#manageItem img.selectedIcon").attr("alt",o.attr("alt"))}}}else{var n=jq("#colorsPanel > div").not(jq("#colorsPanel div.popup-corner"));var q=Math.floor(Math.random()*n.length);jq("#manageItem .selectedColor").css("background-color",ASC.CRM.Common.getHexRGBColor(jq(n.get(q)).css("background-color")))}};var b=function(p,o,n){AjaxPro.ListItemView.ChangeColor(o,n,function(r){if(r.error!=null){alert(r.error.Message);return}var q=f(o);if(q===-1){return}ASC.CRM.ListItemView.itemList[q].color=r.value;jq(p).css("background-color",r.value);jq("#colorsPanel").hide()})};var c=function(q,p,r,s,n){AjaxPro.onLoading=function(t){if(t){jq(q).hide();jq(q).parent().find("div.ajax_change_icon").show()}else{}};var o=r.split("/")[r.split("/").length-1];AjaxPro.ListItemView.ChangeIcon(p,o,function(u){if(u.error!=null){alert(u.error.Message);return}var t=f(p);if(t===-1){return}ASC.CRM.ListItemView.itemList[t].imageName=o;jq(q).attr("src",r);jq(q).attr("title",s);jq(q).attr("alt",n);jq(q).parent().find("div.ajax_change_icon").hide();jq(q).show();jq(".iconsPanelSettings").hide()})};var g=function(r){var o=jq("#iconsPanel_"+ASC.CRM.ListItemView.CurrentType);if(o.length!=1){return null}var q=r.split("/");var p=q[q.length-1].split(".")[0];var n=o.find("#"+p);if(n.length!=1){return null}return n};var j=function(o){o.relativeItemsString=ASC.CRM.SettingsPage.getLinkContactStringByIndex(o.relativeItemsCount,jq.getURLParam("type"),null);if(ASC.CRM.ListItemView.CurrentType===2||ASC.CRM.ListItemView.CurrentType===3){if(o.hasOwnProperty("imagePath")&&o.imagePath!=""){var n=g(o.imagePath);if(n!=null){o.imageTitle=n.attr("title");o.imageAlt=n.attr("alt")}else{o.imageTitle="";o.imageAlt=""}}else{o.imageTitle="";o.imageAlt=""}}};var m=function(){if(jq("#manageItem input:first").val().trim()==""){ShowRequiredError(jq("#manageItem input:first"),true);return false}else{RemoveRequiredErrorClass(jq("#manageItem input:first"));return true}};var k=function(p){var o={title:jq("#manageItem input:first").val().trim(),description:jq("#manageItem textarea").val().trim(),sortOrder:p};if(ASC.CRM.ListItemView.CurrentType===1){o.color=ASC.CRM.Common.getHexRGBColor(jq("#manageItem .selectedColor").css("background-color"))}if(ASC.CRM.ListItemView.CurrentType===2||ASC.CRM.ListItemView.CurrentType===3){var n=jq("#manageItem img.selectedIcon").attr("src");o.imageName=n.split("/")[n.split("/").length-1]}return o};var d=function(){if(!m()){return}var n=jq("#listView li");var q=k(n.length);var p=0;for(var o=0,r=n.length;o<r;o++){if(jq(n[o]).find("td.item_title").text().trim()==q.title){p=o+1;break}}if(p==0){Teamlab.addCrmListItem({},ASC.CRM.ListItemView.CurrentType,q,{before:function(s){jq("#manageItem .action_block").hide();jq("#manageItem .ajax_info_block").show()},after:function(s){jq("#manageItem .action_block").show();jq("#manageItem .ajax_info_block").hide()},success:ASC.CRM.ListItemView.CallbackMethods.add_item})}else{ASC.CRM.Common.animateElement({element:jq(n[p-1]),afterScrollFunc:jq.unblockUI()})}};var e=function(u,p,r){if(!m()){return}var n=jq("#listView li");var s=k(r);s.id=p;var q=0;for(var o=0,t=n.length;o<t;o++){if(jq(n[o]).find("td.item_title").text().trim()==s.title&&jq(n[o]).not(jq(u)).length!=0){q=o+1;break}}if(q==0){Teamlab.updateCrmListItem({liObj:u,indexOfItem:r},ASC.CRM.ListItemView.CurrentType,s.id,s,{before:function(v){jq("#manageItem .action_block").hide();jq("#manageItem .ajax_info_block").show()},after:function(v){jq("#manageItem .action_block").show();jq("#manageItem .ajax_info_block").hide()},success:ASC.CRM.ListItemView.CallbackMethods.edit_item})}else{ASC.CRM.Common.animateElement({element:jq(n[q-1]),afterScrollFunc:jq.unblockUI()})}};return{CallbackMethods:{delete_item:function(p,o){p.liObj.remove();var n=f(o.id);if(n!=-1){ASC.CRM.ListItemView.itemList.splice(n,1)}if(jq("#listView li").length==1){jq(jq("#listView li").get(0)).find(".deleteButtonImg").hide()}},add_item:function(p,o){j(o);ASC.CRM.ListItemView.itemList.push(o);var n=jq("#listItemsTmpl").tmpl(o);if(jq("#listView li").length==1){jq($listItems[0]).find(".deleteButtonImg").show()}n.appendTo("#listView");ASC.CRM.Common.animateElement({element:n,afterScrollFunc:jq.unblockUI()})},edit_item:function(p,o){j(o);ASC.CRM.ListItemView.itemList[p.indexOfItem]=o;var n=jq("#listItemsTmpl").tmpl(o);jq(p.liObj).hide();n.insertAfter(p.liObj);jq(p.liObj).remove();ASC.CRM.Common.animateElement({element:n,afterScrollFunc:jq.unblockUI()})}},init:function(n){ASC.CRM.ListItemView.CurrentType=n;if(typeof(itemList)!="undefined"){itemList=jq.parseJSON(jQuery.base64.decode(itemList)).response}else{itemList=[]}for(var o=0,p=itemList.length;o<p;o++){j(itemList[o])}ASC.CRM.ListItemView.itemList=itemList;jq("#listItemsTmpl").tmpl(ASC.CRM.ListItemView.itemList).appendTo("#listView");if(ASC.CRM.ListItemView.itemList.length==1){jq("#listView li .deleteButtonImg").hide()}i();h();ASC.CRM.ListItemView.IsDropdownToggleRegistered=false;if(ASC.CRM.ListItemView.CurrentType===2||ASC.CRM.ListItemView.CurrentType===3){jq.dropdownToggle({dropdownID:"iconsPanel_"+ASC.CRM.ListItemView.CurrentType,switcherSelector:"#listView img.currentIcon",noActiveSwitcherSelector:"#manageItem .change_icon",addTop:5,addLeft:-20})}else{jq.dropdownToggle({dropdownID:"colorsPanel",switcherSelector:"#listView .currentColor",noActiveSwitcherSelector:"#manageItem .change_color",addTop:5,addLeft:-20})}},showAddItemPanel:function(){jq("#manageItem div.containerHeaderBlock td:first").text(ASC.CRM.ListItemView.PopupWindowText);jq("#manageItem div.action_block a.baseLinkButton").text(ASC.CRM.ListItemView.PopupSaveButtonText);l();jq("#manageItem div.action_block a.baseLinkButton").unbind("click").click(function(){d()});RemoveRequiredErrorClass(jq("#manageItem input:first"));PopupKeyUpActionProvider.CloseDialogAction="javascript:jq('.iconsPanelSettings').hide();jq('#colorsPanel').hide();jq('#popup_colorsPanel').hide();";ASC.CRM.Common.blockUI("#manageItem",400,400,0);if(!ASC.CRM.ListItemView.IsDropdownToggleRegistered){ASC.CRM.ListItemView.IsDropdownToggleRegistered=true;if(ASC.CRM.ListItemView.CurrentType===2||ASC.CRM.ListItemView.CurrentType===3){jq.dropdownToggle({dropdownID:"popup_iconsPanel_"+ASC.CRM.ListItemView.CurrentType,switcherSelector:"#manageItem .change_icon",noActiveSwitcherSelector:"#listView img.currentIcon",addTop:5,addLeft:jq("#manageItem .change_icon").width()-30,position:"fixed"})}else{jq.dropdownToggle({dropdownID:"popup_colorsPanel",switcherSelector:"#manageItem .change_color",noActiveSwitcherSelector:"#listView .currentColor",addTop:5,addLeft:jq("#manageItem .change_color").width()-21,position:"fixed"})}}},showEditItemPanel:function(){jq("#listItemActionMenu").hide();jq("#listView .crm-menu.active").removeClass("active");var s=jq("#listItemActionMenu").attr("listitemid");if(typeof(s)==="undefined"||s==""){return}var p=f(s);if(p===-1){return}var q=ASC.CRM.ListItemView.itemList[p];var r=jq("#list_item_id_"+s);if(r.length!=1){return}jq("#manageItem div.containerHeaderBlock td:first").text(ASC.CRM.ListItemView.PopupWindowEditButtonText.replace("{0}",q.title));jq("#manageItem div.action_block a.baseLinkButton").text(CRMJSResources.SaveChanges);jq("#manageItem input:first").val(q.title);jq("#manageItem textarea").val(q.description);jq("#manageItem div.add_params input").val(q.additionalParams);if(jq(r).find("img.currentIcon").length>0){var o=jq(r).find("img.currentIcon");jq("#manageItem img.selectedIcon").attr("src",jq(o).attr("src"));jq("#manageItem img.selectedIcon").attr("title",jq(o).attr("title"));jq("#manageItem img.selectedIcon").attr("alt",jq(o).attr("alt"))}else{var n=jq(r).find("div.currentColor").css("background-color");jq("#manageItem .selectedColor").css("background-color",n)}jq("#manageItem div.action_block a.baseLinkButton").unbind("click").click(function(){e(r,q.id,p)});RemoveRequiredErrorClass(jq("#manageItem input:first"));PopupKeyUpActionProvider.CloseDialogAction="javascript:jq('.iconsPanelSettings').hide();jq('#colorsPanel').hide();jq('#popup_colorsPanel').hide();";ASC.CRM.Common.blockUI("#manageItem",400,400,0);if(!ASC.CRM.ListItemView.IsDropdownToggleRegistered){ASC.CRM.ListItemView.IsDropdownToggleRegistered=true;if(ASC.CRM.ListItemView.CurrentType===2||ASC.CRM.ListItemView.CurrentType===3){jq.dropdownToggle({dropdownID:"popup_iconsPanel_"+ASC.CRM.ListItemView.CurrentType,switcherSelector:"#manageItem .change_icon",noActiveSwitcherSelector:"#listView img.currentIcon",addTop:5,addLeft:jq("#manageItem .change_icon").width()-30,position:"fixed"})}else{jq.dropdownToggle({dropdownID:"popup_colorsPanel",switcherSelector:"#manageItem .change_color",noActiveSwitcherSelector:"#listView .currentColor",addTop:5,addLeft:jq("#manageItem .change_color").width()-21,position:"fixed"})}}},deleteItem:function(){jq("#listItemActionMenu").hide();jq("#listView .crm-menu.active").removeClass("active");var o=jq("#listItemActionMenu").attr("listitemid");if(typeof(o)==="undefined"||o==""){return}var n=jq("#list_item_id_"+o);if(n.length!=1){return}if(jq("#listView li").length==1){if(ASC.CRM.ListItemView.CurrentType==1){alert(jq.format(CRMJSResources.ErrorTheLastContactStage,jq(n).find(".item_title").text())+"\n"+CRMJSResources.PleaseRefreshThePage);jq("#listView").find(".crm-menu").hide();return}if(ASC.CRM.ListItemView.CurrentType==2){alert(jq.format(CRMJSResources.ErrorTheLastTaskCategory,jq(n).find(".item_title").text())+"\n"+CRMJSResources.PleaseRefreshThePage);jq("#listView").find(".crm-menu").hide();return}return}Teamlab.removeCrmListItem({liObj:n},ASC.CRM.ListItemView.CurrentType,o,{before:function(p){p.liObj.find(".crm-menu").hide();p.liObj.find("div.ajax_loader").show()},success:ASC.CRM.ListItemView.CallbackMethods.delete_item})},showColorsPanel:function(n){jq("#colorsPanel > div").not(jq("#colorsPanel div.popup-corner")).unbind("click").click(function(){b(n,jq(n).parents("li").get(0).id.replace("list_item_id_","")*1,ASC.CRM.Common.getHexRGBColor(jq(this).css("background-color")))})},showColorsPanelToSelect:function(){jq("#popup_colorsPanel > div").not(jq("#popup_colorsPanel div.popup-corner")).unbind("click").click(function(){jq("#manageItem .selectedColor").css("background",ASC.CRM.Common.getHexRGBColor(jq(this).css("background-color")));jq("#popup_colorsPanel").hide()})},showIconsPanel:function(o){var n=jq("#iconsPanel_"+ASC.CRM.ListItemView.CurrentType);if(n.length!=1){return}n.children("img").unbind("click").click(function(){c(o,jq(o).parents("li").get(0).id.replace("list_item_id_","")*1,jq(this).attr("src"),jq(this).attr("title"),jq(this).attr("alt"))})},showIconsPanelToSelect:function(){var n=jq("#popup_iconsPanel_"+ASC.CRM.ListItemView.CurrentType);if(n.length!=1){return}n.children("img").unbind("click").click(function(){jq("#manageItem img.selectedIcon").attr("src",jq(this).attr("src"));jq("#manageItem img.selectedIcon").attr("title",jq(this).attr("title"));jq("#manageItem img.selectedIcon").attr("alt",jq(this).attr("alt"));n.hide()})}}})(jQuery);ASC.CRM.DealMilestoneView=(function(a){var h=function(){jq("#dealMilestoneList").sortable({cursor:"move",handle:".sort_drag_handle",items:"li",start:function(k,l){jq("#colorsPanel").hide();jq("#popup_colorsPanel").hide();jq("#dealMilestoneActionMenu").hide();jq("#dealMilestoneList .crm-menu.active").removeClass("active")},beforeStop:function(k,l){jq(l.item[0]).attr("style","")},update:function(k,m){var l=new Array();jq("#dealMilestoneList li[id^='deal_milestone_id_']").each(function(){l.push(jq(this).attr("id").replace("deal_milestone_id_","")*1)});AjaxPro.DealMilestoneView.ReorderDealMilestone(l,function(n){if(n.error!=null){}})}})};var g=function(){jq("#dealMilestoneActionMenu").show();var k=jq("#dealMilestoneActionMenu .dropDownCornerRight").position().left;jq("#dealMilestoneActionMenu").hide();jq.dropdownToggle({dropdownID:"dealMilestoneActionMenu",switcherSelector:"#dealMilestoneList .crm-menu",addTop:4,addLeft:-k+6,showFunction:function(m,l){jq("#dealMilestoneList .crm-menu.active").removeClass("active");if(l.is(":hidden")){m.addClass("active");if(m.attr("dealmilestoneid")!=l.attr("dealmilestoneid")){l.attr("dealmilestoneid",m.attr("dealmilestoneid"))}}},hideFunction:function(){jq("#dealMilestone .crm-menu.active").removeClass("active")}})};var j=function(){jq("#manageDealMilestone .title").val("");jq("#manageDealMilestone .probability").val("0");jq("#manageDealMilestone textarea").val("");jq("#manageDealMilestone [name=deal_milestone_status]:first").attr("checked",true);var k=jq("#colorsPanel > div").not(jq("#colorsPanel div.popup-corner"));var l=Math.floor(Math.random()*k.length);jq("#manageDealMilestone .selectedColor").css("background-color",ASC.CRM.Common.getHexRGBColor(jq(k.get(l)).css("background-color")))};var f=function(l){for(var k=0,m=ASC.CRM.DealMilestoneView.dealMilestoneList.length;k<m;k++){if(ASC.CRM.DealMilestoneView.dealMilestoneList[k].id==l){return k}}return -1};var b=function(m,l,k){AjaxPro.DealMilestoneView.ChangeColor(l,k,function(n){if(n.error!=null){alert(n.error.Message);return}jq(m).css("background",n.value);jq("#colorsPanel").hide()})};var d=function(k){k.relativeItemsString=ASC.CRM.SettingsPage.getLinkContactStringByIndex(k.relativeItemsCount,jq.getURLParam("type"),null)};var i=function(m){var k={title:jq("#manageDealMilestone .title").val().trim(),sortOrder:m};k.description=jq("#manageDealMilestone dl textarea").val().trim();k.color=ASC.CRM.Common.getHexRGBColor(jq("#manageDealMilestone .selectedColor").css("background-color"));var l=jq("#manageDealMilestone .probability").val();if(l*1>100){l="100"}k.successProbability=l;k.stageType=jq("#manageDealMilestone [name=deal_milestone_status]:checked").val()*1;return k};var e=function(q,n){if(jq("#manageDealMilestone .title").val().trim()==""){ShowRequiredError(jq("#manageDealMilestone .title"),true);return}else{RemoveRequiredErrorClass(jq("#manageDealMilestone .title"))}var k=jq("#dealMilestoneList li");var l=i(k.length);l.id=n;var o=0;for(var m=0,p=k.length;m<p;m++){if(jq(k[m]).find("td.deal_milestone_title").text().trim()==l.title&&jq(k[m]).not(jq(q)).length!=0){o=m+1;break}}if(o==0){Teamlab.updateCrmDealMilestone({liObj:q},l.id,l,{before:function(){jq("#manageDealMilestone .action_block").hide();jq("#manageDealMilestone .ajax_info_block").show()},after:function(){jq("#manageDealMilestone .action_block").show();jq("#manageDealMilestone .ajax_info_block").hide()},success:ASC.CRM.DealMilestoneView.CallbackMethods.edit_dealMilestone})}else{ASC.CRM.Common.animateElement({element:jq(k[o-1]),afterScrollFunc:jq.unblockUI()})}};var c=function(){if(jq("#manageDealMilestone .title").val().trim()==""){ShowRequiredError(jq("#manageDealMilestone .title"),true);return}else{RemoveRequiredErrorClass(jq("#manageDealMilestone .title"))}var k=jq("#dealMilestoneList li");var l=i(k.length);var n=0;for(var m=0,o=k.length;m<o;m++){if(jq(k[m]).find("td.deal_milestone_title").text().trim()==l.title){n=m+1;break}}if(n==0){Teamlab.addCrmDealMilestone({},l,{before:function(){jq("#manageDealMilestone .action_block").hide();jq("#manageDealMilestone .ajax_info_block").show()},after:function(){jq("#manageDealMilestone .action_block").show();jq("#manageDealMilestone .ajax_info_block").hide()},success:ASC.CRM.DealMilestoneView.CallbackMethods.add_dealMilestone})}else{ASC.CRM.Common.animateElement({element:jq(k[n-1]),afterScrollFunc:jq.unblockUI()})}};return{CallbackMethods:{add_dealMilestone:function(m,l){d(l);ASC.CRM.DealMilestoneView.dealMilestoneList.push(l);var k=jq("#dealMilestoneTmpl").tmpl(l);k.appendTo("#dealMilestoneList");ASC.CRM.Common.animateElement({element:k,afterScrollFunc:jq.unblockUI()})},edit_dealMilestone:function(n,l){d(l);var m=f(l.id);if(m!=-1){ASC.CRM.DealMilestoneView.dealMilestoneList[m]=l}var k=jq("#dealMilestoneTmpl").tmpl(l);n.liObj.hide();k.insertAfter(n.liObj);n.liObj.remove();ASC.CRM.Common.animateElement({element:k,afterScrollFunc:jq.unblockUI()})},delete_dealMilestone:function(m,k){m.liObj.remove();var l=f(k.id);if(l!=-1){ASC.CRM.DealMilestoneView.dealMilestoneList.splice(l,1)}}},init:function(){if(typeof(dealMilestoneList)!="undefined"){dealMilestoneList=jq.parseJSON(jQuery.base64.decode(dealMilestoneList)).response}else{dealMilestoneList=[]}ASC.CRM.DealMilestoneView.dealMilestoneList=Teamlab.create("crm-dealmilestone",null,dealMilestoneList);for(var k=0,l=ASC.CRM.DealMilestoneView.dealMilestoneList.length;k<l;k++){d(ASC.CRM.DealMilestoneView.dealMilestoneList[k])}jq("#dealMilestoneTmpl").tmpl(ASC.CRM.DealMilestoneView.dealMilestoneList).appendTo("#dealMilestoneList");h();g();ASC.CRM.DealMilestoneView.IsDropdownToggleRegistered=false;jq.dropdownToggle({dropdownID:"colorsPanel",switcherSelector:"#dealMilestoneList .currentColor",noActiveSwitcherSelector:"#manageDealMilestone .change_color",addTop:5,addLeft:-20});jq.forceIntegerOnly("#manageDealMilestone .probability")},showAddDealMilestonePanel:function(){jq("#manageDealMilestone div.containerHeaderBlock td:first").text(ASC.CRM.DealMilestoneView.PopupWindowText);jq("#manageDealMilestone div.action_block a.baseLinkButton").text(ASC.CRM.DealMilestoneView.PopupSaveButtonText);j();jq("#manageDealMilestone div.action_block a.baseLinkButton").unbind("click").click(function(){c()});RemoveRequiredErrorClass(jq("#manageDealMilestone .title"));ASC.CRM.Common.blockUI("#manageDealMilestone",400,400,0);if(!ASC.CRM.DealMilestoneView.IsDropdownToggleRegistered){ASC.CRM.DealMilestoneView.IsDropdownToggleRegistered=true;jq.dropdownToggle({dropdownID:"popup_colorsPanel",switcherSelector:"#manageDealMilestone .change_color",noActiveSwitcherSelector:"#dealMilestoneList .currentColor",addTop:5,addLeft:jq("#manageDealMilestone .change_color").width()-21,position:"fixed"})}},showEditDealMilestonePanel:function(){jq("#dealMilestoneActionMenu").hide();jq("#dealMilestoneList .crm-menu.active").removeClass("active");var l=jq("#dealMilestoneActionMenu").attr("dealmilestoneid");if(typeof(l)==="undefined"||l==""){return}var n=jq("#deal_milestone_id_"+l);if(n.length!=1){return}var m=f(l);if(m===-1){return}var k=ASC.CRM.DealMilestoneView.dealMilestoneList[m];jq("#manageDealMilestone div.containerHeaderBlock td:first").text(ASC.CRM.DealMilestoneView.PopupWindowEditButtonText.replace("{0}",k.title));jq("#manageDealMilestone div.action_block a.baseLinkButton").text(CRMJSResources.SaveChanges);jq("#manageDealMilestone .title").val(k.title);jq("#manageDealMilestone textarea").val(k.description);jq("#manageDealMilestone .probability").val(k.successProbability);jq("#manageDealMilestone [name=deal_milestone_status][value="+k.stageType+"]").attr("checked",true);jq("#manageDealMilestone div.action_block a.baseLinkButton").unbind("click").click(function(){e(n,k.id)});jq("#manageDealMilestone .selectedColor").css("background-color",k.color);RemoveRequiredErrorClass(jq("#manageDealMilestone .title"));ASC.CRM.Common.blockUI("#manageDealMilestone",400,400,0);if(!ASC.CRM.DealMilestoneView.IsDropdownToggleRegistered){ASC.CRM.DealMilestoneView.IsDropdownToggleRegistered=true;jq.dropdownToggle({dropdownID:"popup_colorsPanel",switcherSelector:"#manageDealMilestone .change_color",noActiveSwitcherSelector:"#dealMilestoneList .currentColor",addTop:5,addLeft:jq("#manageDealMilestone .change_color").width()-21,position:"fixed"})}},deleteDealMilestone:function(){jq("#dealMilestoneActionMenu").hide();jq("#dealMilestoneList .crm-menu.active").removeClass("active");var k=jq("#dealMilestoneActionMenu").attr("dealmilestoneid");if(typeof(k)==="undefined"||k==""){return}var l=jq("#deal_milestone_id_"+k);if(l.length!=1){return}if(jq("#dealMilestoneList li").length==0){alert(CRMJSResources.ErrorTheLastDealMilestone);return}Teamlab.removeCrmDealMilestone({liObj:l},k,{before:function(m){m.liObj.find(".crm-menu").hide();m.liObj.find("div.ajax_loader").show()},success:ASC.CRM.DealMilestoneView.CallbackMethods.delete_dealMilestone})},showColorsPanel:function(k){jq("#colorsPanel > div").not(jq("#colorsPanel div.popup-corner")).unbind("click").click(function(){b(k,jq(k).parents("li").get(0).id.replace("deal_milestone_id_","")*1,ASC.CRM.Common.getHexRGBColor(jq(this).css("background-color")))})},showColorsPanelToSelect:function(){jq("#popup_colorsPanel > div").not(jq("#popup_colorsPanel div.popup-corner")).unbind("click").click(function(){jq("#manageDealMilestone .selectedColor").css("background",ASC.CRM.Common.getHexRGBColor(jq(this).css("background-color")));jq("#popup_colorsPanel").hide()})}}})(jQuery);ASC.CRM.TagSettingsView=(function(a){var b=function(d,c){d.relativeItemsCount=c;d.relativeItemsString=ASC.CRM.SettingsPage.getLinkContactStringByIndex(c,jq.getURLParam("type"),jq.getURLParam("view"))};return{CallbackMethods:{add_tag:function(d,e){e={value:e};b(e,0);var c=jq("#tagRowTemplate").tmpl(e);if(d.tagsCount==0){jq("#emptyTagContent").hide();jq("#tagList").show();jq("#deleteUnusedTagsButton").show()}c.appendTo("#tagList");ASC.CRM.Common.animateElement({element:c,afterScrollFunc:jq.unblockUI()})},delete_tag:function(c,d){c.liObj.remove();if(jq("#tagList li").length==0){jq("#tagList").hide();jq("#deleteUnusedTagsButton").hide();jq("#emptyTagContent").show()}}},init:function(){if(typeof(tagList)=="undefined"||typeof(relativeItemsCountArray)=="undefined"||tagList.length!=relativeItemsCountArray.length){return}for(var c=0,d=tagList.length;c<d;c++){b(tagList[c],relativeItemsCountArray[c])}if(tagList.length!=0){jq("#tagList").show();jq("#deleteUnusedTagsButton").show();jq("#tagRowTemplate").tmpl(tagList).appendTo("#tagList")}else{jq("#emptyTagContent").show()}},showAddTagPanel:function(){jq("#tagTitle").val("");RemoveRequiredErrorClass(jq("#tagTitle"));ASC.CRM.Common.blockUI("#manageTag",400,400,0)},createTag:function(){var h=jq.trim(jq("#tagTitle").val());if(h==""){ShowRequiredError(jq("#tagTitle"),true);return}else{RemoveRequiredErrorClass(jq("#tagTitle"))}var f=0;var c=jq("#tagList li");var g=c.length;for(var e=0;e<g;e++){if(jq(c[e]).find(".title").text().trim()==h){f=e+1;break}}if(f==0){var j=jq.getURLParam("view");var d=j!=null&&j!=""?j:"contact";Teamlab.addCrmEntityTag({view:j,tagsCount:g},d,h,{before:function(i){jq("#manageTag .action_block").hide();jq("#manageTag .ajax_info_block").show()},success:ASC.CRM.TagSettingsView.CallbackMethods.add_tag,after:function(){jq("#manageTag .action_block").show();jq("#manageTag .ajax_info_block").hide()}})}else{ASC.CRM.Common.animateElement({element:jq(c[f-1]),afterScrollFunc:jq.unblockUI()})}},deleteTag:function(c){var e=jq(jq(c).parents("li").get(0));var f=e.find(".title").text().trim();var g=jq.getURLParam("view");var d=g!=null&&g!=""?g:"contact";Teamlab.removeCrmEntityTag({liObj:e},d,Encoder.htmlDecode(f),{before:function(h){h.liObj.find(".deleteButtonImg").hide();h.liObj.find("div.ajax_loader").show()},success:ASC.CRM.TagSettingsView.CallbackMethods.delete_tag})},deleteUnusedTags:function(){var d=jq.getURLParam("view");var c=d!=null&&d!=""?d:"contact";Teamlab.removeCrmUnusedTag({},c,{success:function(h,k){var e=jq("#tagList li");for(var g=0;g<k.length;g++){for(var f=0;f<e.length;f++){if(jq(e[f]).find(".title").text().trim()==k[g]){jq(e[f]).remove()}}}if(jq("#tagList li").length==0){jq("#tagList").hide();jq("#deleteUnusedTagsButton").hide();jq("#emptyTagContent").show()}}})}}})(jQuery);ASC.CRM.SettingsPage.WebToLeadFormView=(function(a){function b(p,f){var n=p.length%3>0?3-p.length%3:0;var g=0;var o;var d;var k;var m;var j=0;var l=jq("input[name=radio]:checked").val()=="company";jq(p).each(function(){if(!l&&(this.name=="firstName"||this.name=="lastName")){this.disabled=true}else{if(l&&this.name=="companyName"){this.disabled=true}else{this.disabled=false}}});for(var h=0;h<p.length+n;h++){if(g==0){o=jq("<tr></tr>")}d=jq("<td></td>").attr("width","33%");if(p[h]!=null){k=jq("<input>").attr("type","checkbox").attr("id",p[h].name).attr("name",p[h].name);if(p[h].disabled){jq(k).attr("checked",true).attr("disabled",true)}m=jq("<label>").attr("for",p[h].name).text(p[h].title);k.data("fieldInfo",p[h]);d.append(k).append(m)}o.append(d);g++;if(g==3||h==p.length+n-1){var e=o.children();if(j%2==0){e.addClass("tintMedium")}else{e.addClass("tintLight")}f.append(o);g=0;j++}}}function c(){var h=/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/;var i=jq("#returnURL").val().trim();var j=jq("#properties_webFormKey input").val().trim();var f=true;if(i==""||!h.test(i)){ShowRequiredError(jq("#returnURL"));f=false}else{RemoveRequiredErrorClass(jq("#returnURL"))}if(j==""){ShowRequiredError(jq("#properties_webFormKey input"));f=false}else{RemoveRequiredErrorClass(jq("#properties_webFormKey input"))}var e=jq("#tblFieldList input[name='firstName']:checked");var g=jq("#tblFieldList input[name='lastName']:checked");var d=jq("#tblFieldList input[name='companyName']:checked");if((e.length==0||g.length==0)&&d.length==0){alert(CRMJSResources.ErrorNotMappingBasicColumn);f=false}return f}return{init:function(){if(!(typeof columnSelectorData==="undefined")){b(columnSelectorData,jq("#tblFieldList tbody"))}jq("#privateSettingsBlock").parent().removeClass("tintMedium").css("padding","0px");var d=jq("#privateSettingsBlock").parent().find("span:first").text()+":";jq("#privateSettingsBlock").parent().find("span:first").replaceWith(jq("<div><div>").text(d).css("font-weight","bold"))},changeContactType:function(){jq("#tblFieldList tbody").html("");jq(columnSelectorData).each(function(){this.disabled=false});b(columnSelectorData,jq("#tblFieldList tbody"))},changeWebFormKey:function(){if(!confirm(CRMJSResources.ConfirmChangeKey+"\n"+CRMJSResources.ConfirmChangeKeyNote)){return false}AjaxPro.onLoading=function(d){if(d){}else{}};AjaxPro.WebToLeadFormView.ChangeWebFormKey(function(d){if(d.error!=null){alert(d.error.Message)}jq("#properties_webFormKey input").val(d.value);jq("#webFormKeyContainer").html(d.value)})},generateSampleForm:function(){if(!c()){return}var d=jQuery.map(jq("#tblFieldList input:checked"),function(i){return jq(i).data("fieldInfo")});var o=jq.map(jq("#tagContainer .tag_title"),function(i){return{name:"tag_"+jq(i).text().trim(),title:jq(i).text().trim()}});if(d.length==0){jq("#resultContainer, #previewHeader").hide();jq("#previewHeader div.content").html("");return}var h="";var k="";if(jq("#isPrivate").is(":checked")){var l=new Array(SelectedUsers.CurrentUserID);for(var f=0;f<SelectedUsers.IDs.length;f++){l.push(SelectedUsers.IDs[f])}k=l.join(",");if(jq("#cbxNotify").is(":checked")){h=l.join(",")}}if(SelectedUsers_Notify.IDs.length!=0){var j=new Array();for(var f=0,g=SelectedUsers_Notify.IDs.length;f<g;f++){j.push(SelectedUsers_Notify.IDs[f])}h=j.join(",")}var e=jq("<div>");jq("#sampleFormTmpl").tmpl({fieldListInfo:d,tagListInfo:o,returnURL:jq("#returnURL").val(),webFormKey:jq("#properties_webFormKey input").val(),notifyList:h,privateList:k}).appendTo(e);var m=e.html().replace(/\s{1,}/g," ");jq("#resultContainer textarea").val(m);jq("#resultContainer").show();jq("#previewHeader div.content").html(m);jq("#previewHeader").show()}}})(jQuery);ASC.CRM.TaskTemplateView=(function(a){function b(){if(jq("#templateConatainerContent li").length!=0){jq("#emptyContent").hide();jq("#templateConatainerContent").show()}else{jq("#templateConatainerContent").hide();jq("#emptyContent").show()}}return{init:function(){if(typeof(templateConatainerList)!="undefined"){templateConatainerList=jq.parseJSON(jQuery.base64.decode(templateConatainerList)).response}else{templateConatainerList=[]}jq.forceIntegerOnly("#templatePanel #tbxTemplateDisplacement");jq("#templateContainerRow").tmpl(templateConatainerList).appendTo("#templateConatainerContent");b();for(var c=0;c<templateConatainerList.length;c++){if(templateConatainerList[c].items){for(var d=0;d<templateConatainerList[c].items.length;d++){ASC.CRM.Common.tooltip("#templateTitle_"+templateConatainerList[c].items[d].id,"tooltip",true)}}}},showTemplateConatainerPanel:function(c){if(!c){ASC.CRM.TaskTemplateView.initTemplateConatainerPanel();ASC.CRM.Common.blockUI("#templateConatainerPanel",500,500,0)}else{Teamlab.getCrmEntityTaskTemplateContainer({},c,{success:function(d,e){ASC.CRM.TaskTemplateView.initTemplateConatainerPanel(e);ASC.CRM.Common.blockUI("#templateConatainerPanel",500,500,0)}})}},createTemplateConatainer:function(){var d=jq("#templateConatainerTitle").val().trim();var e=jq.getURLParam("view");var c=e!=null&&e!=""?e:"contact";if(d==""){ShowRequiredError(jq("#templateConatainerTitle"),true);return false}else{RemoveRequiredErrorClass(jq("#templateConatainerTitle"))}Teamlab.addCrmEntityTaskTemplateContainer({},{entityType:c,title:d},{success:function(f,g){jq("#templateContainerRow").tmpl(g).appendTo("#templateConatainerContent");b()},before:function(f){jq("#templateConatainerPanel div.action_block").hide();jq("#templateConatainerPanel div.ajax_info_block").show()},after:function(f){jq("#templateConatainerPanel div.ajax_info_block").hide();jq("#templateConatainerPanel div.action_block").show();jq.unblockUI()}})},editTemplateConatainer:function(c){var e=jq("#templateConatainerTitle").val().trim();var f=jq.getURLParam("view");var d=f!=null&&f!=""?f:"contact";if(e==""){ShowRequiredError(jq("#templateConatainerTitle"),true);return false}else{RemoveRequiredErrorClass(jq("#templateConatainerTitle"))}Teamlab.updateCrmEntityTaskTemplateContainer({},c,{entityType:d,title:e},{success:function(h,i){jq("#templateContainerBody_"+c).remove();var g=jq("#templateContainerRow").tmpl(i);jq("#templateContainerHeader_"+c).replaceWith(g)},before:function(g){jq("#templateConatainerPanel div.action_block").hide();jq("#templateConatainerPanel div.ajax_info_block").show()},after:function(g){jq("#templateConatainerPanel div.ajax_info_block").hide();jq("#templateConatainerPanel div.action_block").show();jq.unblockUI()}})},deleteTemplateConatainer:function(c){Teamlab.removeCrmEntityTaskTemplateContainer({},c,{success:function(d,e){jq("#templateContainerHeader_"+c).remove();jq("#templateContainerBody_"+c).remove();b()},before:function(d){jq("#templateContainerHeader_"+c+" img.addImg").hide();jq("#templateContainerHeader_"+c+" img.editImg").hide();jq("#templateContainerHeader_"+c+" img.deleteImg").hide();jq("#templateContainerHeader_"+c+" img.loaderImg").show()}})},initTemplateConatainerPanel:function(c){if(!c){jq("#templateConatainerTitle").val("");RemoveRequiredErrorClass(jq("#templateConatainerTitle"));jq("#templateConatainerPanel div.containerHeaderBlock td:first").text(ASC.CRM.TaskTemplateView.ConatainerPanel_AddHeaderText);jq("#templateConatainerPanel div.action_block a.baseLinkButton").text(ASC.CRM.TaskTemplateView.ConatainerPanel_AddButtonText).unbind("click").click(function(){ASC.CRM.TaskTemplateView.createTemplateConatainer()})}else{jq("#templateConatainerTitle").val(c.title);RemoveRequiredErrorClass(jq("#templateConatainerTitle"));jq("#templateConatainerPanel div.containerHeaderBlock td:first").text(jq.format(ASC.CRM.TaskTemplateView.ConatainerPanel_EditHeaderText,c.title));jq("#templateConatainerPanel div.action_block a.baseLinkButton").text(CRMJSResources.SaveChanges).unbind("click").click(function(){ASC.CRM.TaskTemplateView.editTemplateConatainer(c.id)})}},toggleCollapceExpand:function(d){$Obj=jq(d);if($Obj.hasClass("headerCollapse")){var c=$Obj.parents("li").next();if(c.find("table").length>0){c.show()}}else{$Obj.parents("li").next().hide()}$Obj.toggleClass("headerExpand");$Obj.toggleClass("headerCollapse")},showTemplatePanel:function(c,d){if(!d){ASC.CRM.TaskTemplateView.initTemplatePanel(c);ASC.CRM.Common.blockUI("#templatePanel",500,500,0)}else{Teamlab.getCrmEntityTaskTemplate({},d,{success:function(e,f){ASC.CRM.TaskTemplateView.initTemplatePanel(c,f);ASC.CRM.Common.blockUI("#templatePanel",500,500,0)}})}},createTemplate:function(c){var d=ASC.CRM.TaskTemplateView.getCurrentTemplateData();d.containerid=c;if(d.title==""){ShowRequiredError(jq("#tbxTemplateTitle"),true);return false}else{RemoveRequiredErrorClass(jq("#tbxTemplateTitle"))}if(d.responsibleid==null){ShowRequiredError(jq("#templatePanel #inputUserName"),true);return false}else{RemoveRequiredErrorClass(jq("#templatePanel #inputUserName"))}Teamlab.addCrmEntityTaskTemplate({},d,{success:function(e,f){jq("#templateRow").tmpl(f).appendTo("#templateContainerBody_"+c);if(jq("#templateContainerBody_"+c+" table").length>0){jq("#templateContainerBody_"+c).show()}ASC.CRM.Common.tooltip("#templateTitle_"+f.id,"tooltip",true)},before:function(e){jq("#templatePanel div.action_block").hide();jq("#templatePanel div.ajax_info_block").show()},after:function(e){jq("#templatePanel div.ajax_info_block").hide();jq("#templatePanel div.action_block").show();jq.unblockUI()}})},editTemplate:function(c,e){var d=ASC.CRM.TaskTemplateView.getCurrentTemplateData();d.containerid=c,d.id=e;if(d.title==""){ShowRequiredError(jq("#tbxTemplateTitle"),true);return false}else{RemoveRequiredErrorClass(jq("#tbxTemplateTitle"))}if(d.responsibleid==null){ShowRequiredError(jq("#templatePanel #inputUserName"),true);return false}else{RemoveRequiredErrorClass(jq("#templatePanel #inputUserName"))}Teamlab.updateCrmEntityTaskTemplate({},d,{success:function(g,h){var f=jq("#templateRow").tmpl(h);jq("#templateRow_"+e).replaceWith(f);var i=jq("#tooltip"+h.id).length>0;ASC.CRM.Common.tooltip("#templateTitle_"+h.id,"tooltip",!i)},before:function(f){jq("#templatePanel div.action_block").hide();jq("#templatePanel div.ajax_info_block").show()},after:function(f){jq("#templatePanel div.ajax_info_block").hide();jq("#templatePanel div.action_block").show();jq.unblockUI()}})},deleteTemplate:function(c){Teamlab.removeCrmEntityTaskTemplate({},c,{success:function(d,e){jq("#templateRow_"+c).remove();if(jq("#templateContainerBody_"+e.containerID+" table").length==0){jq("#templateContainerBody_"+e.containerID).hide()}},before:function(d){jq("#templateRow_"+c+" img.addImg").hide();jq("#templateRow_"+c+" img.editImg").hide();jq("#templateRow_"+c+" img.deleteImg").hide();jq("#templateRow_"+c+" img.loaderImg").show()}})},initTemplatePanel:function(c,e){if(!e){jq("#templatePanel div.containerHeaderBlock td:first").text(ASC.CRM.TaskTemplateView.TemplatePanel_AddHeaderText);jq("#templatePanel div.action_block a.baseLinkButton").text(ASC.CRM.TaskTemplateView.TemplatePanel_AddButtonText).unbind("click").click(function(){ASC.CRM.TaskTemplateView.createTemplate(c)});jq("#tbxTemplateTitle").val("");jq("#tbxTemplateDescribe").val("");ASC.CRM.TaskTemplateView.setTemplateDeadlineFromTicks();jq("#notifyResponsible").removeAttr("checked");taskTemplateResponsibleSelector.ClearFilter();taskTemplateResponsibleSelector.ChangeDepartment(taskTemplateResponsibleSelector.Groups[0].ID);var d=taskTemplateCategorySelector.getRowByContactID(0);taskTemplateCategorySelector.changeContact(d)}else{jq("#templatePanel div.containerHeaderBlock td:first").text(jq.format(ASC.CRM.TaskTemplateView.TemplatePanel_EditHeaderText,e.title));jq("#templatePanel div.action_block a.baseLinkButton").text(CRMJSResources.SaveChanges).unbind("click").click(function(){ASC.CRM.TaskTemplateView.editTemplate(c,e.id)});jq("#tbxTemplateTitle").val(e.title);jq("#tbxTemplateDescribe").val(e.description);ASC.CRM.TaskTemplateView.setTemplateDeadlineFromTicks(e.offsetTicks,e.deadLineIsFixed);jq("#notifyResponsible").attr("checked",e.isNotify);taskTemplateResponsibleSelector.ClearFilter();taskTemplateResponsibleSelector.ChangeDepartment(taskTemplateResponsibleSelector.Groups[0].ID);var d;if(!jq.browser.mobile){d=document.getElementById("User_"+e.responsible.id);if(d!=null){taskTemplateResponsibleSelector.SelectUser(d)}}else{d=jq("#taskResponsibleSelector select option[value="+e.responsible.id+"]");if(d.length>0){taskTemplateResponsibleSelector.SelectUser(d);jq(d).attr("selected",true)}}d=taskTemplateCategorySelector.getRowByContactID(e.category.id);taskTemplateCategorySelector.changeContact(d)}},getTemplateDeadlineTicks:function(){var c=jq("#tbxTemplateDisplacement").val().trim()!=""?parseInt(jq("#tbxTemplateDisplacement").val()):0;var d=c*24+parseInt(jq("#templateDeadlineHours option:selected").val());var e=parseInt(jq("#templateDeadlineMinutes option:selected").val());return((d*3600)+e*60)*10000000},setTemplateDeadlineFromTicks:function(g,e){if(!g&&!e){jq("#deadLine_fixed").attr("checked",true);jq("#tbxTemplateDisplacement").val("0");jq("#templateDeadlineHours option:first").attr("selected",true);jq("#templateDeadlineMinutes option:first").attr("selected",true)}else{if(e){jq("#deadLine_fixed").attr("checked",true)}else{jq("#deadLine_not_fixed").attr("checked",true)}var f=((g/10000000)%3600)/60;var d=(parseInt((g/10000000)/3600))%24;var c=parseInt((parseInt((g/10000000)/3600))/24);jq("#tbxTemplateDisplacement").val(c);jq("#optDeadlineHours_"+d).attr("selected",true);jq("#optDeadlineMinutes_"+f).attr("selected",true)}},getCurrentTemplateData:function(){var c={title:jq("#tbxTemplateTitle").val().trim(),description:jq("#tbxTemplateDescribe").val().trim(),responsibleid:taskTemplateResponsibleSelector.SelectedUserId,categoryid:taskTemplateCategorySelector.CategoryID,isNotify:jq("#notifyResponsible").is(":checked"),offsetTicks:ASC.CRM.TaskTemplateView.getTemplateDeadlineTicks(),deadLineIsFixed:jq("#templatePanel #deadLine_fixed").is(":checked")};return c},getDeadlineDisplacement:function(g,e){var f=((g/10000000)%3600)/60;var d=(parseInt((g/10000000)/3600))%24;var c=parseInt((parseInt((g/10000000)/3600))/24);if(e){return jq.format(CRMJSResources.TemplateFixedDeadline,c,d,f)}else{return jq.format(CRMJSResources.TemplateNotFixedDeadline,c,d,f)}}}})(jQuery);if(typeof ASC==="undefined"){ASC={}}if(typeof ASC.CRM==="undefined"){ASC.CRM=function(){return{}}}function ddlMessageNumberClicked(a){var b=jq("select[id$='_ctrlMessageCount']").val();jq.cookies.set("sm_msg_count",b);ASC.CRM.SocialMedia.LoadContactActivity()}function ShowErrorMessage(a){jq("[id$='_ctrlErrorDescriptionContainer']").css("display","block");jq("[id$='_ctrlErrorDescription']").text(a)}ASC.CRM.SocialMedia=(function(a){var b={addAndSaveTwitter:function(d,e){ASC.CRM.SocialMedia.LoadContactActivity()}};Teamlab.bind(Teamlab.events.getException,c);function c(e,d){console.log("socialmedia.js ",d);LoadingBanner.hideLoading()}_AjaxProTimeout=function(){LoadingBanner.hideLoading();ShowErrorMessage("Timeout expired")};_FindUsersResponse=function(d){_HideAjaxLoader();if(d.error!=null){_ShowErrorAccountRelation(d.error.Message)}else{jq("[id$='divSearchResults']").html(d.value)}};_ShowUserRelationWindowResponse=function(d){_HideAjaxLoader();if(d.error!=null){_ShowErrorAccountRelation(d.error.Message)}else{jq("[id$='divSearchContent']").css("display","none");jq("[id$='divUserContent']").html(d.value).css("display","block")}};_SaveContactSocialMediaRelationResponse=function(d){_HideAjaxLoader();if(d.error!=null){_ShowErrorAccountRelation(d.error.Message)}else{PopupKeyUpActionProvider.CloseDialog();location.reload(true)}};_ShowErrorAccountRelation=function(d){jq("[id$='_ctrlUserSearchViewErrorContainer']").css("display","block");jq("[id$='_ctrlUserSearchViewErrorDescription']").text(d)};_HideErrorAccountRelation=function(){jq("[id$='_ctrlUserSearchViewErrorContainer']").css("display","none");jq("[id$='_ctrlUserSearchViewErrorDescription']").text("")};_ShowAjaxLoader=function(){var d=jq("#divModalContent").height()+20;var f=jq("#divModalContent").width()+20;var e=jq("#divModalContent").offset();jq("#divAjaxCloserBox").height(d).width(f).css("top",e.top-10).css("left",e.left-10).fadeTo("fast",0.1)};_HideAjaxLoader=function(){jq("#divAjaxCloserBox").fadeOut("fast")};_GetContactActivityResponse=function(d){LoadingBanner.hideLoading();if(d.error!=null){ShowErrorMessage(d.error.Message)}else{jq("#divSocialMediaContent").html(d.value)}};_GetContactSMImagesResponse=function(f){if(f.error==null){var g=jq.parseJSON(f.value);var e=g.length;if(e>0){for(var d=0;d<e;d++){jq("#SocialMediaAvatarTmpl").tmpl(g[d]).appendTo("#divImagesHolder");jq("#linkSaveAvatar").css("display","inline")}}}_FinishGettingContactImages()};_FinishGettingContactImages=function(){ASC.CRM.SocialMedia.ContactImageListLoaded=true;jq("#divAjaxImageContainerPhotoLoad [id$='_ctrlImgAjaxLoader']").remove();jq("#divLoadPhotoFromSocialMedia").css("height","100px");jq("#divImagesHolder").css("display","block")};_SaveUserAvatarFromSocialNetworkResponse=function(e){jq(".under_logo .ajax_info_block").hide();jq(".under_logo #linkChangePhoto").show();if(e.error!=null||e.value==null){alert(CRMJSResources.ErrorMessage_SaveImageError)}else{var d=new Date();jq("#contactProfile .additionInfo .contact_photo").attr("src",e.value+"?"+d.getTime())}};_SavingAvatarTimeout=function(){jq(".under_logo .ajax_info_block").hide();jq(".under_logo #linkChangePhoto").show();alert(CRMJSResources.ErrorMessage_SaveImageError)};_DeleteContactAvatarResponse=function(e){jq(".under_logo .ajax_info_block").hide();jq(".under_logo #linkChangePhoto").show();if(e.error!=null){alert(CRMJSResources.ErrorMessage_SaveImageError)}else{var d=new Date();jq("#contactProfile .additionInfo .contact_photo").attr("src",e.value+"?"+d.getTime())}};_FindTwitterProfilesResponse=function(g,e,d,f){if(f.error!=null){alert(f.error.Message);return}_RenderSMProfiles(jq.parseJSON(f.value),"TwitterProfileTmpl");jq("#divSMProfilesWindow .divWait").hide();_CalculateProfilesWindowHeight();ASC.CRM.SocialMedia.TwitterTargetTextbox=jq(g).parent().parent().children("table").find("input");_ShowProfilesWindow()};_FindFacebookProfilesResponse=function(g,e,d,f){if(f.error!=null){alert(f.error.Message);return}_RenderSMProfiles(jq.parseJSON(f.value),"FacebookProfileTmpl");jq("#divSMProfilesWindow .divWait").hide();_CalculateProfilesWindowHeight();ASC.CRM.SocialMedia.FacebookTargetTextbox=jq(g).parent().parent().children("table").find("input");_ShowProfilesWindow()};_FindLinkedInProfilesResponse=function(g,e,d,f){if(f.error!=null){alert(f.error.Message);return}_RenderSMProfiles(jq.parseJSON(f.value),"LinkedInProfileTmpl");jq("#divSMProfilesWindow .divWait").hide();_CalculateProfilesWindowHeight();ASC.CRM.SocialMedia.LinkedInTargetTextbox=jq(g).parent().parent().children("table").find("input");_ShowProfilesWindow()};_CalculateProfilesWindowHeight=function(){var d=jq("#sm_tbl_UserList").outerHeight();if(d>200){return 270}if(d==0){return 100}return d+65};_CalculateProfilesWindowPosition=function(j,e,d){var l=e==null?0:e;var i=d==null?0:d;var f=jq("#divSMProfilesWindow");var k=j.offset();var h=k.top-23+l;var g=k.left+j.outerWidth()+3+i;f.css({position:"absolute",top:h,left:g})};_RenderSMProfiles=function(f,g){var e=f.length;if(e>0){for(var d=0;d<e;d++){jq("#"+g+"").tmpl(f[d]).appendTo("#sm_tbl_UserList")}}else{jq("#divSMProfilesWindow .divNoProfiles").css("display","block")}};_AddTwitterProfileToContactResponse=function(d){if(d.error!=null){alert("Error")}_HideProfilesWindow()};_ShowProfilesWindow=function(){jq("#divSMProfilesWindow").show();var d=_CalculateProfilesWindowHeight();jq("#divSMProfilesWindow").css("height",d);jq("#divSMProfilesWindow").unbind("mouseenter").mouseenter(function(){ASC.CRM.SocialMedia.MouseInProfilesWindow=true});jq("#divSMProfilesWindow").unbind("mouseleave").mouseleave(function(){ASC.CRM.SocialMedia.MouseInProfilesWindow=false});jq(document).bind("click",_CheckProfilesWindow)};_ShowWaitProfilesWindow=function(d){jq("#divSMProfilesWindow .divWait").show();jq("#divSMProfilesWindow .divHeader span").text(jq.format(CRMJSResources.PossibleSocialMediaAccounts,d));var e=_CalculateProfilesWindowHeight();jq("#divSMProfilesWindow").css("height",e);jq("#divSMProfilesWindow").show()};_CheckProfilesWindow=function(){if(ASC.CRM.SocialMedia.MouseInProfilesWindow==false){_HideProfilesWindow()}};_HideProfilesWindow=function(){jq("#divSMProfilesWindow").hide();jq(document).unbind("click",_CheckProfilesWindow)};_ShowCrunchbaseContact=function(d,f){var e=jq.parseJSON(f);e.namespace=d;jq("#divSMContactsSearchContainer .divWaitForSearching").hide();jq("#divSMContactsSearchContainer .divNoProfiles").css("display","none");jq("#divContactDescription").css("display","block");jq("#divCrbsContactConfirm").css("display","block");jq("#divContactDescription").html("");jq("#CrunchbaseContactFullTmpl").tmpl(e).appendTo("#divContactDescription");if(jq("#tblCompanyFields > tbody > tr").length==0){jq("#divContactDescription").html("");jq("#divCrbsContactConfirm").css("display","none");jq("#divSMContactsSearchContainer .divNoProfiles").css("display","block")}};return{init:function(){ASC.CRM.SocialMedia.SocialMediaLoaded=false;ASC.CRM.SocialMedia.ContactImageListLoaded=false;ASC.CRM.SocialMedia.MouseInProfilesWindow=false;ASC.CRM.SocialMedia.selectedPersons=new Array()},activate:function(){if(ASC.CRM.SocialMedia.SocialMediaLoaded==false){ASC.CRM.SocialMedia.SocialMediaLoaded=true;ASC.CRM.SocialMedia.LoadContactActivity()}},switchCheckedPersonsInCompany:function(d){jq("#chbPersonsRelationship input[type='checkbox']").attr("checked",d)},LoadContactActivity:function(){AjaxPro.onTimeout=_AjaxProTimeout;jq("[id$='_ctrlErrorDescriptionContainer']").css("display","none");jq("[id$='_ctrlErrorDescription']").text("");LoadingBanner.displayLoading();var d=jq("[id$='_ctrlContactID']").val();var e=jq.cookies.get("sm_msg_count");if(e==null||e===undefined||isNaN(e)){e=10}AjaxPro.SocialMediaUI.GetContactActivity(d,e,_GetContactActivityResponse)},ShowContactSearchPanel:function(d){_HideErrorAccountRelation();ASC.CRM.Common.blockUI("#divSMUserSearchContainer",500,550,0);jq("[id$='divUserContent']").css("display","none");jq("[id$='divSearchContent']").css("display","block");if(jq("#_ctrlSocialMediaSearch").val().length==0){jq("#_ctrlSocialMediaSearch").val(d)}},FindUsers:function(){AjaxPro.onTimeout=function(){_ShowErrorAccountRelation("Operation timeout");_HideAjaxLoader()};_HideErrorAccountRelation();var d=jq("[id$='_ctrlSocialMediaSearch']").val();var e=jq("input[name='SelectedSocialMedia']:checked").attr("value");if(d.length==0){return}_ShowAjaxLoader();AjaxPro.SocialMediaUI.FindUsers(d,e,_FindUsersResponse)},ShowAccountRelationPanel:function(d,e){AjaxPro.onTimeout=function(){_ShowErrorAccountRelation("Operation timeout");_HideAjaxLoader()};_HideErrorAccountRelation();_ShowAjaxLoader();if(e=="twitter"){AjaxPro.SocialMediaUI.ShowTwitterUserRelationWindow(d,_ShowUserRelationWindowResponse)}if(e=="facebook"){AjaxPro.SocialMediaUI.ShowFacebookUserRelationWindow(d,_ShowUserRelationWindowResponse)}},RelateTwitterContactToSocialMedia:function(){AjaxPro.onTimeout=function(){_ShowErrorAccountRelation("Operation timeout");_HideAjaxLoader()};_HideErrorAccountRelation();var d={};d.ContactID=jq("[id$='_ctrlContactID']").val();d.TwitterUserID=jq("[id$='_ctrlHiddenTwitterUserID']").val();d.TwitterScreenName=jq("[id$='_ctrlHiddenTwitterUserScreenName']").val();d.UserAvatarUrl=jq("[id$='_ctrlHiddenUserAvatarUrl']").val();d.RelateAccount=jq("[id$='_ctrlChbRelateToAccount']").is(":checked");d.RelateAvatar=jq("[id$='_ctrlChbAddImage']").is(":checked");_ShowAjaxLoader();AjaxPro.SocialMediaUI.SaveContactTwitterRelation(d,_SaveContactSocialMediaRelationResponse)},RelateFacebookContactToSocialMedia:function(){AjaxPro.onTimeout=function(){_ShowErrorAccountRelation("Operation timeout");_HideAjaxLoader()};_HideErrorAccountRelation();var d={};d.ContactID=jq("[id$='_ctrlContactID']").val();d.FacebookUserID=jq("[id$='_ctrlHiddenTwitterUserID']").val();d.UserAvatarUrl=jq("[id$='_ctrlHiddenUserAvatarUrl']").val();d.RelateAvatar=jq("[id$='_ctrlChbAddImage']").is(":checked");_ShowAjaxLoader();AjaxPro.SocialMediaUI.SaveContactFacebookRelation(d,_SaveContactSocialMediaRelationResponse)},GetContactImageList:function(){var d=jq("input[id$='_ctrlContactID']").val();jq("#divAjaxImageContainerPhotoLoad").append(jq("[id$='_ctrlImgAjaxLoader']").clone().css("display","block"));jq("#divAjaxImageContainerPhotoLoad").css("display","block");AjaxPro.onTimeout=function(){_FinishGettingContactImages()};AjaxPro.SocialMediaUI.GetContactSMImages(d,_GetContactSMImagesResponse)},OpenLoadPhotoWindow:function(){ASC.CRM.Common.blockUI("#divLoadPhotoWindow",520,550,0);jq("[name='chbSocialNetwork']").removeAttr("checked");if(ASC.CRM.SocialMedia.ContactImageListLoaded==false){ASC.CRM.SocialMedia.GetContactImageList()}},SelectUserAvatar:function(d,g,e){if(!d.target){d.target=d.srcElement}var f=jq(d.target).is(":checked");if(f==false){return}jq("[name='chbSocialNetwork']").not(jq(d.target)).removeAttr("checked")},SaveUserAvatar:function(e,g,f){AjaxPro.onTimeout=function(){_SavingAvatarTimeout()};var d=jq("[id$='_ctrlContactID']").val();AjaxPro.SocialMediaUI.SaveUserAvatarFromSocialNetwork(d,g,f,_SaveUserAvatarFromSocialNetworkResponse);PopupKeyUpActionProvider.CloseDialog();jq(".under_logo #linkChangePhoto").hide();jq(".under_logo .ajax_info_block").show()},DeleteContactAvatar:function(){AjaxPro.onTimeout=function(){_SavingAvatarTimeout()};var d=jq("[id$='_ctrlContactID']").val();AjaxPro.SocialMediaUI.DeleteContactAvatar(d,_DeleteContactAvatarResponse);PopupKeyUpActionProvider.CloseDialog();jq(".under_logo .ajax_info_block").hide();jq(".under_logo #linkChangePhoto").show()},FindTwitterProfiles:function(h,f,e,d){_HideProfilesWindow();jq("#divSMProfilesWindow .divNoProfiles").css("display","none");jq("#sm_tbl_UserList").html("");var g;if(f=="company"){g=jq("[name='baseInfo_companyName']").val()}if(f=="people"){g=jq("[name='baseInfo_firstName']").val()+" "+jq("[name='baseInfo_lastName']").val()}if(g===undefined||jq.trim(g).length==0){return}_CalculateProfilesWindowPosition(jq(h),e,d);_ShowWaitProfilesWindow(g);AjaxPro.SocialMediaUI.FindTwitterProfiles(g,function(i){_FindTwitterProfilesResponse(h,e,d,i)})},FindFacebookProfiles:function(h,f,e,d){_HideProfilesWindow();jq("#divSMProfilesWindow .divNoProfiles").css("display","none");jq("#sm_tbl_UserList").html("");var g;if(f=="company"){g=jq("[name='baseInfo_companyName']").val()}if(f=="people"){g=jq("[name='baseInfo_firstName']").val()+" "+jq("[name='baseInfo_lastName']").val()}if(g===undefined||jq.trim(g).length==0){return}_CalculateProfilesWindowPosition(jq(h),e,d);_ShowWaitProfilesWindow(g);AjaxPro.SocialMediaUI.FindFacebookProfiles(g,function(i){_FindFacebookProfilesResponse(h,e,d,i)})},FindLinkedInProfiles:function(j,f,e,d){_HideProfilesWindow();jq("#divSMProfilesWindow .divNoProfiles").css("display","none");jq("#sm_tbl_UserList").html("");var i;if(f=="company"){return}if(f=="people"){var g=jq("[name='baseInfo_firstName']").val();var h=jq("[name='baseInfo_lastName']").val();var i=g+" "+h;if(i===undefined||jq.trim(i).length==0){return}_CalculateProfilesWindowPosition(jq(j),e,d);_ShowWaitProfilesWindow(i);AjaxPro.SocialMediaUI.FindLinkedInProfiles(g,h,function(k){_FindLinkedInProfilesResponse(j,e,d,k)})}},AddAndSaveTwitterProfileToContact:function(g,d){var f={};var e={data:g,isPrimary:true,infoType:"Twitter",category:"Work"};Teamlab.addCrmContactTwitter(f,d,e,{success:b.addAndSaveTwitter,before:function(h){},after:function(h){_HideProfilesWindow()}})},AddTwitterProfileToContact:function(d){jq(ASC.CRM.SocialMedia.TwitterTargetTextbox).val(d);_HideProfilesWindow()},AddFacebookProfileToContact:function(d){jq(ASC.CRM.SocialMedia.FacebookTargetTextbox).val(d);_HideProfilesWindow()},AddLinkedInProfileToContact:function(h,d,g,i,j){var e=jq.parseJSON(jq("[id$='_ctrlLinkedInAccountsInfo']").val());var f=0;if(e!=null){f=e.length}else{e=new Array()}e[f]={UserID:h,PublicProfileUrl:i,UserName:j};jq("[id$='_ctrlLinkedInAccountsInfo']").val(jq.toJSON(e));if(jq.trim(jq("[name='baseInfo_companyName']").val()).length==0){jq("[name='baseInfo_companyName']").val(d)}if(jq.trim(jq("[name='baseInfo_personPosition']").val()).length==0){jq("[name='baseInfo_personPosition']").val(g)}jq(ASC.CRM.SocialMedia.LinkedInTargetTextbox).val(i);_HideProfilesWindow();ASC.CRM.SocialMedia.EnsureLinkedInAccounts()},EnsureLinkedInAccounts:function(){var d=jq.parseJSON(jq("[id$='_ctrlLinkedInAccountsInfo']").val());if(d==null){jq("[id$='_ctrlLinkedInAccountsInfo']").val("");return}var g=new Array();jq("[name='contactLinkedIn']").each(function(h){g[h]=jq(this).val()});var f=new Array();for(var e=0;e<d.length;e++){if(g.join().search(d[e].PublicProfileUrl)!=-1&&jq.toJSON(f).search(d[e].PublicProfileUrl)==-1){f.push(d[e])}}jq("[id$='_ctrlLinkedInAccountsInfo']").val(jq.toJSON(f))},FindContacts:function(f){jq("#divSMContactsSearchContainer .divNoProfiles").hide();jq("#divSMContactsSearchContainer .divWaitForAdding").hide();var i="";if(f){var h=jq("[name='baseInfo_companyName']").val().trim();if(h==""){return}i="http://api.crunchbase.com/v/1/companies/permalink?name="+h}else{var e=jq("[name='baseInfo_firstName']").val().trim();var g=jq("[name='baseInfo_lastName']").val().trim();if(e==""||g==""){return}i="http://api.crunchbase.com/v/1/people/permalink?first_name="+e+"&last_name="+g}var d=f?"company":"person";ASC.CRM.Common.blockUI("#divSMContactsSearchContainer",550,550,0);jq("#divContactDescription").css("display","none");jq("#divCrbsContactConfirm").css("display","none");jq("#divSMContactsSearchContainer .divWaitForSearching").show();AjaxPro.ContactsSearchView.FindContactByName(i,d,function(j){if(j.error!=null||j.value==""){jq("#divSMContactsSearchContainer .divWaitForSearching").hide();jq("#divSMContactsSearchContainer .divNoProfiles").css("display","block")}else{_ShowCrunchbaseContact(d,j.value)}})},ConfirmCrunchbaseContact:function(){jq("#divCrbsContactConfirm").hide();jq("#divSMContactsSearchContainer .divWaitForAdding").show();if(jq("#chbWebsite").is(":checked")){var l=jq("#crbsWebSite").val();var d=ASC.CRM.ContactActionView.createNewCommunication("websiteAndSocialProfilesContainer",l);ASC.CRM.ContactActionView.changeSocialProfileCategory(d.find("a.social_profile_type"),2,jq("#socialProfileCategoriesPanel div.dropDownContent").children('a[category="2"]').text(),jq("#socialProfileCategoriesPanel div.dropDownContent").children('a[category="2"]').attr("categoryName"));d.insertAfter(jq("#websiteAndSocialProfilesContainer").children("div:last")).show()}if(jq("#chbEmail").is(":checked")){var l=jq("#crbsEmail").val();var d=ASC.CRM.ContactActionView.createNewCommunication("emailContainer",l,jq("#emailContainer").find(".primary_field").length==0);d.insertAfter(jq("#emailContainer").children("div:last")).show();jq("#emailContainer").prev("dt").removeClass("crm-withGrayPlus")}if(jq("#chbPhoneNumber").is(":checked")){var l=jq("#crbsPhoneNumber").val();var d=ASC.CRM.ContactActionView.createNewCommunication("phoneContainer",l,jq("#phoneContainer").find(".primary_field").length==0);d.insertAfter(jq("#phoneContainer").children("div:last")).show();jq("#phoneContainer").prev("dt").removeClass("crm-withGrayPlus")}if(jq("#chbTwitter").is(":checked")){var l=jq("#crbsTwitterUserName").val();var d=ASC.CRM.ContactActionView.createNewCommunication("websiteAndSocialProfilesContainer",l);d.insertAfter(jq("#websiteAndSocialProfilesContainer").children("div:last")).show();ASC.CRM.ContactActionView.changeSocialProfileCategory(d.find("a.social_profile_type"),4,jq("#socialProfileCategoriesPanel div.dropDownContent").children('a[category="4"]').text(),jq("#socialProfileCategoriesPanel div.dropDownContent").children('a[category="4"]').attr("categoryName"))}if(jq("#chbBlog").is(":checked")){var l=jq("#crbsBlogUrl").val();var d=ASC.CRM.ContactActionView.createNewCommunication("websiteAndSocialProfilesContainer",l);ASC.CRM.ContactActionView.changeSocialProfileCategory(d.find("a.social_profile_type"),11,jq("#socialProfileCategoriesPanel div.dropDownContent").children('a[category="11"]').text(),jq("#socialProfileCategoriesPanel div.dropDownContent").children('a[category="11"]').attr("categoryName"));d.insertAfter(jq("#websiteAndSocialProfilesContainer").children("div:last")).show()}if(jq("#chbBlogFeed").is(":checked")){var l=jq("#crbsBlogFeedUrl").val();var d=ASC.CRM.ContactActionView.createNewCommunication("websiteAndSocialProfilesContainer",l);ASC.CRM.ContactActionView.changeSocialProfileCategory(d.find("a.social_profile_type"),11,jq("#socialProfileCategoriesPanel div.dropDownContent").children('a[category="11"]').text(),jq("#socialProfileCategoriesPanel div.dropDownContent").children('a[category="11"]').attr("categoryName"));d.insertAfter(jq("#websiteAndSocialProfilesContainer").children("div:last")).show()}if(jq("#chbDescription").is(":checked")){var l=jq("#crbsOverview").val();if(jq("#overviewContainer").children("div").length==1){var d=ASC.CRM.ContactActionView.createNewCommunication("overviewContainer",l);d.insertAfter(jq("#overviewContainer").children("div:last")).show()}else{jq("#overviewContainer").children("div:last").find("[name='baseInfo_contactOverview']").val(l)}jq("#overviewContainer").prev("dt").removeClass("crm-withGrayPlus")}var e="crm-addNewLink";var g="crm-deleteLink";jq("#emailContainer").children("div:not(:first)").find("."+e).hide();jq("#emailContainer").children("div:last").find("."+e).show();jq("#phoneContainer").children("div:not(:first)").find("."+e).hide();jq("#phoneContainer").children("div:last").find("."+e).show();if(jq("#websiteAndSocialProfilesContainer").children("div").length>1){jq("#websiteAndSocialProfilesContainer").prev("dt").removeClass("crm-withGrayPlus")}jq("#websiteAndSocialProfilesContainer").children("div:not(:first)").find("."+e).hide();jq("#websiteAndSocialProfilesContainer").children("div:last").find("."+e).show();if(jq("#chbImage").is(":checked")){var j=jq.parseJSON(jq("#crbsImageJSON").val()).available_sizes;var k="http://www.crunchbase.com/"+j[j.length-1][1];jq("#uploadPhotoPath").val(k);jq("#contactPhoto img").attr("src",k)}var n=jq.parseJSON(jq("#crbsPeopleJSON").val());var f=new Array();for(var h=0;h<n.length;h++){if(n[h].person){if(jq("#chbPersonsRelationship input[id="+n[h].person.permalink+"]").is(":checked")){var m={Key:n[h].person.first_name,Value:n[h].person.last_name,canEdit:true,displayName:n[h].person.first_name+" "+n[h].person.last_name,id:n[h].person.permalink,isCompany:false,isPrivate:false,smallFotoUrl:ASC.CRM.SocialMedia.emptyPeopleLogo};ASC.CRM.SocialMedia.selectedPersons.push(m);f.push(m)}}}if(f.length>0){jq("#simpleContactTmpl").tmpl(f).prependTo("#contactTable tbody");if(jq("#contactTable tr").length>0){jq("#contactListBox").parent().removeClass("hiddenFields")}}PopupKeyUpActionProvider.CloseDialog()}}})(jQuery);if(typeof ASC==="undefined"){ASC={}}if(typeof ASC.CRM==="undefined"){ASC.CRM=function(){return{}}}ASC.CRM.ListTaskView=new function(){Teamlab.bind(Teamlab.events.getException,d);function d(i,h){console.log("tasks.js ",h);LoadingBanner.hideLoading()}var f=function(){jq("#taskTable tbody tr").remove();if(ASC.CRM.ListTaskView.TaskList.length==0&&(ASC.CRM.ListTaskView.ContactID!=0||ASC.CRM.ListTaskView.EntityID!=0)){ASC.CRM.ListTaskView.NoTasks=true;jq("#taskList").hide();jq("#taskButtonsPanel").hide();jq("#taskFilterContainer").hide();jq("#emptyContentForTasksFilter").hide();jq("#tasksEmptyScreen").show();LoadingBanner.hideLoading();return false}if(ASC.CRM.ListTaskView.TaskList.length==0){jq("#taskList").hide();jq("#taskButtonsPanel").show();jq("#mainExportCsv").next("img").hide();jq("#mainExportCsv").hide();jq("#taskFilterContainer").show();ASC.CRM.ListTaskView.resizeFilter();jq("#emptyContentForTasksFilter").show();LoadingBanner.hideLoading();return false}jq("#emptyContentForTasksFilter").hide();jq("#taskButtonsPanel").show();jq("#mainExportCsv").next("img").show();jq("#mainExportCsv").show();jq("#taskFilterContainer").show();ASC.CRM.ListTaskView.resizeFilter();jq("#taskList").show();jq("#taskTmpl").tmpl(ASC.CRM.ListTaskView.TaskList).appendTo("#taskTable tbody");ASC.CRM.Common.RegisterContactInfoCard();for(var h=0;h<ASC.CRM.ListTaskView.TaskList.length;h++){ASC.CRM.Common.tooltip("#taskTitle_"+ASC.CRM.ListTaskView.TaskList[h].id,"tooltip",true)}LoadingBanner.hideLoading()};var e=function(){if(ASC.CRM.ListTaskView.TaskList.length==0){return false}jq("#taskTmpl").tmpl(ASC.CRM.ListTaskView.TaskList).appendTo("#taskTable tbody");ASC.CRM.Common.RegisterContactInfoCard();for(var h=0;h<ASC.CRM.ListTaskView.TaskList.length;h++){ASC.CRM.Common.tooltip("#taskTitle_"+ASC.CRM.ListTaskView.TaskList[h].id,"tooltip",true)}};var g=function(){if(ASC.CRM.ListTaskView.NoTasks){jq("#taskList").hide();jq("#taskButtonsPanel").hide();jq("#taskFilterContainer").hide();jq("#emptyContentForTasksFilter").hide();jq("#tasksEmptyScreen").show();return}if(ASC.CRM.ListTaskView.ContactID==0&&ASC.CRM.ListTaskView.EntityID==0&&ASC.CRM.ListTaskView.isFirstTime==true){ASC.CRM.ListTaskView.isFirstTime=false;if(typeof(tasksForFirstRequest)!="undefined"){tasksForFirstRequest=jq.parseJSON(jQuery.base64.decode(tasksForFirstRequest))}else{tasksForFirstRequest=[]}ASC.CRM.ListTaskView.CallbackMethods.get_tasks_by_filter({startIndex:0,__nextIndex:tasksForFirstRequest.nextIndex},Teamlab.create("crm-tasks",null,tasksForFirstRequest.response));return}LoadingBanner.displayLoading();ASC.CRM.ListTaskView.ShowMore=true;c(0)};var a=function(){if(!ASC.CRM.ListTaskView.ShowMore){return false}ASC.CRM.ListTaskView.TaskList={};jq("#showMoreTasksButtons .crm-showMoreLink").hide();jq("#showMoreTasksButtons .crm-loadingLink").show();var h=jq("#taskTable tbody tr").length;c(h)};var c=function(i){var h={};if(ASC.CRM.ListTaskView.ContactID!=0||ASC.CRM.ListTaskView.EntityID!=0){h.entityid=ASC.CRM.ListTaskView.ContactID!=0?ASC.CRM.ListTaskView.ContactID:ASC.CRM.ListTaskView.EntityID;h.entitytype=ASC.CRM.ListTaskView.EntityType;h.sortBy="deadLine";h.sortOrder="descending"}else{h=ASC.CRM.ListTaskView.getFilterSettings()}h.Count=ASC.CRM.ListTaskView.CountOfRows;h.startIndex=i;Teamlab.getCrmTasks({startIndex:i||0},{filter:h,success:ASC.CRM.ListTaskView.CallbackMethods.get_tasks_by_filter})};var b=function(l,j){Teamlab.updateCrmTask({},l,{id:l,isClosed:j},{success:ASC.CRM.TaskActionView.CallbackMethods.edit_task,before:function(m){jq("#taskStatusListContainer").hide();jq("#task_"+l+" .check").hide();jq("#task_"+l+" .ajax_edit_task").show();jq("#taskMenu_"+l).hide()},after:function(m){jq("#task_"+l+" .ajax_edit_task").hide();jq("#task_"+l+" .check").show();jq("#taskMenu_"+l).show()}});if(j){var k=ASC.CRM.ListTaskView.AllTaskList[ASC.CRM.ListTaskView.findIndexOfTaskByID(l)];var i={content:jq.format(CRMJSResources.TaskIsOver,k.title),categoryId:ASC.CRM.ListTaskView.HistoryCategoryTaskClosed,created:Teamlab.serializeTimestamp(new Date())};if(k.contact!=null){i.contactId=k.contact.id}if(k.entity!=null){i.entityId=k.entity.entityId;i.entityType=k.entity.entityType}if(k.contact!=null||k.entity!=null){var h;if(ASC.CRM.ListTaskView.ContactID==0&&ASC.CRM.ListTaskView.EntityID==0){h=new function(m,n){}}else{h=ASC.CRM.HistoryView.CallbackMethods.add_event}Teamlab.addCrmHistoryEvent({},i,h)}}};return{CallbackMethods:{get_tasks_by_filter:function(k,l){if(typeof(k.__nextIndex)=="undefined"){ASC.CRM.ListTaskView.ShowMore=false}ASC.CRM.ListTaskView.TaskList=l;for(var h=0,j=l.length;h<j;h++){ASC.CRM.ListTaskView.taskItemFactory(l[h]);ASC.CRM.ListTaskView.AllTaskList.push(l[h])}if(!k.startIndex){f()}else{e()}jq("#showMoreTasksButtons .crm-loadingLink").hide();if(ASC.CRM.ListTaskView.ShowMore){jq("#showMoreTasksButtons .crm-showMoreLink").show()}else{jq("#showMoreTasksButtons .crm-showMoreLink").hide()}},delete_task:function(h,i){jq("#task_"+i.id).animate({opacity:"hide"},500);setTimeout(function(){jq("#task_"+i.id).remove();var j=ASC.CRM.ListTaskView.findIndexOfTaskByID(i.id);if(j!=-1){ASC.CRM.ListTaskView.AllTaskList.splice(j,1)}if(ASC.CRM.ListTaskView.AllTaskList.length==0&&ASC.CRM.ListTaskView.ShowMore==false){ASC.CRM.ListTaskView.NoTasks=true}if(jq("#taskTable tbody tr").length==0){jq("#taskList").hide();if(ASC.CRM.ListTaskView.NoTasks){jq("#emptyContentForTasksFilter").hide();jq("#taskFilterContainer").hide();jq("#taskButtonsPanel").hide();jq("#tasksEmptyScreen").show()}else{g()}}},500)}},init:function(j,n,m,k,o,p,i){ASC.CRM.ListTaskView.ContactID=j;ASC.CRM.ListTaskView.EntityType=n;ASC.CRM.ListTaskView.EntityID=m;ASC.CRM.ListTaskView.CountOfRows=k;ASC.CRM.ListTaskView.HistoryCategoryTaskClosed=o;ASC.CRM.ListTaskView.NoTasks=p;ASC.CRM.ListTaskView.ShowMore=!p;ASC.CRM.ListTaskView.AllTaskList=[];ASC.CRM.ListTaskView.TaskList={};ASC.CRM.ListTaskView.isFilterVisible=false;ASC.CRM.ListTaskView.isTabActive=false;var l=location.hash;l=l&&typeof l==="string"&&l.charAt(0)==="#"?l.substring(1):l;if(l==""||decodeURIComponent(i)==l){ASC.CRM.ListTaskView.isFirstTime=true}else{ASC.CRM.ListTaskView.isFirstTime=false}ASC.CRM.ListTaskView.actionMenuPositionCalculated=false;jq("#showMoreTasksButtons .crm-showMoreLink").bind("click",function(){a()});var h=jq("#taskStatusListContainer");if(h.length===1){jq.dropdownToggle({dropdownID:"taskStatusListContainer",switcherSelector:"#taskTable .changeStatusCombobox.canEdit",addTop:-12,addLeft:4,showFunction:function(r,q){jq("#taskTable .changeStatusCombobox.selected").removeClass("selected");if(q.is(":hidden")){r.addClass("selected");if(h.attr("taskid")!=r.attr("taskid")){h.attr("taskid",r.attr("taskid"))}}},hideFunction:function(){jq("#taskTable .changeStatusCombobox.selected").removeClass("selected")}});jq("#taskStatusListContainer li").bind({click:function(){if(jq(this).is(".selected")){h.hide();jq("#taskTable .changeStatusCombobox.selected").removeClass("selected");return}var r=h.attr("taskid");var q=jq(this).attr("class");if(q==jq("#task_"+r+" .changeStatusCombobox span").attr("class")){h.hide();jq("#taskTable .changeStatusCombobox.selected").removeClass("selected");return}b(r,q=="closed")}})}},setFilter:function(i,h,j,k,l){g()},resetFilter:function(i,h,j,k){g()},activate:function(){if(ASC.CRM.ListTaskView.isTabActive==false){ASC.CRM.ListTaskView.isTabActive=true;g()}},resizeFilter:function(){var h=jq("#taskFilterContainer").is(":hidden")==false;if(ASC.CRM.ListTaskView.isFilterVisible==false&&h){ASC.CRM.ListTaskView.isFilterVisible=true;if(ASC.CRM.ListTaskView.advansedFilter){jq("#tasksAdvansedFilter").advansedFilter("resize")}}},getFilterSettings:function(){var i={};if(ASC.CRM.ListTaskView.advansedFilter.advansedFilter==null){return i}var h=ASC.CRM.ListTaskView.advansedFilter.advansedFilter();jq(h).each(function(m,n){switch(n.id){case"sorter":i.sortBy=n.params.id;i.sortOrder=n.params.dsc==true?"descending":"ascending";break;case"text":i.filterValue=n.params.value;break;case"fromToDate":i.fromDate=new Date(n.params.from);i.toDate=new Date(n.params.to);break;default:if(n.hasOwnProperty("apiparamname")&&n.params.hasOwnProperty("value")&&n.params.value!=null){try{var j=jq.parseJSON(n.apiparamname);var k=jq.parseJSON(n.params.value);if(j.length!=k.length){i[n.apiparamname]=n.params.value}for(var m=0,o=j.length;m<o;m++){if(k[m].trim().length!=0){i[j[m]]=k[m]}}}catch(l){i[n.apiparamname]=n.params.value}}break}});return i},taskItemFactory:function(i){var h=new Date();var j=new Date(h.getFullYear(),h.getMonth(),h.getDate(),0,0,0,0);if(i.isClosed){i.classForTitle="headerBaseSmall grayText";i.classForTaskDeadline="grayText"}else{if(i.deadLine.getHours()!=0||i.deadLine.getMinutes()!=0){if(i.deadLine.getTime()<h.getTime()){i.classForTitle="headerBaseSmall redText";i.classForTaskDeadline="redText"}else{i.classForTitle="headerBaseSmall";i.classForTaskDeadline=""}}else{if(i.deadLine.getTime()<j.getTime()){i.classForTitle="headerBaseSmall redText";i.classForTaskDeadline="redText"}else{i.classForTitle="headerBaseSmall";i.classForTaskDeadline=""}}}if(i.entity!=null){switch(i.entity.entityType){case"opportunity":i.entityURL="deals.aspx?id="+i.entity.entityId;i.entityType=CRMJSResources.Deal;break;case"case":i.entityURL="cases.aspx?id="+i.entity.entityId;i.entityType=CRMJSResources.Case;break;default:i.entityURL="";i.entityType="";break}}},deleteTaskItem:function(h){if(confirm(CRMJSResources.ConfirmDeleteTask+"\n"+CRMJSResources.DeleteConfirmNote)){Teamlab.removeCrmTask({},h,{success:ASC.CRM.ListTaskView.CallbackMethods.delete_task,before:function(i){jq("#task_"+h+" .check").hide();jq("#task_"+h+" .ajax_edit_task").show();jq("#taskMenu_"+h).hide()}});return true}else{return false}},findIndexOfTaskByID:function(k){var j=ASC.CRM.ListTaskView.AllTaskList.length;for(var h=0;h<j;h++){if(ASC.CRM.ListTaskView.AllTaskList[h].id==k){return h}}return -1},showActionMenu:function(l,h,j,i){if(ASC.CRM.ListTaskView.actionMenuPositionCalculated===false){ASC.CRM.ListTaskView.actionMenuPositionCalculated=true;jq("#taskActionMenu").show();var k=jq("#taskActionMenu .dropDownCornerRight").position().left;jq("#taskActionMenu").hide();jq.dropdownToggle({dropdownID:"taskActionMenu",switcherSelector:"#taskTable .crm-menu",addTop:4,addLeft:-k+6,showFunction:function(n,m){jq("#taskTable .crm-menu.active").removeClass("active");if(m.is(":hidden")){n.addClass("active")}},hideFunction:function(){jq("#taskTable .crm-menu.active").removeClass("active")}})}jq("#editTaskLink").unbind("click").bind("click",function(){jq("#taskActionMenu").hide();jq("#taskTable .crm-menu.active").removeClass("active");ASC.CRM.TaskActionView.showTaskPanel(l,h,j,i)});jq("#deleteTaskLink").unbind("click").bind("click",function(){jq("#taskActionMenu").hide();jq("#taskTable .crm-menu.active").removeClass("active");ASC.CRM.ListTaskView.deleteTaskItem(l)})},exportToCsv:function(){var j=window.location.href.indexOf("#");var i=j>=0?window.location.href.substr(0,j):window.location.href;var h=j>=0?window.location.href.substr(j,window.location.href.length):"";jq("#exportDialog").hide();window.location.href=i+"?action=export"+h},openExportFile:function(){var i=window.location.href.indexOf("#");var h=i>=0?window.location.href.substr(0,i):window.location.href;jq("#exportDialog").hide();window.open(h+"?action=export&view=editor")},showExportDialog:function(){jq.dropdownToggle().toggle("#mainExportCsv","exportDialog",7,-20)}}};ASC.CRM.TaskActionView=new function(){var a=function(b){jq("#taskDeadlineContainer").find("a").each(function(){jq(this).css("border-bottom","");jq(this).css("font-weight","normal")});if(b==0||b==3||b==7){jq("#deadline_"+b).css("border-bottom","none");jq("#deadline_"+b).css("font-weight","bold")}};return{CallbackMethods:{add_task:function(c,d){var b=d;ASC.CRM.ListTaskView.taskItemFactory(b);ASC.CRM.ListTaskView.AllTaskList.push(b);if(jq("#taskTable tbody tr").length==0){jq("#emptyContentForTasksFilter").hide();jq("#tasksEmptyScreen").hide();jq("#taskButtonsPanel").show();jq("#taskFilterContainer").show();ASC.CRM.ListTaskView.resizeFilter();jq("#taskList").show()}jq("#taskTmpl").tmpl(b).prependTo("#taskTable tbody");ASC.CRM.ListTaskView.NoTasks=false;ASC.CRM.Common.tooltip("#taskTitle_"+b.id,"tooltip",true);PopupKeyUpActionProvider.EnableEsc=true;jq.unblockUI();ASC.CRM.Common.RegisterContactInfoCard()},edit_task:function(c,d){var b=d;ASC.CRM.ListTaskView.taskItemFactory(b);ASC.CRM.ListTaskView.AllTaskList.push(b);jq("#task_"+b.id).attr("id","old_task").hide();jq("#taskTmpl").tmpl(b).insertBefore(jq("#old_task"));jq("#old_task").remove();var e=jq("#tooltip"+b.id).length>0;ASC.CRM.Common.tooltip("#taskTitle_"+b.id,"tooltip",!e);PopupKeyUpActionProvider.EnableEsc=true;jq.unblockUI();ASC.CRM.Common.RegisterContactInfoCard()}},init:function(c,b){ASC.CRM.TaskActionView.CurrentAccountID=b;jq("#taskDeadline").mask(c);jq("#taskDeadline").datepicker({onSelect:function(d){var f=jq("#taskDeadline").datepicker("getDate");var g=new Date();var h=new Date(g.getFullYear(),g.getMonth(),g.getDate(),0,0,0,0);var e=Math.floor((f.getTime()-h.getTime())/(24*60*60*1000));a(e);setTimeout(function(){jq('<input type="text" />').insertAfter("#taskDeadline").focus().remove()},100)}})},showTaskPanel:function(f,b,d,c){var e=ASC.CRM.TaskActionView.initPanel(f,b);PopupKeyUpActionProvider.EnableEsc=false;HideRequiredError();ASC.CRM.Common.blockUI("#addTaskPanel",650,600,0);jq("#addTaskPanel input[id$=tbxTitle]").focus();jq("#addTaskPanel a.baseLinkButton:first").unbind("click").bind("click",function(){ASC.CRM.TaskActionView.saveTask(f,d,c,e)})},keyPress:function(d){var b;if(!c){var c=d}if(!c){var c=window.event}if(c.keyCode){b=c.keyCode}else{if(c.which){b=c.which}}if(b>=48&&b<=57){jq("#taskDeadlineContainer").find("a").each(function(){jq(this).css("border-bottom","")})}},changeDeadline:function(d){var b=parseInt(jq.trim(jq(d).attr("id").split("_")[1]));var e=new Date();var c=new Date(e.setDate(e.getDate()+b));jq("#taskDeadline").datepicker("setDate",c);a(b)},saveTask:function(i,e,d,f){var c=null;if(jq.trim(jq("#addTaskPanel input[id$=taskDeadline]").val())!=""){c=jq("#taskDeadline").datepicker("getDate");if(parseInt(jq("#taskDeadlineHours option:selected").val())!=-1){c.setHours(parseInt(jq("#taskDeadlineHours option:selected").val()))}else{c.setHours(0)}if(parseInt(jq("#taskDeadlineMinutes option:selected").val())!=-1){c.setMinutes(parseInt(jq("#taskDeadlineMinutes option:selected").val()))}else{c.setMinutes(0)}c=Teamlab.serializeTimestamp(c)}var b={id:i,title:jq("#tbxTitle").val(),description:jq("#tbxDescribe").val(),deadline:c,responsibleid:taskResponsibleSelector.SelectedUserId,categoryid:taskCategorySelector.CategoryID,isnotify:jq("#notifyResponsible").is(":checked")};if(d!=0){b.entityType=e;b.entityid=d}if(taskContactSelector.SelectedContacts.length==1){b.contactid=taskContactSelector.SelectedContacts[0]}var h=true;var g=(parseInt(jq("#taskDeadlineHours option:selected").val())==-1&&parseInt(jq("#taskDeadlineMinutes option:selected").val())!=-1)||(parseInt(jq("#taskDeadlineHours option:selected").val())!=-1&&parseInt(jq("#taskDeadlineMinutes option:selected").val())==-1);if(jq.trim(jq("#tbxTitle").val())==""){AddRequiredErrorText(jq("#tbxTitle"),CRMJSResources.EmptyTaskTitle);ShowRequiredError(jq("#tbxTitle"),true);h=false}else{RemoveRequiredErrorClass(jq("#tbxTitle"))}if(b.responsibleid==null){AddRequiredErrorText(jq("#addTaskPanel #inputUserName"),CRMJSResources.EmptyTaskResponsible);ShowRequiredError(jq("#addTaskPanel #inputUserName"),true);h=false}else{RemoveRequiredErrorClass(jq("#addTaskPanel #inputUserName"))}if(b.deadline==null||g){AddRequiredErrorText(jq("#taskDeadline"),CRMJSResources.EmptyTaskDeadline);ShowRequiredError(jq("#taskDeadline"),true);if(g){jq("#taskDeadlineHours").addClass("requiredInputError");jq("#taskDeadlineMinutes").addClass("requiredInputError")}else{jq("#taskDeadlineHours").removeClass("requiredInputError");jq("#taskDeadlineMinutes").removeClass("requiredInputError")}h=false}else{RemoveRequiredErrorClass(jq("#taskDeadline"));jq("#taskDeadlineHours").removeClass("requiredInputError");jq("#taskDeadlineMinutes").removeClass("requiredInputError")}if(!h){return false}if(i!=0){ASC.CRM.ListTaskView.AllTaskList.splice(f,1);Teamlab.updateCrmTask({},i,b,{success:ASC.CRM.TaskActionView.CallbackMethods.edit_task,before:function(j){jq("#addTaskPanel .action_block").hide();jq("#addTaskPanel .ajax_info_block").show()},after:function(j){jq("#addTaskPanel .ajax_info_block").hide();jq("#addTaskPanel .action_block").show()}})}else{Teamlab.addCrmTask({},b,{success:ASC.CRM.TaskActionView.CallbackMethods.add_task,before:function(j){jq("#addTaskPanel .action_block").hide();jq("#addTaskPanel .ajax_info_block").show()},after:function(j){jq("#addTaskPanel .ajax_info_block").hide();jq("#addTaskPanel .action_block").show()}})}},initPanel:function(f,b){if(f>0){jq("div.noMatches").hide();var c=ASC.CRM.ListTaskView.findIndexOfTaskByID(f);if(c!=-1){var e=ASC.CRM.ListTaskView.AllTaskList[c];jq("#tbxTitle").val(e.title);jq("#tbxDescribe").val(e.description);taskResponsibleSelector.ClearFilter();taskResponsibleSelector.ChangeDepartment(taskResponsibleSelector.Groups[0].ID);var d;if(!jq.browser.mobile){d=document.getElementById("User_"+e.responsible.id);if(d!=null){taskResponsibleSelector.SelectUser(d)}}else{d=jq("#taskResponsibleSelector select option[value="+e.responsible.id+"]");if(d.length>0){taskResponsibleSelector.SelectUser(d);jq(d).attr("selected",true)}}jq("#taskDeadline").datepicker("setDate",e.deadLine);if(e.deadLine.getHours()==0&&e.deadLine.getMinutes()==0){jq("#optDeadlineHours_-1").attr("selected",true);jq("#optDeadlineMinutes_-1").attr("selected",true)}else{jq("#optDeadlineHours_"+e.deadLine.getHours()).attr("selected",true);jq("#optDeadlineMinutes_"+e.deadLine.getMinutes()).attr("selected",true)}var d=taskCategorySelector.getRowByContactID(e.category.id);taskCategorySelector.changeContact(d);if(e.contact!=null){taskContactSelector.setContact(jq("#contactTitle_taskContactSelector_0"),e.contact.id,e.contact.displayName,e.contact.smallFotoUrl);taskContactSelector.showInfoContent(jq("#contactTitle_taskContactSelector_0"));taskContactSelector.SelectedContacts=[];taskContactSelector.SelectedContacts.push(e.contact.id)}else{taskContactSelector.showSelectorContent(jq("#contactTitle_taskContactSelector_0"));taskContactSelector.crossButtonEventClick("taskContactSelector_0");taskContactSelector.SelectedContacts=[]}jq("#addTaskPanel a.baseLinkButton:first").html(CRMJSResources.SaveChanges);jq("#addTaskPanel div.containerHeaderBlock td:first").html(CRMJSResources.EditTask)}return c}else{jq("#addTaskPanel a.baseLinkButton:first").html(CRMJSResources.AddThisTask);jq("#addTaskPanel div.containerHeaderBlock td:first").html(CRMJSResources.AddNewTask);jq("#tbxTitle").val("");jq("#tbxDescribe").val("");taskResponsibleSelector.ClearFilter();taskResponsibleSelector.ChangeDepartment(taskResponsibleSelector.Groups[0].ID);var d;if(!jq.browser.mobile){d=document.getElementById("User_"+ASC.CRM.TaskActionView.CurrentAccountID);if(d!=null){taskResponsibleSelector.SelectUser(d)}}else{d=jq("#taskResponsibleSelector select option[value="+ASC.CRM.TaskActionView.CurrentAccountID+"]");if(d.length>0){taskResponsibleSelector.SelectUser(d);jq(d).attr("selected",true)}}jq("#taskDeadline").datepicker("setDate",new Date());a(0);jq("#optDeadlineHours_-1").attr("selected",true);jq("#optDeadlineMinutes_-1").attr("selected",true);var d=taskCategorySelector.getRowByContactID(0);taskCategorySelector.changeContact(d);if(b!=0&&contactForInitTaskActionPanel){jq("#contactTitle_taskContactSelector_0").removeClass("crm-watermarked");taskContactSelector.setContact(jq("#contactTitle_taskContactSelector_0"),contactForInitTaskActionPanel.id,contactForInitTaskActionPanel.displayName,contactForInitTaskActionPanel.smallFotoUrl);taskContactSelector.showInfoContent(jq("#contactTitle_taskContactSelector_0"))}else{taskContactSelector.changeContact("taskContactSelector_0");taskContactSelector.crossButtonEventClick("taskContactSelector_0")}return -1}},changeTime:function(c){var b=jq(c).attr("id");var d=jq("#"+b+" option:selected").val();if(d=="-1"){jq("#optDeadlineHours_-1").attr("selected","selected");jq("#optDeadlineMinutes_-1").attr("selected","selected")}}}};jq(document).ready(function(){jq.dropdownToggle({switcherSelector:".noContentBlock .hintCategories",dropdownID:"files_hintCategoriesPanel",fixWinSize:false})});